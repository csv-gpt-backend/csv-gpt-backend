<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Buscador de calificaciones</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    body { margin: 0; padding: 16px; background: #fff; color: #111; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 12px; }
    input, select, button { padding: 10px 12px; font-size: 14px; border: 1px solid #ddd; border-radius: 8px; }
    button { background: #2563eb; color:#fff; border:none; cursor:pointer; }
    button:disabled { opacity: .6; cursor: default; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; font-size: 14px; }
    th, td { border: 1px solid #eee; padding: 8px 10px; text-align: left; }
    th { background: #f8fafc; }
    .muted { color:#666; font-size:13px; margin-top:8px; }
    .error { color:#b91c1c; white-space:pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
  </style>
</head>
<body>
  <div class="row">
    <input id="alumno" placeholder="Nombre del alumno (ej: Julia)" />
    <input id="campos" placeholder="AUTOESTIMA,EMPATIA (opcional)" />
    <select id="fuente">
      <option value="Ambos" selected>Ambos</option>
      <option value="A">A</option>
      <option value="B">B</option>
    </select>
    <button id="buscar">Buscar</button>
  </div>

  <div id="estado" class="muted"></div>
  <div id="err" class="error"></div>

  <table id="tabla" hidden>
    <thead>
      <tr>
        <th>Campo</th>
        <th>Alumno</th>
        <th>Prom. A</th>
        <th>Prom. B</th>
        <th>Prom. Total</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
const $ = sel => document.querySelector(sel);
const fmt = v => (v==null || isNaN(Number(v))) ? "" : Number(v).toFixed(2);

function getParams() {
  const u = new URL(location.href);
  return {
    alumno: (u.searchParams.get("alumno") || "").trim(),
    campos: (u.searchParams.get("campos") || "").trim(),
    fuente: (u.searchParams.get("fuente") || "Ambos").trim(),
  };
}

async function run(alumno, campos, fuente) {
  $("#err").textContent = "";
  $("#estado").textContent = "Consultando…";
  $("#tabla").hidden = true;
  $("#buscar").disabled = true;

  try {
    // OJO: ruta relativa → mismo dominio Vercel (no hay CORS)
    const qs = new URLSearchParams({ alumno, campos, fuente, formato: "tabla" });
    const r = await fetch(`/api/ask?${qs.toString()}`, { method: "GET" });
    const txt = await r.text();
    let json;
    try { json = JSON.parse(txt); } catch { throw new Error(`Respuesta no-JSON: ${txt}`); }
    if (!r.ok || json.ok === false) throw new Error(json.error || `HTTP ${r.status}`);

    const tbody = $("#tabla tbody");
    tbody.innerHTML = "";
    (json.rows || []).forEach(row => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${row.campo}</td>
        <td>${fmt(row.alumno)}</td>
        <td>${fmt(row.grupo_A)}</td>
        <td>${fmt(row.grupo_B)}</td>
        <td>${fmt(row.grupo_total)}</td>
      `;
      tbody.appendChild(tr);
    });
    $("#estado").textContent = `OK: ${json.alumno} · n_total=${json.n_total}${json.n_A?` · n_A=${json.n_A}`:""}${json.n_B?` · n_B=${json.n_B}`:""}`;
    $("#tabla").hidden = false;
  } catch (e) {
    $("#err").textContent = String(e);
    $("#estado").textContent = "Error";
  } finally {
    $("#buscar").disabled = false;
  }
}

$("#buscar").addEventListener("click", () => {
  const alumno = $("#alumno").value.trim();
  const campos = $("#campos").value.trim();
  const fuente = $("#fuente").value || "Ambos";
  if (!alumno) { $("#err").textContent = "Falta el alumno"; return; }
  run(alumno, campos, fuente);
});

// Autocompletar desde querystring y ejecutar si viene alumno=
window.addEventListener("DOMContentLoaded", () => {
  const p = getParams();
  if (p.alumno) $("#alumno").value = p.alumno;
  if (p.campos) $("#campos").value = p.campos;
  if (p.fuente) $("#fuente").value = p.fuente;
  if (p.alumno) run(p.alumno, p.campos, p.fuente);
});
</script>
</body>
</html>
