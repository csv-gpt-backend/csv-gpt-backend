<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Evitar cacheo del HTML -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- Sello de versión -->
  <script>console.log("CSV-GPT Frontend build: 2025-09-18 10:45 (compat enviarPregunta)");</script>

  <title>Consulta Educativa</title>

  <style>
    :root { --bg:#0d1117; --panel:#161b22; --text:#e6edf3; --muted:#8b949e; --accent:#2f81f7; --card:#0f1420; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns:1fr 2fr 1fr;gap:16px}
    .card{background:var(--panel);border:1px solid #222b36;border-radius:16px;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
    .logo-box{display:flex;align-items:center;justify-content:center;height:100%}
    .logo{max-width:100%;max-height:120px;opacity:.95;filter:drop-shadow(0 6px 12px rgba(0,0,0,.35))}
    .center{display:flex;flex-direction:column;gap:12px}
    .video-wrap{display:flex;justify-content:center;align-items:center;background:linear-gradient(180deg,#0f1420 0%,#0b1020 100%);border:1px solid #1d2530;border-radius:16px;padding:12px}
    video{width:100%;max-width:736px;border-radius:12px;display:block}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .toolbar input[type="text"]{flex:1 1 600px;background:#0f1420;border:1px solid #273142;border-radius:10px;color:var(--text);padding:12px 14px;outline:none}
    .toolbar button{background:var(--accent);color:white;border:0;border-radius:10px;padding:12px 14px;font-weight:600;cursor:pointer}
    .toolbar button.secondary{background:#273142}
    .toolbar select{background:#0f1420;border:1px solid #273142;border-radius:10px;color:var(--text);padding:12px 14px}
    .answer{white-space:pre-wrap;line-height:1.4;background:var(--card);border:1px solid #1b2432;border-radius:12px;padding:12px}
    .tbl{width:100%;border-collapse:collapse;margin:10px 0;border:1px solid #283142;border-radius:8px;overflow:hidden}
    .tbl th,.tbl td{padding:8px 10px;border-bottom:1px solid #283142;text-align:left;font-size:13px}
    .tbl th{background:#131a25;font-weight:600}
    .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .badge{font-size:12px;background:#192234;border:1px solid #223049;padding:4px 8px;border-radius:999px}
    .danger{background:#3a0f16;border-color:#5a1a26}
    .pill{padding:4px 8px;border-radius:999px;border:1px solid #273142;background:#0f1420;font-size:12px}
    .big-mic{width:36px;height:36px}
    .mic-on{background:#1f6feb !important; box-shadow:0 0 0 3px rgba(47,129,247,.25) inset}

    /* Garantizar input cliqueable (sea 'pregunta' o 'q') */
    .toolbar input#pregunta,.toolbar input#q{
      pointer-events:auto!important;opacity:1!important;position:relative;z-index:3;
    }
    #respuesta,#answer,.answer{position:relative;z-index:1}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="grid">
      <div class="card logo-box">
        <img class="logo" src="left.png" alt="Logo izquierdo" />
      </div>

      <div class="center">
        <div class="card video-wrap">
          <video id="video" src="descarga.mp4" controls preload="metadata" muted></video>
        </div>

        <div class="card">
          <div class="toolbar">
            <!-- Mic/Dictado -->
            <button id="micBtn" class="secondary" title="Dictar (es-MX)">
              <svg class="big-mic" viewBox="0 0 24 24" fill="currentColor"><path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 1 0-6 0v5a3 3 0 0 0 3 3zm5-3a5 5 0 1 1-10 0H5a7 7 0 0 0 14 0h-2zM11 19v3h2v-3h-2z"/></svg>
              <span id="micLabel">Dictar</span>
            </button>

            <!-- Mantengo tu id 'pregunta' -->
            <input id="pregunta" type="text" placeholder="Haz tu pregunta aquí..." />

            <!-- Mantengo tu botón con onclick -->
            <button class="btn" onclick="enviarPregunta()">Enviar</button>

            <button id="stopVoiceBtn" class="secondary">Detener voz</button>
            <select id="exportSel">
              <option value="" selected>Exportar…</option>
              <option value="doc">Word (.doc)</option>
              <option value="odt">OpenDocument (.odt)</option>
              <option value="xls">Excel (.xls)</option>
            </select>
            <button id="clearMemBtn" class="danger">Limpiar memoria</button>
            <span class="badge" id="voiceBadge">Voz: es-MX (femenina)</span>
            <span class="pill" id="modelBadge">Modelo: gpt-5</span>
          </div>
          <div class="row" style="font-size:12px;color:#8b949e">
            <span id="status">Listo.</span><span style="flex:1"></span>
            <span>Backend: <strong>https://csv-gpt-backend.vercel.app/api/ask</strong></span>
          </div>
        </div>

        <div class="card">
          <div class="answer" id="answer">La respuesta aparecerá aquí.</div>
          <div id="tables"></div>
        </div>
      </div>

      <div class="card logo-box">
        <img class="logo" src="right.png" alt="Logo derecho" />
      </div>
    </div>
  </div>

<script>
/* === CONFIG === */
const API_BASE = location.origin;          // mismo dominio
const DEFAULT_FILE = "decimo.csv";         // tu CSV por defecto
const PREFERRED_MODEL = "gpt-5";           // siempre inicia por GPT-5
const SESSION_TTL_MS = 10*60*1000;         // sesión mínimo 10 min

/* === REFS (tolerante a ids) === */
const $q      = document.querySelector('#pregunta, #q, .toolbar input[type="text"]');
const $out    = document.querySelector('#respuesta, #answer, .answer') || (()=>{const d=document.createElement('div'); d.id='respuesta'; document.body.appendChild(d); return d;})();
const $video  = document.getElementById('video');
const $status = document.getElementById('status') || { textContent: '' };

/* endurecer el input (por si quedó bloqueado) */
if ($q) { $q.removeAttribute('disabled'); $q.disabled=false; $q.readOnly=false; $q.style.pointerEvents='auto'; $q.style.opacity='1'; }

/* === SESIÓN / CONTEXTO 10min === */
function newSessionId(){ return 'sess_'+Math.random().toString(36).slice(2)+'_'+Date.now(); }
function getSession(){
  const s = JSON.parse(localStorage.getItem('session')||'{}'); const now=Date.now();
  if (!s.id || (now - (s.last||0)) > SESSION_TTL_MS) { const n={id:newSessionId(), last:now, hist:[]}; localStorage.setItem('session',JSON.stringify(n)); return n; }
  return s;
}
function touch(){ const s=getSession(); s.last=Date.now(); localStorage.setItem('session',JSON.stringify(s)); }
function push(role, text){ const s=getSession(); s.hist = (s.hist||[]); s.hist.push({role,text,t:Date.now()}); if(s.hist.length>16) s.hist.shift(); localStorage.setItem('session',JSON.stringify(s)); }
function context(){ const s=getSession(); const last=(s.hist||[]).slice(-12); return last.map(h=>`${h.role==='user'?'Usuario':'Asistente'}: ${h.text}`).join('\n').slice(-1500); }

/* === VOZ FEMENINA es-MX + VIDEO === */
const FEMALE_HINTS = ["Dalia","Larissa","Elena","Lucia","Helena","Camila","Mia","Paloma","Valentina","Female","Femenina","Mujer","A","C"];
const MALE_NEG     = ["Male","Masculina","Hombre","Diego","Jorge","Juan","Miguel","Javier","Manuel","B","D"];
let FIXED_VOICE=null, guard=null;

function pickVoice(){
  const vs = speechSynthesis.getVoices()||[];
  if (!vs.length) return;
  const score = v => {
    let s=0; const L=(v.lang||'').toLowerCase(), N=(v.name||'').toLowerCase();
    if (L==='es-mx') s+=120; else if (L.startsWith('es-')) s+=60;
    if (FEMALE_HINTS.some(k=>N.includes(k.toLowerCase()))) s+=80;
    if (MALE_NEG.some(k=>N.includes(k.toLowerCase()))) s-=120;
    return s;
  };
  FIXED_VOICE = [...vs].sort((a,b)=>score(b)-score(a))[0] || null;
}
speechSynthesis.onvoiceschanged = pickVoice; pickVoice();

function cleanTTS(t){
  return (t||"")
    .replace(/```[\s\S]*?```/g," ")
    .replace(/\*\*/g,"").replace(/\*/g,"")
    .replace(/^[\s•\-–·]\s*/gm,"").replace(/\s{2,}/g," ").trim();
}
function speak(text){
  if (!text) return;
  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(cleanTTS(text));
  u.lang='es-MX'; u.rate=1.0; u.pitch=1.05; u.volume=1.0; if (FIXED_VOICE) u.voice=FIXED_VOICE;
  u.onstart=()=>{ try{$video && $video.play();}catch{}; clearInterval(guard); guard=setInterval(()=>{ if ($video && $video.paused && speechSynthesis.speaking) try{$video.play();}catch{}; },500); $status.textContent="Hablando…"; };
  u.onend  =()=>{ clearInterval(guard); if ($video) try{$video.pause();}catch{}; $status.textContent="Listo."; };
  u.onerror=()=>{ clearInterval(guard); if ($video) try{$video.pause();}catch{}; $status.textContent="Error al hablar."; };
  speechSynthesis.speak(u);
}

/* === RENDER RESPUESTA + TABLAS (si las hay) === */
const $tables = document.getElementById('tables') || (()=>{const d=document.createElement('div'); d.id='tables'; $out.parentNode.insertBefore(d,$out.nextSibling); return d;})();
function clearTables(){ $tables.innerHTML=''; }
function renderMarkdownTable(md){
  const lines=md.trim().split(/\r?\n/); if(lines.length<2||!/\|/.test(lines[0])||!/^(\s*\|)?\s*:?-{3,}/.test(lines[1])) return false;
  const parse=r=>r.split("|").map(c=>c.trim()); const headRaw=parse(lines[0]).filter(Boolean); const head=["#",...headRaw];
  const tbl=document.createElement('table'); tbl.style.width='100%'; tbl.style.borderCollapse='collapse'; tbl.style.margin='10px 0';
  const thd=document.createElement('thead'); const trh=document.createElement('tr'); head.forEach(h=>{const th=document.createElement('th'); th.textContent=h; th.style.borderBottom='1px solid #283142'; th.style.textAlign='left'; th.style.padding='6px 8px'; trh.appendChild(th);}); thd.appendChild(trh); tbl.appendChild(thd);
  const tbd=document.createElement('tbody'); let n=1;
  lines.slice(2).forEach(l=>{ if(!l.trim())return; const cols=parse(l); const tr=document.createElement('tr'); const tdN=document.createElement('td'); tdN.textContent=n++; tdN.style.padding='6px 8px'; tdN.style.borderBottom='1px solid #283142'; tr.appendChild(tdN);
    headRaw.forEach((_,i)=>{const td=document.createElement('td'); td.textContent=cols[i]??""; td.style.padding='6px 8px'; td.style.borderBottom='1px solid #283142'; tr.appendChild(td);}); tbd.appendChild(tr); });
  tbl.appendChild(tbd); $tables.appendChild(tbl); return true;
}
function stripTables(text){
  let out = (text||"").replace(/```[\s\S]*?```/g," ").trim();
  out = out.replace(/(^\|.+\|\s*\r?\n\|?\s*:?-{3,}.*\r?\n(?:.*\r?\n?)*)/gm," ").trim();
  return out;
}
function autoTables(text){
  clearTables();
  const md = text.match(/(^\|.+\|\s*\r?\n\|?\s*:?-{3,}.*\r?\n(?:.*\r?\n?)*)/m);
  if (md) renderMarkdownTable(md[1]);
}

/* === LLAMADA AL BACKEND === */
async function ask(query){
  const s=getSession(); touch();
  const ctx=context(); const composed = ctx ? `Contexto reciente:\n${ctx}\n\nPregunta:\n${query}` : query;
  const url = `${API_BASE}/api/ask?q=${encodeURIComponent(composed)}&file=${encodeURIComponent(DEFAULT_FILE)}&model=${encodeURIComponent(PREFERRED_MODEL)}&session=${encodeURIComponent(s.id)}`;
  $status.textContent = "Consultando…";
  try{
    const r = await fetch(url); const data = await r.json();
    const raw = data.answer || data.text || JSON.stringify(data, null, 2);
    autoTables(raw);
    const soloTexto = stripTables(raw);
    $out.textContent = soloTexto;       // muestra explicación / reglas / fórmulas sin duplicar
    speak(soloTexto);                   // voz estrictamente femenina es-MX
    push('user', query); push('assistant', soloTexto);
    $status.textContent = "Listo.";
  }catch(e){
    console.error(e); $out.textContent = "Error consultando el backend."; $status.textContent="Error.";
  }
}

/* === CONECTAR EL BOTÓN "Enviar" (tu HTML usa onclick="enviarPregunta()") === */
window.enviarPregunta = function(){
  if (!$q || !$q.value.trim()) { $q && $q.focus(); return; }
  ask($q.value.trim());
};

/* Enter para enviar */
$q && $q.addEventListener('keydown', e => { if (e.key === 'Enter') window.enviarPregunta(); });

console.log('frontend listo');
</script>
  <!-- ===== Versión / Sello ===== -->
<script>
  console.log("CSV-GPT Frontend build: 2025-09-18 11:59 (frontend-ok2)");
</script>

<!-- ===== Script principal (con voz es-MX + video + tablas + sesión 10min) ===== -->
<script>
/* === CONFIG === */
const API_BASE = location.origin;
const DEFAULT_FILE = "decimo.csv";
const PREFERRED_MODEL = "gpt-5";
const SESSION_TTL_MS = 10*60*1000;

/* === REFS === */
const $q      = document.querySelector('#pregunta, #q, .toolbar input[type="text"]');
const $out    = document.querySelector('#respuesta, #answer, .answer') || (()=>{const d=document.createElement('div'); d.id='respuesta'; document.body.appendChild(d); return d;})();
const $video  = document.getElementById('video');
const $status = document.getElementById('status') || { textContent: '' };
const $tables = document.getElementById('tables') || (()=>{const d=document.createElement('div'); d.id='tables'; $out.parentNode.insertBefore(d,$out.nextSibling); return d;})();

/* endurecer input */
if ($q) { $q.removeAttribute('disabled'); $q.disabled=false; $q.readOnly=false; $q.style.pointerEvents='auto'; $q.style.opacity='1'; }

/* === SESIÓN === */
function newSessionId(){ return 'sess_'+Math.random().toString(36).slice(2)+'_'+Date.now(); }
function getSession(){ const s=JSON.parse(localStorage.getItem('session')||'{}'); const now=Date.now();
  if(!s.id || (now-(s.last||0))>SESSION_TTL_MS){ const n={id:newSessionId(),last:now,hist:[]}; localStorage.setItem('session',JSON.stringify(n)); return n; }
  return s;
}
function touch(){ const s=getSession(); s.last=Date.now(); localStorage.setItem('session',JSON.stringify(s)); }
function push(role,text){ const s=getSession(); s.hist=s.hist||[]; s.hist.push({role,text,t:Date.now()}); if(s.hist.length>16)s.hist.shift(); localStorage.setItem('session',JSON.stringify(s)); }
function context(){ const s=getSession(); const last=(s.hist||[]).slice(-12); return last.map(h=>`${h.role==='user'?'Usuario':'Asistente'}: ${h.text}`).join('\n').slice(-1500); }

/* === VOZ FEMENINA es-MX + VIDEO === */
const FEMALE_HINTS=["Dalia","Larissa","Elena","Lucia","Helena","Camila","Mia","Paloma","Valentina","Female","Femenina","Mujer","A","C"];
const MALE_NEG=["Male","Masculina","Hombre","Diego","Jorge","Juan","Miguel","Javier","Manuel","B","D"];
let FIXED_VOICE=null, guard=null;
function pickVoice(){ const vs=speechSynthesis.getVoices()||[]; if(!vs.length)return;
  const score=v=>{let s=0; const L=(v.lang||'').toLowerCase(),N=(v.name||'').toLowerCase();
    if(L==='es-mx')s+=120; else if(L.startsWith('es-'))s+=60; if(FEMALE_HINTS.some(k=>N.includes(k.toLowerCase())))s+=80; if(MALE_NEG.some(k=>N.includes(k.toLowerCase())))s-=120; return s;};
  FIXED_VOICE=[...vs].sort((a,b)=>score(b)-score(a))[0]||null;
}
speechSynthesis.onvoiceschanged=pickVoice; pickVoice();
function cleanTTS(t){return (t||"").replace(/```[\s\S]*?```/g," ").replace(/\*\*/g,"").replace(/\*/g,"").replace(/^[\s•\-–·]\s*/gm,"").replace(/\s{2,}/g," ").trim();}
function speak(text){
  if(!text)return; speechSynthesis.cancel(); const u=new SpeechSynthesisUtterance(cleanTTS(text));
  u.lang='es-MX'; u.rate=1.0; u.pitch=1.05; u.volume=1.0; if(FIXED_VOICE)u.voice=FIXED_VOICE;
  u.onstart=()=>{ try{$video&&$video.play();}catch{}; clearInterval(guard); guard=setInterval(()=>{ if($video&&speechSynthesis.speaking&&$video.paused)try{$video.play();}catch{} },500); $status.textContent='Hablando…'; };
  u.onend=()=>{ clearInterval(guard); try{$video&&$video.pause();}catch{}; $status.textContent='Listo.'; };
  u.onerror=()=>{ clearInterval(guard); try{$video&&$video.pause();}catch{}; $status.textContent='Error al hablar.'; };
  speechSynthesis.speak(u);
}

/* === TABLAS === */
function clearTables(){ $tables.innerHTML=''; }
function renderMarkdownTable(md){
  const lines=md.trim().split(/\r?\n/); if(lines.length<2||!/\|/.test(lines[0])||!/^(\s*\|)?\s*:?-{3,}/.test(lines[1])) return false;
  const parse=r=>r.split("|").map(c=>c.trim()); const headRaw=parse(lines[0]).filter(Boolean); const head=['#',...headRaw];
  const tbl=document.createElement('table'); tbl.style.width='100%'; tbl.style.borderCollapse='collapse'; tbl.style.margin='10px 0';
  const thd=document.createElement('thead'); const trh=document.createElement('tr'); head.forEach(h=>{const th=document.createElement('th'); th.textContent=h; th.style.borderBottom='1px solid #283142'; th.style.textAlign='left'; th.style.padding='6px 8px'; trh.appendChild(th);}); thd.appendChild(trh); tbl.appendChild(thd);
  const tbd=document.createElement('tbody'); let n=1;
  lines.slice(2).forEach(l=>{ if(!l.trim())return; const cols=parse(l); const tr=document.createElement('tr');
    const tdN=document.createElement('td'); tdN.textContent=n++; tdN.style.padding='6px 8px'; tdN.style.borderBottom='1px solid #283142'; tr.appendChild(tdN);
    headRaw.forEach((_,i)=>{const td=document.createElement('td'); td.textContent=cols[i]??""; td.style.padding='6px 8px'; td.style.borderBottom='1px solid #283142'; tr.appendChild(td);});
    tbd.appendChild(tr);
  }); tbl.appendChild(tbd); $tables.appendChild(tbl); return true;
}
function stripTables(text){ let out=(text||"").replace(/```[\s\S]*?```/g," ").trim(); out=out.replace(/(^\|.+\|\s*\r?\n\|?\s*:?-{3,}.*\r?\n(?:.*\r?\n?)*)/gm," ").trim(); return out; }
function autoTables(text){ clearTables(); const md=text.match(/(^\|.+\|\s*\r?\n\|?\s*:?-{3,}.*\r?\n(?:.*\r?\n?)*)/m); if(md) renderMarkdownTable(md[1]); }

/* === BACKEND === */
async function ask(query){
  const s=getSession(); touch();
  const ctx=context(); const composed=ctx?`Contexto reciente:\n${ctx}\n\nPregunta:\n${query}`:query;
  const url=`${API_BASE}/api/ask?q=${encodeURIComponent(composed)}&file=${encodeURIComponent(DEFAULT_FILE)}&model=${encodeURIComponent(PREFERRED_MODEL)}&session=${encodeURIComponent(s.id)}`;
  try{
    const r=await fetch(url); const data=await r.json(); const raw=data.answer||data.text||JSON.stringify(data,null,2);
    autoTables(raw); const texto=stripTables(raw); $out.textContent=texto; speak(texto); push('user',query); push('assistant',texto);
  }catch(e){ console.error(e); $out.textContent='Error consultando el backend.'; }
}

/* === BOTÓN ENVIAR (compat con onclick="enviarPregunta()") === */
window.enviarPregunta=function(){ if(!$q||!$q.value.trim()){ $q&&$q.focus(); return; } ask($q.value.trim()); };
$q && $q.addEventListener('keydown',e=>{ if(e.key==='Enter') window.enviarPregunta(); });

console.log('frontend listo ✅');
</script>

</body>
</html>
