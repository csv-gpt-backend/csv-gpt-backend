<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Consulta Educativa</title>
  <style>
    :root{
      --header-height: 240px;
      --video-shift: 14px;
      --accent:#0078d7;
    }
    *{ box-sizing:border-box; } body{ margin:0; background:#fff; font-family:Arial,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,sans-serif; color:#111; }
    .header-rail{ display:flex; align-items:center; justify-content:center; width:100%; height:var(--header-height); background:#fff; overflow:hidden; }
    .header-rail .col{ display:flex; justify-content:center; align-items:center; height:100%; overflow:hidden; padding:0 8px; }
    .header-rail .left,.header-rail .right{ flex:0 0 25%; }
    .header-rail .center{ flex:0 0 50%; position:relative; }
    .header-rail .col img{ max-height:100%; max-width:100%; height:auto; width:auto; object-fit:contain; display:block; }
    .header-rail video{ max-height:100%; max-width:100%; height:115%; width:auto; object-fit:contain; display:block; transform: translateY(var(--video-shift)); }
    .interaction{ padding:24px 16px; text-align:center; }
    .bar{ display:flex; gap:8px; justify-content:center; align-items:center; max-width:1100px; margin:0 auto; flex-wrap:wrap; }
    .bar input[type="text"]{ flex:1 1 800px; padding:12px 14px; font-size:16px; border:1px solid #d0d0d0; border-radius:8px; outline:none; }
    .btn{ padding:12px 16px; border:0; border-radius:8px; background:var(--accent); color:#fff; font-weight:600; cursor:pointer; }
    .btn:hover{ filter:brightness(0.95); }
    #respuesta{ margin:20px auto 0; width:min(95%,1100px); min-height:64px; padding:14px; background:#f7f7f8; border:1px solid #e5e5e7; border-radius:10px; text-align:left; line-height:1.45; white-space:pre-wrap; }
    .table-wrap{ width:min(95%,1100px); margin:16px auto; overflow:auto; border:1px solid #e5e5e7; border-radius:10px; background:#fff; }
    table.data{ width:100%; border-collapse:collapse; font-size:14px; }
    table.data thead th{ position:sticky; top:0; background:#f3f5f7; border-bottom:1px solid #dee1e6; text-align:left; padding:10px 8px; font-weight:700; white-space:nowrap; }
    table.data tbody td{ border-top:1px solid #f0f2f5; padding:8px 8px; vertical-align:top; } table.data tbody tr:nth-child(odd){ background:#fafbfc; }
    .toolbar{ display:flex; gap:10px; justify-content:center; align-items:center; margin:16px auto 28px; }
    .muted{ color:#666; font-size:13px; }
    @media (max-width: 640px){ .header-rail{ --header-height:200px; } .header-rail video{ transform: translateY(8px); } }
  </style>
</head>
<body>

  <div class="header-rail">
    <div class="col left"><img src="/left.png" alt="Imagen izquierda"></div>
    <div class="col center">
      <video id="video" muted playsinline preload="metadata">
        <source src="https://xsmr71ubix2w6tve.public.blob.vercel-storage.com/OLIVIA%20IN%20CASUAL.mp4" type="video/mp4">
        Tu navegador no soporta video.
      </video>
    </div>
    <div class="col right"><img src="/right.png" alt="Imagen derecha"></div>
  </div>

  <div class="interaction">
    <div class="bar">
      <input id="pregunta" type="text" placeholder="Escribe tu pregunta (p. ej. 'Grupos homog√©neos de 5 con Agresi√≥n y Empat√≠a...')" />
      <button class="btn" onclick="enviar()">Enviar</button>
      <button class="btn" id="btn-voz" onclick="startListening()">üé§ Voz</button>
    </div>
    <div id="respuesta">Aqu√≠ aparecer√° la explicaci√≥n...</div>

    <!-- contenedor din√°mico -->
    <div id="contenedor"></div>

    <div class="toolbar">
      <select id="export-kind">
        <option value="pdf">Exportar PDF</option>
        <option value="doc">Exportar Word</option>
        <option value="csv">Exportar CSV</option>
      </select>
      <button class="btn" onclick="exportar()">Exportar</button>
      <button class="btn" onclick="stopVoice()">Detener voz</button>
      <button class="btn" onclick="limpiar()">Limpiar</button>
      <button class="btn" onclick="borrarMemoria()">Borrar memoria</button>
    </div>
    <div class="muted">La memoria se conserva por ~10 minutos para dar contexto entre preguntas.</div>
  </div>

<script>
const ENDPOINT = "/api/ask";
const tablaBox = document.getElementById("contenedor");
const out = document.getElementById("respuesta");
const video = document.getElementById("video");

// --------- memoria de 10 min ---------
const mem = {
  key: "ctx_mem",
  get(){ try{ const x = JSON.parse(localStorage.getItem(this.key)||"null"); if(!x) return null; if(Date.now()-x.ts > 10*60*1000) return null; return x.q || null;}catch{ return null; } },
  set(q){ localStorage.setItem(this.key, JSON.stringify({ q, ts: Date.now() })); },
  clear(){ localStorage.removeItem(this.key); }
};

// ---------- VOZ ----------
let chosenVoice = null;
const EXEC_PREF = ["sabina","dalia","beatriz","abril","camila","lucia"];
const FEMALE_HINTS = ["female","mujer","femenina","sabina","dalia","beatriz","abril","camila","lucia","paola","valentina"];
const MALE_HINTS = ["male","hombre","jorge","liberto","pablo","diego","miguel","enrique","hugo","carlos"];

function scoreVoice(v){
  const name = (v.name||"").toLowerCase();
  const lang = (v.lang||"").toLowerCase();
  let s = 0;
  if (lang.startsWith("es-mx")) s += 100;
  else if (lang.startsWith("es-419")) s += 60;
  else if (lang.startsWith("es")) s += 30;
  if (EXEC_PREF.some(t => name.includes(t))) s += 40;
  if (FEMALE_HINTS.some(t => name.includes(t))) s += 20;
  if (/(neural|natural|online)/i.test(name)) s += 25;
  if (MALE_HINTS.some(t => name.includes(t))) s -= 80;
  return s;
}
function pickExecutiveSpanishFemale(){
  const voices = window.speechSynthesis?.getVoices?.() || [];
  if (!voices.length) return null;
  return voices.slice().sort((a,b) => scoreVoice(b) - scoreVoice(a))[0] || voices[0];
}
function ensureVoiceSelected(){ if (!chosenVoice) chosenVoice = pickExecutiveSpanishFemale(); }
function speak(text, onStart, onEnd){
  if(!window.speechSynthesis){ onStart&&onStart(); onEnd&&onEnd(); return; }
  ensureVoiceSelected();
  const u = new SpeechSynthesisUtterance(
    String(text||"").replace(/\*/g,"") // no leer asteriscos
  );
  if (chosenVoice) u.voice = chosenVoice;
  u.lang = chosenVoice?.lang?.startsWith("es") ? chosenVoice.lang : "es-MX";
  u.rate = 1.12; u.pitch = 1.02; u.volume = 1.0;
  u.onstart = ()=> onStart && onStart();
  u.onend   = ()=> onEnd && onEnd();
  u.onerror = ()=> onEnd && onEnd();
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(u);
}
window.speechSynthesis.onvoiceschanged = () => { chosenVoice = null; ensureVoiceSelected(); };
function stopVoice(){ try{ window.speechSynthesis.cancel(); }catch{} }

// -------- limpieza de tablas ascii que a veces mete la IA en la teor√≠a --------
function stripAsciiTables(text){
  if(!text) return "";
  const lines = text.split(/\r?\n/);
  const out = [];
  let sk=false;
  for(const l of lines){
    const isPipe = /^\s*\|.*\|\s*$/.test(l);
    const isSep  = /^\s*\|?\s*:?-{2,}:?\s*(\|\s*:?-{2,}:?\s*)+\|?\s*$/.test(l);
    if (isPipe || isSep) { sk=true; continue; }
    if (sk && l.trim()===""){ sk=false; continue; }
    if (!sk) out.push(l);
  }
  return out.join("\n").replace(/\[Nombre\s*\d+\]/gi,"").replace(/\[Puntaje\]/gi,"").trim();
}

// -------- UI --------
function limpiar(){ out.textContent=""; tablaBox.innerHTML=""; }
function borrarMemoria(){ mem.clear(); alert("Memoria borrada."); }

async function enviar(){
  const q = document.getElementById("pregunta").value.trim();
  if (!q) return alert("Escribe una pregunta.");
  out.textContent = "Procesando‚Ä¶";
  tablaBox.innerHTML = "";

  try{
    const url = `${ENDPOINT}?q=${encodeURIComponent(q)}&file=${encodeURIComponent("decimo.csv")}`;
    const r = await fetch(url);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const data = await r.json();

    render(data);
    mem.set(q);
  }catch(e){
    out.textContent = "No se pudo contactar al servidor.";
    console.error(e);
  }
}

function render(data){
  // explicaci√≥n limpia
  const nota = stripAsciiTables(data.nota || "");
  out.textContent = nota || "(Sin explicaci√≥n)";

  if (data.mode === "cluster"){
    // grupos
    (data.grupos || []).forEach(g => {
      const wrap = document.createElement("div");
      wrap.className = "table-wrap";
      const h = document.createElement("div");
      h.style.padding="10px 12px"; h.style.fontWeight="700";
      h.textContent = g.titulo;
      wrap.appendChild(h);
      wrap.appendChild(renderTable(g.rows));
      tablaBox.appendChild(wrap);
    });
    // pares
    const pairsTitle = document.createElement("div");
    pairsTitle.style.margin="18px auto 8px"; pairsTitle.style.maxWidth="1100px";
    pairsTitle.style.fontWeight="700";
    pairsTitle.textContent = "Top 5 pares m√°s compatibles (global):";
    tablaBox.appendChild(pairsTitle);

    const pairsTable = renderTable((data.topPairs||[]).map((p,i)=>({ "#": i+1, "Estudiante A": p.A, "Estudiante B": p.B, "dist_z": p.dist_z })));
    const wrapP = document.createElement("div"); wrapP.className="table-wrap"; wrapP.appendChild(pairsTable);
    tablaBox.appendChild(wrapP);

    const withinTitle = document.createElement("div");
    withinTitle.style.margin="18px auto 8px"; withinTitle.style.maxWidth="1100px";
    withinTitle.style.fontWeight="700";
    withinTitle.textContent = "Par m√°s compatible dentro de cada grupo:";
    tablaBox.appendChild(withinTitle);

    const withinTable = renderTable((data.pairsWithin||[]).map(p=>({ "Grupo": p?.grupo, "Estudiante A": p?.A, "Estudiante B": p?.B, "dist_z": p?.dist_z })));
    const wrapW = document.createElement("div"); wrapW.className="table-wrap"; wrapW.appendChild(withinTable);
    tablaBox.appendChild(wrapW);

    // voz + video
    speak(nota, ()=>video?.play(), ()=>video?.pause());
    return;
  }

  // modos informativos simples
  if (data.mode === "corr-info" || data.mode === "table-info"){
    speak(nota, ()=>video?.play(), ()=>video?.pause());
    return;
  }
}

function renderTable(rows){
  if (!rows || !rows.length) {
    const d = document.createElement("div");
    d.style.padding="10px 12px"; d.textContent="(Sin filas)";
    return d;
  }
  const headers = Object.keys(rows[0]);
  const t = document.createElement("table");
  t.className = "data";
  const thead = document.createElement("thead");
  const trh = document.createElement("tr");
  headers.forEach(h=>{
    const th = document.createElement("th");
    th.textContent = h; trh.appendChild(th);
  });
  thead.appendChild(trh); t.appendChild(thead);
  const tb = document.createElement("tbody");
  rows.forEach(r=>{
    const tr = document.createElement("tr");
    headers.forEach(h=>{
      const td = document.createElement("td"); td.textContent = r[h]==null?"":r[h]; tr.appendChild(td);
    });
    tb.appendChild(tr);
  });
  t.appendChild(tb);
  return t;
}

// ---- mic ----
function startListening(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){ alert("Tu navegador no soporta reconocimiento de voz."); return; }
  const rec = new SR(); rec.lang = "es-MX"; rec.interimResults = false; rec.maxAlternatives = 1;
  rec.onresult = e => { const t = e.results[0][0].transcript; document.getElementById("pregunta").value = t; enviar(); };
  rec.onerror = e => { alert("Error de micr√≥fono: " + e.error + "\nPermite el micr√≥fono para este sitio desde el candado del navegador."); };
  rec.start();
}

// ---- export (simple) ----
function exportar(){
  const kind = document.getElementById("export-kind").value;
  const blob = new Blob([document.documentElement.outerHTML], {type: kind==="pdf"?"text/html":"text/html"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = kind==="pdf" ? "reporte.html" : (kind==="doc" ? "reporte.doc" : "reporte.html");
  a.click(); URL.revokeObjectURL(url);
}
</script>
</body>
</html>
