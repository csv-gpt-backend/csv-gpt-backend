<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Consulta Educativa Lexium</title>
<style>
:root{ --h:360px; --accent:#0078d7 }
*{ box-sizing:border-box }
body{ margin:0; font-family:Arial,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,sans-serif }
.header{ display:flex; height:var(--h); align-items:center; justify-content:center; gap:12px; padding:8px }
.header .col{ flex:0 0 25%; display:flex; align-items:center; justify-content:center }
.header .mid{ flex:0 0 50% }
.header img{ max-height:100%; max-width:100%; object-fit:contain }
.header video{ height:100%; max-width:100%; object-fit:contain; display:block }
.main{ padding:18px 12px; text-align:center }
.bar{ display:flex; gap:8px; justify-content:center; align-items:center; max-width:1100px; margin:0 auto }
textarea{ flex:1 1 800px; min-height:72px; padding:12px 14px; border:1px solid #d0d0d0; border-radius:8px; font-size:16px; resize:vertical }
.btn{ padding:12px 16px; border:0; border-radius:8px; background:var(--accent); color:#fff; font-weight:600; cursor:pointer }
.btn.alt{ background:#eee; color:#111 }
#out{ width:min(90%,1100px); margin:16px auto 0; padding:14px; background:#f7f7f8; border:1px solid #e5e5e7; border-radius:10px; text-align:left; white-space:pre-wrap }
.badge{ position:fixed; right:8px; bottom:8px; background:#111; color:#fff; padding:6px 10px; border-radius:8px; font:12px monospace; z-index:9999 }

  

</style>
</head>
<body>
<div id="build" class="badge">APP v=?</div>

<div class="header">
  <div class="col"><img src="/left.png" alt="L"></div>
  <div class="mid">
    <video id="vid" muted playsinline preload="metadata">
      <source src="https://xsmr71ubix2w6tve.public.blob.vercel-storage.com/OLIVIA%20IN%20CASUAL.mp4" type="video/mp4">
    </video>
  </div>
  <div class="col"><img src="/right.png" alt="R"></div>
</div>
  /* =============inicio===Marce2====*/
<div class="bar">
  <!-- Caja de texto para la pregunta (3 l√≠neas) -->
  <textarea id="pregunta" rows="3" placeholder="Haz tu pregunta aqu√≠‚Ä¶" 
           style="flex:1 1 800px; padding:12px 14px; font-size:16px; 
                  border:1px solid #d0d0d0; border-radius:8px; outline:none;"></textarea>

  <!-- Bot√≥n Enviar -->
  <button class="btn" onclick="enviarPregunta()">Enviar</button>
<script src="https://unpkg.com/docx@8.5.0/build/index.umd.js"></script>

  <!-- Bot√≥n Micr√≥fono (grande y visible) -->
  <button class="btn mic" title="Dictar por voz" onclick="startListening()">üé§</button>

  
  
  /* =========inicio =2=====*/
  <!-- Selector de exportaci√≥n -->
  <<select id="exportType" class="select">
  <option value="pdf">PDF (vista previa)</option>
  <option value="csv">CSV (descarga)</option>
  <option value="docx">DOCX (Word)</option>
</select>
    
<!  ====== fin mar2 ====>
  <!-- Bot√≥n Exportar -->
  <button class="btn" onclick="exportSeleccion()">Exportar</button>

  <!-- Bot√≥n Liberar memoria (opcional) -->
  <button class="btn alt" onclick="liberarMemoria()">Liberar memoria</button>
</div>

  /* ================fin =botones========Marce4====*/

  <script>

/* ===========inicio   Marce 1======*/
  /* Bot√≥n de micr√≥fono m√°s grande */

  .btn.mic {
  font-size: 22px;
  padding: 14px 16px;
  line-height: 1;
}

/* Selector con estilo similar a los botones */
.select {
  padding: 10px 12px;
  border: 1px solid #d0d0d0;
  border-radius: 8px;
  font-size: 15px;
  background: #fff;
}

/* Bot√≥n alternativo para limpiar memoria */
.btn.alt {
  background: #ffc107;
  color: #000;
}
/* ============== fin marce1 ==========*/
    
/* ===== Build visual ===== */
const APP_BUILD = "105"; // <-- cambia este n√∫mero en cada publicaci√≥n
document.getElementById("build").textContent = "APP v=" + APP_BUILD;

/* ===== Config √∫nica ===== */

  /* ===== Config de endpoints y fuentes ===== */
  const ENDPOINT = "/api/ask"; // si pruebas remoto, pon la URL absoluta

  // SIEMPRE enviamos CSV + 3 PDFs
  const ALLOWED_SOURCES = [
    "datos/decimo.csv",
    "documentos/lexium.pdf",
    "documentos/evaluaciones.pdf",
    "documentos/emocionales.pdf"
  ];

  // Construye la querystring con la pregunta, fuentes y anti-cach√©
  function buildParams(q){
    const p = new URLSearchParams({ q, ts: Date.now().toString() }); // bust cache
    for (const s of ALLOWED_SOURCES) p.append("src", s);
    return p;
  }

  /* ===== Llamada a la API ===== */
  async function enviarPregunta(){
    const q = document.getElementById("pregunta").value.trim();
    if (!q) { alert("Escribe una pregunta."); return; }

    const url = `${ENDPOINT}?${buildParams(q).toString()}`;
    console.log("‚û°Ô∏è Llamando:", url); // Verifica en DevTools > Network que lleva los 4 src

    try {
      const r = await fetch(url, { cache: "no-store" });
      const t = await r.text();
      let data;
      try { data = JSON.parse(t); } catch { data = { text: t || "" }; }

      document.getElementById("respuesta").textContent =
        data.text || "Sin respuesta.";
    } catch (e) {
      console.error(e);
      document.getElementById("respuesta").textContent =
        "Error de red al contactar el backend.";
    }
  }

  // Enter para enviar
  document.getElementById("pregunta").addEventListener("keydown", (e)=>{
    if (e.key === "Enter") enviarPregunta();
  });


/* ===== Voz mujer es-MX ===== */
let chosenVoice=null;
function scoreVoice(v){
  const n=(v.name||"").toLowerCase(), l=(v.lang||"").toLowerCase(); let s=0;
  if (l.startsWith("es-mx")) s+=100; else if (l.startsWith("es-419")) s+=60; else if (l.startsWith("es")) s+=30;
  if (/(sabina|dalia|beatriz|abril|camila|lucia|female|mujer|femenina)/i.test(n)) s+=40;
  if (/(neural|natural|online)/i.test(n)) s+=20;
  if (/(jorge|liberto|pablo|diego|miguel|enrique|hugo|carlos|male|hombre)/i.test(n)) s-=80;
  return s;
}
function pickFemale(){ const v=speechSynthesis.getVoices()||[]; return v.slice().sort((a,b)=>scoreVoice(b)-scoreVoice(a))[0]||v[0]; }
function sanitize(t){ return (t||"").replace(/```[\s\S]*?```/g," ").replace(/\*/g,"").replace(/^[#>\-\u2022]\s*/gm,"").replace(/\s{2,}/g," ").trim(); }
function speak(text,onStart,onEnd){
  const clean=sanitize(text); if(!clean){ onStart&&onStart(); onEnd&&onEnd(); return; }
  if(!chosenVoice) chosenVoice=pickFemale();
  const u=new SpeechSynthesisUtterance(clean);
  if(chosenVoice) u.voice=chosenVoice;
  u.lang=chosenVoice?.lang?.startsWith("es")?chosenVoice.lang:"es-MX";
  u.rate=1.12; u.pitch=1.02; u.volume=1.0;
  u.onstart=()=>onStart&&onStart(); u.onend=()=>onEnd&&onEnd(); u.onerror=()=>onEnd&&onEnd();
  speechSynthesis.cancel(); speechSynthesis.speak(u);
}
speechSynthesis.onvoiceschanged=()=>{ chosenVoice=null };

/* ===== UI ===== */
const $q=document.getElementById("q");
const $out=document.getElementById("out");
const $vid=document.getElementById("vid");
document.getElementById("send").onclick=enviar;
document.getElementById("stop").onclick=()=>{ try{ speechSynthesis.cancel(); }catch{} try{ $vid.pause(); }catch{} };
document.getElementById("clear").onclick=()=>{ try{ speechSynthesis.cancel(); }catch{} $q.value=""; $out.textContent=""; $q.focus(); };
document.getElementById("mic").onclick=()=>{ const SR=window.SpeechRecognition||window.webkitSpeechRecognition; if(!SR){ alert("Tu navegador no soporta micr√≥fono."); return; } const rec=new SR(); rec.lang="es-MX"; rec.interimResults=false; rec.maxAlternatives=1; rec.onresult=e=>{ $q.value=e.results[0][0].transcript; enviar() }; rec.onerror=e=>alert("Error de micr√≥fono: "+e.error); rec.start(); };
$q.addEventListener("keydown",e=>{ if((e.ctrlKey||e.metaKey)&&e.key==="Enter") enviar(); });

async function enviar(){
  const query=($q.value||"").trim();
  if(!query){ alert("Escribe una pregunta."); return; }
  try{ speechSynthesis.cancel(); }catch{}
  $out.textContent="Consultando‚Ä¶";

  const url = `${ENDPOINT}?${buildParams(query).toString()}&ts=${Date.now()}`;
  console.log("[FRONT] URL =>", url); // para verificar

  try{
    const r = await fetch(url, { cache:"no-store" });
    const txt = await r.text();
    let data; try{ data = JSON.parse(txt); } catch { data = { text: txt||"" }; }

    const ans = data.text || "Sin respuesta.";
    $out.textContent = ans;
    speak(ans, ()=> $vid.play(), ()=> $vid.pause());

  }catch(err){
    $out.textContent = "No se pudo contactar al servidor. " + String(err?.message||err||"");
  }
}

    // ============Iniciio Ma 3=========
// Ejecuta la exportaci√≥n seg√∫n el formato elegido
    // ====== Inivcio  Mar3 =====
    // Extiende el exportador seg√∫n el selector
    
function exportSeleccion(){
  const tipo = document.getElementById("exportType").value;
  if (tipo === "pdf"){ exportPDF(); return; }
  if (tipo === "csv"){ exportCSV(); return; }
  if (tipo === "docx"){ exportDOCX(); return; }
  alert("Formato no soportado por ahora.");
}

// Exportar a DOCX (Word)
async function exportDOCX(){
  try{
    // Usamos la tabla si existe; si no, cuerpo de texto
    const rows = (window.lastRows && Array.isArray(window.lastRows) && window.lastRows.length) ? window.lastRows : null;
    const plain = (!rows ? (document.getElementById("respuesta")?.textContent?.trim() || "Sin datos.") : "");

    // Aliases de docx UMD
    const { Document, Packer, Paragraph, Table, TableRow, TableCell, WidthType, TextRun, HeadingLevel } = window.docx;

    // Construir contenido
    const children = [];

    // T√≠tulo
    children.push(
      new Paragraph({
        text: "Resultados",
        heading: HeadingLevel.HEADING_1,
        spacing: { after: 200 }
      })
    );

    if (rows){
      // Tabla desde lastRows
      const tableRows = rows.map(r => new TableRow({
        children: r.map(c => new TableCell({
          width: { size: 100 / r.length, type: WidthType.PERCENTAGE },
          children: [ new Paragraph(String(c ?? "")) ]
        }))
      }));

      children.push(new Table({
        width: { size: 100, type: WidthType.PERCENTAGE },
        rows: tableRows
      }));
    } else {
      // P√°rrafos desde texto plano
      const parts = plain.split(/\n{2,}/);
      parts.forEach(block => {
        const lines = block.split(/\n/);
        lines.forEach((ln, i) => {
          children.push(new Paragraph({
            children: [ new TextRun({ text: ln, break: i>0 ? 1 : 0 }) ],
            spacing: { after: 120 }
          }));
        });
      });
    }

    // Crear documento
    const doc = new Document({ sections: [{ children }] });
    const blob = await Packer.toBlob(doc);

    // Descargar
    descargarBlob(blob, "resultado.docx");
  } catch (e){
    console.error(e);
    // Fallback sencillo: .doc (HTML) compatible con Word
    exportDOC_Fallback();
  }
}

// Fallback a .DOC (Word abre HTML renombrado)
function exportDOC_Fallback(){
  const rows = (window.lastRows && Array.isArray(window.lastRows) && window.lastRows.length) ? window.lastRows : null;
  let html = "<html><head><meta charset='utf-8'><title>Resultados</title></head><body>";
  html += "<h1 style='font-family:Arial'>Resultados</h1>";

  if (rows){
    html += "<table border='1' cellspacing='0' cellpadding='5' style='border-collapse:collapse;font-family:Arial'>";
    rows.forEach((r, i) => {
      html += "<tr>";
      r.forEach((c, j) => {
        const tag = (i===0 ? "th" : "td");
        html += `<${tag}>${escapeHtml(String(c ?? ""))}</${tag}>`;
      });
      html += "</tr>";
    });
    html += "</table>";
  } else {
    const texto = document.getElementById("respuesta")?.textContent?.trim() || "";
    html += `<div style="white-space:pre-wrap;font-family:Arial">${escapeHtml(texto)}</div>`;
  }

  html += "</body></html>";
  const blob = new Blob([html], { type: "application/msword" });
  descargarBlob(blob, "resultado.doc");
}

// Utilidades
function descargarBlob(blob, nombre){
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = nombre;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

    //==========FIN===============
function exportSeleccion(){
  const tipo = document.getElementById("exportType").value;
  if (tipo === "pdf"){
    exportPDF(); // funci√≥n que ya tienes en tu app
    return;
  }
  if (tipo === "csv"){
    exportCSV();
    return;
  }
  alert("Formato no soportado por ahora.");
}

// Exportar CSV desde tabla detectada o texto plano
function exportCSV(){
  if (window.lastRows && Array.isArray(window.lastRows) && window.lastRows.length){
    const csv = window.lastRows.map(row => 
      row.map(cell => {
        const s = String(cell ?? "");
        return `"${s.replace(/"/g,'""')}"`; // escapa comillas
      }).join(",")
    ).join("\r\n");

    descargarArchivo(csv, "resultado.csv", "text/csv;charset=utf-8");
    return;
  }

  const texto = document.getElementById("respuesta")?.textContent?.trim() || "";
  if (!texto){
    alert("No hay datos para exportar.");
    return;
  }
  const csv = `#,"Respuesta"\r\n1,"${texto.replace(/"/g,'""')}"\r\n`;
  descargarArchivo(csv, "resultado.csv", "text/csv;charset=utf-8");
}

// Utilidad para descargar archivos
function descargarArchivo(contenido, nombre, tipo){
  const blob = new Blob([contenido], { type: tipo });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement("a");
  a.href = url;
  a.download = nombre;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

// Liberar memoria y limpiar UI
function liberarMemoria(){
  try{ localStorage.clear(); }catch{}
  try{ sessionStorage.clear(); }catch{}

  document.getElementById("pregunta").value = "";
  const out = document.getElementById("respuesta");
  if (out){ out.hidden = false; out.textContent = ""; }

  if (window.vlistWrap){ vlistWrap.hidden = true; vlistWrap.innerHTML = ""; }
  if (window.tablaWrap){ tablaWrap.hidden = true; tablaWrap.innerHTML = ""; }
  
  window.lastRows = null;
  alert("Memoria liberada ‚úÖ");
}





    // ============ Fin Mar3 =======
</script>
</body>
</html>
