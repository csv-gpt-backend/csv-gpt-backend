<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Consulta Educativa Lexium</title>
  <link rel="icon" href="/favicon.ico">
  <style>
    :root{
      --accent:#0a66ff;
      --bg:#ffffff;
      --muted:#f6f7f9;
      --text:#121212;
      --rail-h: 440px; /* video un poco m√°s grande */
    }
    *{ box-sizing:border-box }
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg); color:var(--text);
    }
    /* HEADER 25/50/25 */
    .rail{
      display:grid; grid-template-columns: 1fr 2fr 1fr; align-items:center;
      height:var(--rail-h); gap:12px; padding:8px 12px;
    }
    .rail .cell{ display:flex; justify-content:center; align-items:center; height:100%; overflow:hidden }
    .rail img{ max-width:100%; max-height:100%; object-fit:contain }
    .rail video{
      width:100%; height:100%; object-fit:contain; border-radius:12px;
      background:#0002;
    }

    /* MAIN */
    .wrap{ max-width:1100px; margin:10px auto 36px; padding:0 12px }
    .bar{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:center; align-items:center;
      margin-top:10px;
    }
    textarea{
      width:100%; min-height:96px; resize:vertical; padding:14px 16px; line-height:1.35;
      border:1px solid #e1e3e6; border-radius:12px; background:#fff; outline:none; font-size:15px;
    }

    .btn{
      display:inline-flex; gap:8px; align-items:center; justify-content:center;
      padding:12px 16px; border:0; border-radius:12px; background:var(--accent); color:#fff;
      font-weight:700; cursor:pointer; box-shadow:0 1px 0 #0001;
      transition:filter .15s ease;
    }
    .btn:hover{ filter:brightness(.95) }
    .btn.secondary{ background:#eef1f6; color:#0a0a0a; border:1px solid #dfe3ea }
    .btn.warn{ background:#ffd54d; color:#222 }
    .btn.mic{ font-size:18px; padding:14px 18px } /* mic un poco m√°s grande */

    select{
      height:44px; border:1px solid #dfe3ea; border-radius:12px; background:#fff; padding:0 12px;
      font-weight:600;
    }

    .out{
      margin-top:14px; padding:14px; background:var(--muted);
      border:1px solid #e8ebf0; border-radius:12px; white-space:pre-wrap; line-height:1.45; font-size:15px;
    }
    .muted{ color:#6b7280 }

    /* centrado y separaci√≥n */
    .row{ display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap }
  </style>
</head>
<body>

  <!-- HEADER -->
  <div class="rail">
    <div class="cell">
      <img src="/left.png" alt="Santillana">
    </div>
    <div class="cell">
      <video id="video" muted playsinline preload="metadata">
        <source src="https://xsmr71ubix2w6tve.public.blob.vercel-storage.com/OLIVIA%20IN%20CASUAL.mp4" type="video/mp4">
        Tu navegador no soporta video.
      </video>
    </div>
    <div class="cell">
      <img src="/right.png" alt="Compartir">
    </div>
  </div>

  <div class="wrap">
    <textarea id="q" placeholder="Escribe o dicta tu pregunta‚Ä¶"></textarea>

    <!-- BARRA √öNICA -->
    <div class="bar">
      <button id="send" class="btn">‚û§ Enviar</button>
      <button id="mic" class="btn mic secondary">üéôÔ∏è Dictar</button>

      <select id="exportFmt" title="Formato de exportaci√≥n">
        <option value="pdf">PDF (vista previa)</option>
        <option value="docx">DOCX (Word)</option>
        <option value="xlsx">Excel (tabla)</option>
      </select>
      <button id="export" class="btn secondary">‚¨á Exportar</button>

      <button id="reset" class="btn warn">‚öô Reiniciar</button>
      <button id="clear" class="btn secondary">üßπ Limpiar</button>
    </div>

    <div id="out" class="out">Escribe o dicta tu pregunta y presiona <b>Enviar</b>.</div>
  </div>

  <script>
    /********* Config *********/
    const ENDPOINT = "/api/ask";
    const ALLOWED_SOURCES = [
      "datos/decimo.csv",
      "documentos/lexium.pdf",
      "documentos/evaluaciones.pdf",
      "documentos/emocionales.pdf"
    ];

    /********* Helpers *********/
    const video = document.getElementById("video");
    const out   = document.getElementById("out");
    const qEl   = document.getElementById("q");

    function buildParams(q){
      const p = new URLSearchParams({ q });
      ALLOWED_SOURCES.forEach(s => p.append("src", s));
      return p.toString();
    }

    function setOut(text){ out.textContent = text || ""; }

    /********* Voz femenina es-MX estricta *********/
    let chosenVoice = null;
    const FEMALE_HINTS = ["female","mujer","femenina","sabina","dalia","beatriz","abril","camila","lucia","paola","valentina","soledad","laura","carla","carolina"];
    const MALE_HINTS   = ["male","hombre","jorge","liberto","pablo","diego","miguel","enrique","hugo","carlos","francisco","pedro","jaime","sergio"];

    function pickFemaleSpanishVoice(){
      const voices = window.speechSynthesis?.getVoices?.() || [];
      if (!voices.length) return null;

      // 1) Preferir es-MX
      let pool = voices.filter(v =>
        /^es(-mx)?/i.test(v.lang || "") &&
        !MALE_HINTS.some(x => (v.name||"").toLowerCase().includes(x))
      );
      // 2) Si no hay, aceptar es-419 o es-ES femeninas
      if (!pool.length) {
        pool = voices.filter(v =>
          /^es/i.test(v.lang || "") &&
          FEMALE_HINTS.some(x => (v.name||"").toLowerCase().includes(x)) &&
          !MALE_HINTS.some(x => (v.name||"").toLowerCase().includes(x))
        );
      }
      // 3) Si a√∫n no hay, √∫ltima chance: cualquier es-* que no ‚Äúhuela‚Äù a hombre
      if (!pool.length) {
        pool = voices.filter(v =>
          /^es/i.test(v.lang || "") &&
          !MALE_HINTS.some(x => (v.name||"").toLowerCase().includes(x))
        );
      }
      return pool[0] || null;
    }

    function ensureFemaleVoice(){
      chosenVoice = pickFemaleSpanishVoice();
      if (!chosenVoice) {
        // reintenta cuando el navegador cargue las voces
        window.speechSynthesis?.addEventListener?.("voiceschanged", () => {
          if (!chosenVoice) chosenVoice = pickFemaleSpanishVoice();
        }, { once:true });
      }
    }
    ensureFemaleVoice();

    function sanitizeForSpeech(text){
      return (text || "")
        .replace(/```[\s\S]*?```/g, " ")
        .replace(/\*/g, "")
        .replace(/^[#>\-\u2022]\s*/gm, "")
        .replace(/\s{2,}/g, " ")
        .trim();
    }

    function speak(text){
      if (!window.speechSynthesis) return;
      const clean = sanitizeForSpeech(text);
      if (!clean) return;

      // asegurar voz femenina
      if (!chosenVoice) ensureFemaleVoice();
      const u = new SpeechSynthesisUtterance(clean);
      if (chosenVoice) u.voice = chosenVoice;
      u.lang = (chosenVoice?.lang?.startsWith("es") ? chosenVoice.lang : "es-MX");
      u.rate = 1.12; u.pitch = 1.02; u.volume = 1.0;

      // Video: loop durante el habla
      u.onstart = () => {
        try{ video.loop = true; video.play(); }catch{}
      };
      u.onend = () => {
        try{ video.pause(); video.currentTime = 0; video.loop = false; }catch{}
      };
      u.onerror = () => {
        try{ video.pause(); video.currentTime = 0; video.loop = false; }catch{}
      };

      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }

    /********* Mic (dictado) *********/
    function startListening(){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR){ alert("Tu navegador no soporta reconocimiento de voz."); return; }
      const r = new SR();
      r.lang = "es-MX";
      r.interimResults = false; r.maxAlternatives = 1;
      r.onresult = e => {
        const t = e.results[0][0].transcript;
        qEl.value = t;
        enviarPregunta();
      };
      r.onerror = e => alert("Error de micr√≥fono: "+ e.error);
      r.start();
    }

    /********* Enviar *********/
    async function enviarPregunta(){
      const q = qEl.value.trim();
      if (!q){ alert("Escribe una pregunta."); return; }

      const url = `${ENDPOINT}?${buildParams(q)}`;
      setOut("Consultando‚Ä¶");
      try{
        // para depuraci√≥n: ver URL real con las 4 fuentes
        console.log("Llamando:", url);
        const r = await fetch(url, { cache:"no-store" });
        const txt = await r.text();
        let data; try { data = JSON.parse(txt); } catch { data = { text: txt || "" }; }

        const msg = data.text || data.answer || data.respuesta || "Sin respuesta.";
        setOut(msg);

        // Hablar (voz femenina) y mantener video mientras habla
        speak(msg);
      }catch(e){
        setOut("Error: " + e);
      }
    }

    /********* Export (placeholder) *********/
    document.getElementById("export").addEventListener("click", ()=>{
      const fmt = (document.getElementById("exportFmt").value || "pdf");
      alert("Exportar (placeholder): " + fmt + "\nPuedes conectar tu export real aqu√≠.");
    });

    /********* Reset / Clear *********/
    document.getElementById("reset").addEventListener("click", ()=>{
      try{ localStorage.clear(); }catch{}
      window.location.href = "/?v=" + Date.now();
    });
    document.getElementById("clear").addEventListener("click", ()=>{
      qEl.value = ""; setOut("Listo. Escribe o dicta tu pregunta y presiona Enviar.");
      try{ window.speechSynthesis.cancel(); video.pause(); video.currentTime = 0; video.loop = false; }catch{}
    });

    /********* Listeners *********/
    document.getElementById("send").addEventListener("click", enviarPregunta);
    document.getElementById("mic").addEventListener("click", startListening);
    qEl.addEventListener("keydown", e => { if (e.key === "Enter" && (e.ctrlKey || e.metaKey)) enviarPregunta(); });
  </script>
</body>
</html>
