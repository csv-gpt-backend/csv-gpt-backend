<script>
(function(){
  // === Utilidades ===
  const norm = s => (s||"").toString().trim().toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"");
  function hilite(el){ if(!el) return; const prev = el.style.outline; el.style.outline="2px solid #22c55e";
    setTimeout(()=>{ el.style.outline=prev||""; }, 2000); }

  // === Detectores de elementos ===
  function pickPregunta(){
    return document.querySelector('#pregunta') ||
           document.querySelector('textarea') ||
           document.querySelector('input[type="text"]');
  }
  function pickRespuesta(){
    return document.querySelector('#respuesta') ||
           [...document.querySelectorAll('.answer,.card,div,p')].find(el=> norm(el.textContent).includes('aqui aparecera la explicacion')) ||
           [...document.querySelectorAll('.answer,.card,div')].find(el=> getComputedStyle(el).whiteSpace.includes('pre')) ||
           document.createElement('div');
  }
  function pickBtnEnviar(){
    const byId = document.querySelector('#btnEnviar');
    if (byId) return byId;
    const cands = [...document.querySelectorAll('button,[role="button"]')];
    return cands.find(b=> norm(b.textContent).includes('enviar')) || null;
  }
  function pickBtnMic(){
    const byId = document.querySelector('#btnMic');
    if (byId) return byId;
    const cands = [...document.querySelectorAll('button,[role="button"]')];
    return cands.find(b=>{
      const t = norm(b.textContent);
      return t.includes('voz') || t.includes('micro') || b.textContent.includes('游꿗');
    }) || null;
  }
  function pickVideo(){
    return document.querySelector('#video') || document.querySelector('video') || null;
  }

  // === Asegurar IDs est치ndar ===
  let pregunta = pickPregunta();
  if (pregunta && !pregunta.id){ pregunta.id = 'pregunta'; }
  let respuesta = pickRespuesta();
  if (respuesta && !respuesta.id){ respuesta.id = 'respuesta'; }
  let btnEnviar = pickBtnEnviar();
  if (btnEnviar && !btnEnviar.id){ btnEnviar.id = 'btnEnviar'; }
  let btnMic = pickBtnMic();
  if (btnMic && !btnMic.id){ btnMic.id = 'btnMic'; }
  let video = pickVideo();
  if (video && !video.id){ video.id = 'video'; }

  // Insertar respuesta si la tuvimos que crear
  if (!document.getElementById('respuesta')) {
    respuesta.className = (respuesta.className||'') + ' answer';
    respuesta.style.whiteSpace = 'pre-wrap';
    respuesta.textContent = 'Aqu칤 aparecer치 la explicaci칩n...';
    const panel = document.querySelector('.panel') || document.body;
    panel.appendChild(respuesta);
  }

  // Resaltar lo que detectamos
  [pregunta, respuesta, btnEnviar, btnMic, video].forEach(hilite);

  // === Voz: seleccionar femenina es-MX y fijarla ===
  const VOICE_WHITELIST = [
    "Microsoft Sabina Online (Natural) - Spanish (Mexico)",
    "Microsoft Sabina - Spanish (Mexico)",
    "Google espa침ol (Latinoam칠rica)",
    "Google espa침ol de Estados Unidos",
    "Dalia","Sabina","Beatriz","Abril","Camila","Lucia","Paulina","Monica","Lupe"
  ];
  const FEMALE_HINTS = ["female","mujer","femenina","dalia","sabina","beatriz","abril","camila","lucia","paola","valentina","monica","paulina"];
  const MALE_HINTS   = ["male","hombre","jorge","liberto","pablo","diego","miguel","enrique","hugo","carlos","alonso","manuel"];

  let chosenVoice = null;
  function scoreVoice(v){
    const name = (v.name||"").toLowerCase();
    const lang = (v.lang||"").toLowerCase();
    let s=0;
    if (lang.startsWith("es-mx")) s+=120; else if (lang.startsWith("es-419")) s+=80; else if (lang.startsWith("es")) s+=50;
    if (VOICE_WHITELIST.some(t=> name.includes(t.toLowerCase()))) s+=70;
    if (/(natural|neural|online)/i.test(name)) s+=30;
    if (FEMALE_HINTS.some(t=> name.includes(t))) s+=40;
    if (MALE_HINTS.some(t=> name.includes(t))) s-=80;
    return s;
  }
  function pickSpanishFemaleVoice(){
    const voices = window.speechSynthesis?.getVoices?.() || [];
    if (!voices.length) return null;
    const urlForce = new URLSearchParams(location.search).get("voice");
    const saved = localStorage.getItem("voiceName");
    const target = (urlForce || saved || "").toLowerCase();
    if (target){
      const v = voices.find(v => (v.name||"").toLowerCase().includes(target));
      if (v) return v;
    }
    for (const targetName of VOICE_WHITELIST){
      const v = voices.find(v => (v.name||"").toLowerCase().includes(targetName.toLowerCase()));
      if (v) return v;
    }
    return voices.slice().sort((a,b)=> scoreVoice(b)-scoreVoice(a))[0] || voices[0];
  }
  function ensureVoiceSelected(){
    if (!chosenVoice){
      chosenVoice = pickSpanishFemaleVoice();
      if (chosenVoice){ localStorage.setItem("voiceName", chosenVoice.name); }
    }
  }
  window.speechSynthesis.onvoiceschanged = () => { chosenVoice=null; ensureVoiceSelected(); };

  // Limpiar texto para TTS (sin asteriscos ni markdown)
  function cleanForTTS(s=""){
    return String(s)
      .replace(/\*\*/g,"").replace(/\*/g,"")
      .replace(/[_`>#]/g,"").replace(/\s{2,}/g," ")
      .trim();
  }

  // API global de voz
  window.speakAuto = function(text){
    if(!window.speechSynthesis) return;
    ensureVoiceSelected();
    const clean = cleanForTTS(text||"");
    if (!clean) return;
    const vid = document.getElementById('video');
    const u = new SpeechSynthesisUtterance(clean);
    if (chosenVoice) u.voice = chosenVoice;
    u.lang = chosenVoice?.lang?.startsWith("es") ? chosenVoice.lang : "es-MX";
    u.rate=1.12; u.pitch=1.02; u.volume=1.0;
    u.onstart = ()=> vid?.play?.();
    u.onend   = ()=> vid?.pause?.();
    u.onerror = ()=> vid?.pause?.();
    try{ window.speechSynthesis.cancel(); }catch{}
    window.speechSynthesis.speak(u);
  };
  window.stopSpeak = function(){
    try{ window.speechSynthesis.cancel(); }catch{}
    try{ document.getElementById('video')?.pause?.(); }catch{}
  };

  // === Dictado (游꿗) y env칤o ===
  function startDictation(targetEl){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR){ alert("Tu navegador no soporta dictado por voz."); return; }
    const rec = new SR();
    rec.lang="es-MX"; rec.interimResults=false; rec.maxAlternatives=1;
    rec.onresult = e => {
      const t = e.results[0][0].transcript || "";
      (targetEl||pregunta).value = t;
      (targetEl||pregunta).dispatchEvent(new Event("input",{bubbles:true}));
      // intenta enviar autom치ticamente
      if (typeof window.enviarPregunta === "function") window.enviarPregunta();
      else if (btnEnviar) btnEnviar.click();
      else {
        // simulamos Enter
        const ev = new KeyboardEvent("keydown", {key:"Enter", ctrlKey:true, bubbles:true});
        (targetEl||pregunta).dispatchEvent(ev);
      }
    };
    rec.onerror = e => console.warn("STT error:", e.error);
    rec.start();
  }

  if (btnMic && !btnMic.dataset.bound){
    btnMic.addEventListener('click', ()=> startDictation(pregunta));
    btnMic.dataset.bound = "1";
  }

  // === Observa cambios de #respuesta para leer autom치ticamente (opcional) ===
  // Si ya tienes tu propia llamada a speakAuto en tu c칩digo, puedes comentar este bloque.
  if (respuesta){
    let last = "";
    const debounced = (()=>{ let t; return fn=>{ clearTimeout(t); t=setTimeout(fn,250);} })();
    new MutationObserver(()=> debounced(()=>{
      const txt = (respuesta.textContent||"").trim();
      if (txt && txt !== last){ last = txt; window.speakAuto(txt); }
    })).observe(respuesta, {childList:true, subtree:true, characterData:true});
  }

  // Log de mapeo
  console.info("IDs fijados:", {
    pregunta: pregunta?.id, respuesta: respuesta?.id,
    btnEnviar: btnEnviar?.id, btnMic: btnMic?.id,
    video: video?.id
  });
})();
</script>
