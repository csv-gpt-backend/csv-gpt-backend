<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Consulta Educativa</title>

<!-- PDF.js (extraer texto de PDFs de forma silenciosa) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<!-- jsPDF (exportar a PDF) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  /* ---------- Reset seguro ---------- */
  *, *::before, *::after { box-sizing: border-box; }
  html, body { margin:0; padding:0; }
  img, video { max-width: 100%; display: block; }
  button, input, select, textarea { font: inherit; }

  /* ---------- Tema ---------- */
  :root{
    --accent:#1273ea;
    --soft:#f7f8fb;
    --border:#e7e9f0;
    --radius:14px;
    --shadow:0 6px 24px rgba(0,0,0,.06);
    --maxw: 1100px;
  }
  body{
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    color:#101114; background:#fff;
  }

  /* ---------- Barra superior opcional (logos) ---------- */
  .topbar{
    display:flex; align-items:center; justify-content:space-between;
    padding:12px 18px; border-bottom:1px solid var(--border);
  }
  .brand img{ height:44px; }

  /* ---------- Contenedor ---------- */
  .wrap{ max-width: var(--maxw); margin: 14px auto 32px; padding: 0 14px; }

  /* ---------- Video ---------- */
  .video-box{ display:flex; justify-content:center; }
  video{
    width: 100%;
    max-width: 820px;   /* <- ajusta aqu칤 si lo quieres un poco + o - grande */
    height:auto;
    border-radius: 12px;
    box-shadow: var(--shadow);
  }

  /* ---------- Barra de pregunta ---------- */
  .askbar{
    margin-top: 14px;
    display:flex; gap:12px; align-items:stretch; /* <- mantiene alturas */
  }
  .askbar textarea{
    flex:1 1 auto;
    min-height: 58px;         /* 2-3 l칤neas */
    max-height: 180px;
    resize: vertical;
    padding: 12px 14px;
    border:1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    line-height: 1.35;
  }
  .controls{
    display:flex; flex-direction:column; gap:10px; width: 130px;
  }
  .btn{
    border:0; border-radius: 12px; cursor:pointer;
    padding: 14px 14px; font-weight:600; white-space:nowrap;
    box-shadow: var(--shadow);
    min-height: 58px;           /* <- mismo alto que textarea */
  }
  .btn.primary{ background: var(--accent); color:#fff; }
  .btn.secondary{ background:#fff; color:#101114; border:1px solid var(--border); }

  /* ---------- Respuesta + tabla ---------- */
  .answer{
    margin-top:14px; background: var(--soft);
    border:1px solid var(--border); border-radius: var(--radius);
    padding: 14px; min-height:60px; white-space:pre-wrap;
    box-shadow: var(--shadow);
  }
  .table-wrap{
    margin-top: 12px; background:#fff; border:1px solid var(--border);
    border-radius: var(--radius); overflow:auto; box-shadow: var(--shadow);
  }
  table.data{ width:100%; border-collapse:collapse; font-size:14px; }
  table.data thead th{
    position: sticky; top:0; background:#f3f5f8;
    border-bottom:1px solid #dee1e6; text-align:left; padding:10px 8px;
    font-weight:700; white-space:nowrap;
  }
  table.data tbody td{
    border-top:1px solid #f0f2f5; padding:8px 8px; vertical-align:top;
  }
  table.data tbody tr:nth-child(odd){ background:#fafbfc; }

  /* ---------- Exportar ---------- */
  .exportbar{
    display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    margin-top: 14px;
  }
  select{
    border:1px solid var(--border); border-radius: 12px;
    padding: 12px 12px; background:#fff; min-height: 48px;
  }
  .btn.small{ min-height:48px; padding: 12px 14px; }

  /* ---------- Responsive ---------- */
  @media (max-width: 800px){
    .controls{ width: 100%; flex-direction:row; }
    .askbar{ flex-direction:column; }
  }
</style>
</head>
<body>

  <div class="topbar">
    <div class="brand"><img src="/left.png" alt="SANTILLANA"></div>
    <div class="brand"><img src="/right.png" alt="COMPARTIR"></div>
  </div>

  <div class="wrap">

    <div class="video-box">
      <video id="video" muted playsinline preload="metadata">
        <source src="https://xsmr71ubix2w6tve.public.blob.vercel-storage.com/OLIVIA%20IN%20CASUAL.mp4" type="video/mp4">
        Tu navegador no soporta video.
      </video>
    </div>

    <div class="askbar">
      <textarea id="pregunta" placeholder=""></textarea>

      <div class="controls">
        <button id="btnEnviar" class="btn primary">Enviar</button>
        <button id="btnMic" class="btn secondary" title="Dictar por voz">游꿗 Voz</button>
      </div>
    </div>

    <div id="respuesta" class="answer">Aqu칤 aparecer치 la explicaci칩n...</div>
    <div id="tabla" class="table-wrap" hidden></div>

    <div class="exportbar">
      <select id="format">
        <option value="pdf">Exportar PDF</option>
        <option value="doc">Exportar Word</option>
        <option value="csv">Exportar CSV</option>
      </select>
      <button id="btnExport" class="btn small primary">Exportar</button>
      <button id="btnStop" class="btn small secondary">Detener voz</button>
      <button id="btnClear" class="btn small secondary">Limpiar</button>
    </div>
  </div>

<script>
(() => {
  /* =========================
     Par치metros
  ========================== */
  const CSV_FILE = "decimo.csv";
  const API_ENDPOINTS = ["/api/ask", "/api/preguntar"];
  const PDF_URLS = [
    "https://csv-gpt-backend.vercel.app/lexium.pdf",
    "https://csv-gpt-backend.vercel.app/evaluaciones.pdf"
  ];
  const MEMORY_MS = 10 * 60 * 1000;   // 10 min
  const MAX_PDF_TEXT_CHARS = 3000;

  const TABLE_WORDS = ["lista","listado","listar","enlista","enlistar","tabla","cuadro","table","cuadros"];

  /* =========================
     UI refs
  ========================== */
  const pregunta = document.getElementById("pregunta");
  const respuesta = document.getElementById("respuesta");
  const tablaWrap = document.getElementById("tabla");
  const btnEnviar = document.getElementById("btnEnviar");
  const btnMic = document.getElementById("btnMic");
  const btnExport = document.getElementById("btnExport");
  const btnStop = document.getElementById("btnStop");
  const btnClear = document.getElementById("btnClear");
  const formatSel = document.getElementById("format");
  const video = document.getElementById("video");

  /* =========================
     Memoria 10 min
  ========================== */
  const MEMKEY = "ctx:last";
  function saveCtx(q){
    try{ localStorage.setItem(MEMKEY, JSON.stringify({ q, ts: Date.now() })); }catch{}
  }
  function loadCtx(){
    try{
      const raw = localStorage.getItem(MEMKEY);
      if(!raw) return null;
      const obj = JSON.parse(raw);
      if(Date.now() - obj.ts > MEMORY_MS) return null;
      return obj.q || null;
    }catch{ return null }
  }

  /* =========================
     Voz (TTS y dictado)
  ========================== */
  const VOICE_WHITELIST = [
    "Microsoft Sabina Online (Natural) - Spanish (Mexico)",
    "Microsoft Sabina - Spanish (Mexico)",
    "Google espa침ol (Latinoam칠rica)",
    "Google espa침ol de Estados Unidos",
    "Dalia","Sabina","Beatriz","Abril","Camila","Lucia","Paulina","Monica","Lupe"
  ];
  const FEMALE_HINTS = ["female","mujer","femenina","dalia","sabina","beatriz","abril","camila","lucia","paola","valentina","monica","paulina"];
  const MALE_HINTS   = ["male","hombre","jorge","liberto","pablo","diego","miguel","enrique","hugo","carlos","alonso","manuel"];
  let chosenVoice = null;

  function scoreVoice(v){
    const name = (v.name||"").toLowerCase();
    const lang = (v.lang||"").toLowerCase();
    let s = 0;
    if (lang.startsWith("es-mx")) s += 120;
    else if (lang.startsWith("es-419")) s += 80;
    else if (lang.startsWith("es")) s += 50;
    if (VOICE_WHITELIST.some(t => name.includes(t.toLowerCase()))) s += 70;
    if (/(natural|neural|online)/i.test(name)) s += 30;
    if (FEMALE_HINTS.some(t => name.includes(t))) s += 40;
    if (MALE_HINTS.some(t => name.includes(t))) s -= 80;
    return s;
  }
  function pickVoice() {
    const voices = window.speechSynthesis?.getVoices?.() || [];
    if (!voices.length) return null;
    const urlForce = new URLSearchParams(location.search).get("voice");
    const saved = localStorage.getItem("voiceName");
    const target = (urlForce || saved || "").toLowerCase();
    if (target){
      const v = voices.find(v => (v.name||"").toLowerCase().includes(target));
      if (v) return v;
    }
    for (const t of VOICE_WHITELIST){
      const v = voices.find(v => (v.name||"").toLowerCase().includes(t.toLowerCase()));
      if (v) return v;
    }
    return voices.slice().sort((a,b)=> scoreVoice(b)-scoreVoice(a))[0] || voices[0];
  }
  function ensureVoice(){
    if (!chosenVoice){
      chosenVoice = pickVoice();
      if (chosenVoice) localStorage.setItem("voiceName", chosenVoice.name);
    }
  }
  window.speechSynthesis.onvoiceschanged = ()=>{ chosenVoice=null; ensureVoice(); };

  function sanitizeSpeakText(t){
    return String(t||"")
      .replace(/\*\*/g,"").replace(/\*/g,"")
      .replace(/[_`>#]/g,"")
      .replace(/\s{2,}/g," ").trim();
  }
  function speakAuto(text){
    if(!window.speechSynthesis) return;
    stopSpeak();
    ensureVoice();
    const u = new SpeechSynthesisUtterance(sanitizeSpeakText(text));
    if (chosenVoice) u.voice = chosenVoice;
    u.lang = chosenVoice?.lang?.startsWith("es") ? chosenVoice.lang : "es-MX";
    u.rate = 1.12; u.pitch = 1.02; u.volume = 1.0;
    u.onstart = ()=> video?.play?.();
    u.onend   = ()=> video?.pause?.();
    u.onerror = ()=> video?.pause?.();
    window.speechSynthesis.speak(u);
  }
  function stopSpeak(){ try{ speechSynthesis.cancel(); }catch{} try{ video.pause(); }catch{} }

  // dictado
  function startDictation(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR){ alert("Tu navegador no soporta reconocimiento de voz."); return; }
    const rec = new SR();
    rec.lang="es-MX"; rec.interimResults=false; rec.maxAlternatives=1;
    rec.onresult = e=>{
      const t = e.results[0][0].transcript;
      pregunta.value = t;
      enviarPregunta();
    };
    rec.onerror = e=>{
      alert("Error de micr칩fono: " + e.error + "\nPermite el micr칩fono (icono de candado en la barra del navegador).");
    };
    rec.start();
  }

  /* =========================
     PDFs silenciosos (contexto)
  ========================== */
  let pdfContextText = "";
  async function loadPDFText(url){
    try{
      const loadingTask = pdfjsLib.getDocument({ url });
      const pdf = await loadingTask.promise;
      let all = "";
      for (let i=1;i<=pdf.numPages;i++){
        const page = await pdf.getPage(i);
        const c = await page.getTextContent();
        const txt = c.items.map(it=> it.str).join(" ");
        all += txt + "\n";
        if (all.length > MAX_PDF_TEXT_CHARS) break;
      }
      return all.slice(0, MAX_PDF_TEXT_CHARS);
    }catch{ return ""; }
  }
  async function preloadPDFs(){
    const parts = await Promise.all(PDF_URLS.map(loadPDFText));
    pdfContextText = parts.filter(Boolean).join("\n\n").slice(0, MAX_PDF_TEXT_CHARS);
  }
  preloadPDFs();

  /* =========================
     Helpers tabla/export
  ========================== */
  function escapeHTML(s){ return String(s||"").replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
  function parseMarkdownTable(text){
    const lines = text.split(/\r?\n/).map(l=>l.trim());
    const md = lines.filter(l => /^\|.*\|$/.test(l));
    if (md.length < 2) return null;
    const rows = md.map(l=> l.replace(/^\|/,"").replace(/\|$/,"").split("|").map(c=>c.trim()));
    const sepIdx = rows.findIndex(r => r.every(c => /^:?-{3,}:?$/.test(c)));
    if (sepIdx >= 0) rows.splice(sepIdx,1);
    return rows.length >= 2 ? rows : null;
  }
  function extractCsvBlock(text){
    const m = text.match(/```(?:csv)?\s*([\s\S]*?)```/i);
    return m ? m[1].trim() : null;
  }
  function parseDelimited(text){
    const lines = text.split(/\r?\n/).filter(l=>l.trim().length);
    if (lines.length < 2) return null;
    const d = [",",";","\t","|"].sort((a,b)=>{
      const sa = lines.slice(0,10).reduce((acc,l)=> acc + (l.split(a).length-1),0);
      const sb = lines.slice(0,10).reduce((acc,l)=> acc + (l.split(b).length-1),0);
      return sb-sa;
    })[0];
    const rows = lines.map(l => l.split(d).map(c=>c.trim()));
    const maxCols = Math.max(...rows.map(r=>r.length));
    const norm = rows.map(r => { const c=r.slice(0,maxCols); while(c.length<maxCols) c.push(""); return c; });
    if (maxCols < 2 || norm.length < 2) return null;
    return norm;
  }
  function renderTable(rows){
    const head = ["#", ...rows[0]];
    const body = rows.slice(1);
    let html = '<table class="data"><thead><tr>';
    head.forEach(h => html += `<th>${escapeHTML(h)}</th>`);
    html += '</tr></thead><tbody>';
    body.forEach((r,i)=>{
      html += '<tr><td>'+(i+1)+'</td>';
      r.forEach(c=> html += `<td>${escapeHTML(c)}</td>`);
      html += '</tr>';
    });
    html += '</tbody></table>';
    return html;
  }
  function maybeRenderTableFromText(text){
    tablaWrap.hidden = true; tablaWrap.innerHTML = "";
    let rows = parseMarkdownTable(text);
    if (!rows){
      const csvBlock = extractCsvBlock(text);
      if (csvBlock) rows = parseDelimited(csvBlock);
    }
    if (!rows) rows = parseDelimited(text);
    if (rows && rows.length>=2 && rows[0].length>=2){
      tablaWrap.innerHTML = renderTable(rows);
      tablaWrap.hidden = false;
      return true;
    }
    return false;
  }

  function tableToRows(table){
    const rows = [];
    const ths = [...table.querySelectorAll("thead th")].map(th=>th.textContent.trim());
    rows.push(ths);
    [...table.querySelectorAll("tbody tr")].forEach(tr=>{
      const r = [...tr.children].map(td => td.textContent.trim());
      rows.push(r);
    });
    return rows;
  }
  function downloadBlob(blob, name){
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = name;
    document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 100);
  }
  function exportPDF(text, table){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:"pt", format:"a4" });
    const margin = 36, width = 523;
    let y = margin;
    const txt = (text||"") + (text ? "\n\n" : "");
    const lines = doc.splitTextToSize(txt, width);
    if (lines.length){ doc.text(lines, margin, y); y += (lines.length*14)+12; }
    if (table){
      const rows = tableToRows(table);
      doc.setFont(undefined,"bold");
      doc.text(rows[0].join("  |  "), margin, y); y+=16;
      doc.setFont(undefined,"normal");
      for (let i=1;i<rows.length;i++){
        const line = doc.splitTextToSize(rows[i].join(" | "), width);
        if (y + line.length*12 > 800){ doc.addPage(); y = margin; }
        doc.text(line, margin, y); y += line.length*12 + 8;
      }
    }
    doc.save("reporte.pdf");
  }
  function exportDOC(text, table){
    let html = `<h2>Resultado</h2>`;
    if (text) html += `<p>${escapeHTML(text).replace(/\n/g,"<br>")}</p>`;
    if (table) html += table.outerHTML;
    const blob = new Blob(
      [`<!DOCTYPE html><html><head><meta charset="utf-8"></head><body>${html}</body></html>`],
      { type: "application/msword" }
    );
    downloadBlob(blob, "reporte.doc");
  }
  function exportCSV(table, text){
    let csv = "";
    if (table){
      const rows = tableToRows(table);
      csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
    }else{
      csv = `"Texto"\n"${(text||"").replace(/"/g,'""')}"\n`;
    }
    downloadBlob(new Blob([csv], {type: "text/csv;charset=utf-8"}), "reporte.csv");
  }

  /* =========================
     Enviar y render
  ========================== */
  function wantsTable(q){
    const s = (q||"").toLowerCase();
    return TABLE_WORDS.some(w => s.includes(w));
  }
  function cleanResponseText(t){
    return String(t||"").replace(/^\s*analizando\s+(csv|pdf).*$/gim, "").trim();
  }

  async function enviarPregunta(){
    const qRaw = pregunta.value.trim();
    if(!qRaw) return alert("Escribe una pregunta.");
    stopSpeak();
    const forceTable = wantsTable(qRaw);

    respuesta.textContent = "Consultando...";
    tablaWrap.hidden = true; tablaWrap.innerHTML = "";

    const ctx = pdfContextText ? `\n\nREFERENCIAS (no mostrar):\n${pdfContextText}` : "";
    saveCtx(qRaw);

    let data=null, lastErr=null;
    for (const base of API_ENDPOINTS){
      try{
        const url = `${base}?q=${encodeURIComponent(qRaw + ctx)}&file=${encodeURIComponent(CSV_FILE)}`;
        const r = await fetch(url);
        if(!r.ok) throw new Error(`HTTP ${r.status}`);
        data = await r.json();
        break;
      }catch(e){ lastErr=e; }
    }
    if(!data){ respuesta.textContent = "No se pudo contactar al servidor."; console.error(lastErr); return; }

    const textRaw = data.text || data.respuesta || "No se encontr칩 respuesta.";
    const texto = cleanResponseText(textRaw);

    if (forceTable){
      const ok = maybeRenderTableFromText(texto);
      if (ok){ respuesta.textContent = "Puede exportar su informaci칩n."; }
      else   { respuesta.textContent = texto + "\n\nPuede exportar su informaci칩n."; }
    }else{
      respuesta.textContent = texto + "\n\nPuede exportar su informaci칩n.";
      tablaWrap.hidden = true; tablaWrap.innerHTML = "";
    }

    speakAuto(respuesta.textContent || "");
  }

  pregunta.addEventListener("keydown", (e)=>{
    if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); enviarPregunta(); }
  });
  btnEnviar.addEventListener("click", enviarPregunta);
  btnMic.addEventListener("click", startDictation);

  btnExport.addEventListener("click", ()=>{
    const which = formatSel.value;
    const table = tablaWrap.hidden ? null : tablaWrap.querySelector("table");
    const text = (respuesta.textContent||"").replace(/\s*Puede exportar su informaci칩n\.\s*$/,"").trim();
    if (which==="pdf") exportPDF(text, table);
    else if (which==="doc") exportDOC(text, table);
    else exportCSV(table, text);
  });
  btnStop.addEventListener("click", stopSpeak);
  btnClear.addEventListener("click", ()=>{
    stopSpeak(); pregunta.value=""; respuesta.textContent="";
    tablaWrap.hidden=true; tablaWrap.innerHTML="";
  });

  ensureVoice();
})();
</script>

</body>
</html>
