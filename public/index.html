<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Evitar cacheo del HTML -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- Sello de versión para verificar que ves la última actualización -->
  <script>
    console.log("CSV-GPT Frontend build: 2025-09-18 09:15 (v6)");
  </script>

  <title>CSV-GPT Backend · Demo</title>

  <style>
    :root {
      --bg:#0d1117; --panel:#161b22; --text:#e6edf3; --muted:#8b949e; --accent:#2f81f7; --card:#0f1420;
      --ok:#2ea043; --warn:#d29922; --err:#f85149;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    a{color:var(--accent);text-decoration:none}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns:1fr 2fr 1fr;gap:16px}
    .card{background:var(--panel);border:1px solid #222b36;border-radius:16px;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
    .logo-box{display:flex;align-items:center;justify-content:center;height:100%}
    .logo{max-width:100%;max-height:120px;opacity:.9;filter:drop-shadow(0 6px 12px rgba(0,0,0,.35))}
    .center{display:flex;flex-direction:column;gap:12px}
    .video-wrap{display:flex;justify-content:center;align-items:center;background:linear-gradient(180deg,#0f1420 0%,#0b1020 100%);border:1px solid #1d2530;border-radius:16px;padding:12px}
    video{width:100%;max-width:736px;border-radius:12px;display:block}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .toolbar input[type="text"]{flex:1 1 600px;background:#0f1420;border:1px solid #273142;border-radius:10px;color:var(--text);padding:12px 14px;outline:none}
    .toolbar button{background:var(--accent);color:white;border:0;border-radius:10px;padding:12px 14px;font-weight:600;cursor:pointer}
    .toolbar button.secondary{background:#273142}
    .toolbar select{background:#0f1420;border:1px solid #273142;border-radius:10px;color:var(--text);padding:12px 14px}
    .iconbtn{display:flex;align-items:center;gap:8px}
    .status{font-size:12px;color:var(--muted)}
    .answer{white-space:pre-wrap;line-height:1.4;background:var(--card);border:1px solid #1b2432;border-radius:12px;padding:12px}
    .tbl{width:100%;border-collapse:collapse;margin:10px 0;border:1px solid #283142;border-radius:8px;overflow:hidden}
    .tbl th,.tbl td{padding:8px 10px;border-bottom:1px solid #283142;text-align:left;font-size:13px}
    .tbl th{background:#131a25;font-weight:600}
    .small{font-size:12px;color:var(--muted)}
    .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .badge{font-size:12px;background:#192234;border:1px solid #223049;padding:4px 8px;border-radius:999px}
    .danger{background:#3a0f16;border-color:#5a1a26}
    .grow{flex:1}
    .sep{height:1px;background:#273142;margin:8px 0}
    .pill{padding:4px 8px;border-radius:999px;border:1px solid #273142;background:#0f1420;font-size:12px}
    .big-mic{width:36px;height:36px}
    .mic-on{background:#1f6feb !important; box-shadow:0 0 0 3px rgba(47,129,247,.25) inset}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="grid">
      <!-- Izquierda: logo -->
      <div class="card logo-box">
        <img class="logo" src="left.png" alt="Logo izquierdo" onerror="this.style.opacity=0.3;this.alt='Logo izquierdo (faltante)';" />
      </div>

      <!-- Centro: video + controles -->
      <div class="center">
        <div class="card video-wrap">
          <video id="video" src="descarga.mp4" controls preload="metadata" muted></video>
        </div>

        <div class="card">
          <div class="toolbar">
            <!-- Mic con dictado es-MX -->
            <button id="micBtn" class="secondary iconbtn" title="Dictar pregunta por voz (es-MX)">
              <svg class="big-mic" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                <path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 1 0-6 0v5a3 3 0 0 0 3 3zm5-3a5 5 0 1 1-10 0H5a7 7 0 0 0 14 0h-2zM11 19v3h2v-3h-2z"/>
              </svg>
              <span id="micLabel">Dictar</span>
            </button>

            <input id="q" type="text" placeholder="Escribe o dicta tu pregunta…" />
            <button id="askBtn">Preguntar</button>
            <button id="stopVoiceBtn" class="secondary">Detener voz</button>

            <select id="exportSel">
              <option value="" selected>Exportar…</option>
              <option value="doc">Word (.doc)</option>
              <option value="odt">OpenDocument (.odt)</option>
              <option value="xls">Excel (.xls)</option>
            </select>

            <button id="clearMemBtn" class="danger">Limpiar memoria</button>
            <span class="badge" id="voiceBadge">Voz: es-MX (femenina)</span>
            <span class="pill" id="modelBadge">Modelo: gpt-5</span>
          </div>
          <div class="row small">
            <span id="status" class="status">Listo.</span>
            <span class="grow"></span>
            <span class="small">Backend: <strong>https://csv-gpt-backend.vercel.app/api/ask</strong></span>
          </div>
        </div>

        <div class="card">
          <div class="answer" id="answer">La respuesta aparecerá aquí.</div>
          <div id="tables"></div>
        </div>
      </div>

      <!-- Derecha: logo -->
      <div class="card logo-box">
        <img class="logo" src="right.png" alt="Logo derecho" onerror="this.style.opacity=0.3;this.alt='Logo derecho (faltante)';" />
      </div>
    </div>
  </div>

  <script>
    // Config
    const API_BASE = "https://csv-gpt-backend.vercel.app";
    const DEFAULT_FILE = "decimo.csv";
    const PREFERRED_MODEL = "gpt-5";

    const AUTO_PLAY_VIDEO_WHEN_SPEAKS = true;
    const AUTO_PAUSE_VIDEO_AT_END = true;

    // Referencias UI
    const $q = document.getElementById('q');
    const $ask = document.getElementById('askBtn');
    const $ans = document.getElementById('answer');
    const $tables = document.getElementById('tables');
    const $status = document.getElementById('status');
    const $video = document.getElementById('video');
    const $voiceBadge = document.getElementById('voiceBadge');
    const $exportSel = document.getElementById('exportSel');
    const $clearMem = document.getElementById('clearMemBtn');
    const $micBtn = document.getElementById('micBtn');
    const $micLabel = document.getElementById('micLabel');

    $video.muted = true; // Siempre inicia silenciado

    // Sesión con contexto (10 min)
    const SESSION_TTL_MS = 10 * 60 * 1000;
    function newSessionId() {
      return 'sess_' + Math.random().toString(36).slice(2) + '_' + Date.now();
    }
    function getSession() {
      const saved = JSON.parse(localStorage.getItem('session') || '{}');
      const now = Date.now();
      if (!saved.id || (now - saved.lastUsedAt) > SESSION_TTL_MS) {
        const fresh = { id: newSessionId(), startedAt: now, lastUsedAt: now, history: [] };
        localStorage.setItem('session', JSON.stringify(fresh));
        return fresh;
      }
      return saved;
    }
    function touchSession(sess) {
      sess.lastUsedAt = Date.now();
      localStorage.setItem('session', JSON.stringify(sess));
    }
    function pushHistory(role, text) {
      const sess = getSession();
      sess.history.push({ role, text, t: Date.now() });
      if (sess.history.length > 16) sess.history.shift();
      touchSession(sess);
    }
    function buildContext() {
      const sess = getSession();
      const recent = sess.history.slice(-12);
      const lines = recent.map(h => `${h.role === 'user' ? 'Usuario' : 'Asistente'}: ${h.text}`);
      return lines.join('\n').slice(-1500);
    }

    // -------- VOZ FEMENINA FIJA es-MX --------
    const FEMALE_HINTS_POS = ["Dalia","Larissa","Elena","Lucia","Helena","Camila","Mia","Paloma","Valentina","Female","Femenina","Mujer"];
    const MALE_HINTS_NEG = ["Male","Masculina","Hombre","Diego","Jorge","Juan","Miguel","Javier","Manuel"];

    let FIXED_VOICE = null;
    function scoreVoice(v) {
      let s = 0;
      const lang = (v.lang||"").toLowerCase();
      const name = (v.name||"").toLowerCase();
      if (lang === "es-mx") s += 120;
      else if (lang.startsWith("es-")) s += 60;
      if (FEMALE_HINTS_POS.some(h => name.includes(h.toLowerCase()))) s += 80;
      if (MALE_HINTS_NEG.some(h => name.includes(h.toLowerCase()))) s -= 120;
      return s;
    }
    function findVoice() {
      const voices = speechSynthesis.getVoices();
      const sorted = [...voices].sort((a,b)=>scoreVoice(b)-scoreVoice(a));
      return sorted[0] || null;
    }
    speechSynthesis.onvoiceschanged = () => {
      FIXED_VOICE = findVoice();
      if (FIXED_VOICE) {
        localStorage.setItem("fixedVoiceURI", FIXED_VOICE.voiceURI);
        $voiceBadge.textContent = `Voz: ${FIXED_VOICE.lang} (${FIXED_VOICE.name})`;
      }
    };

    // Limpiar asteriscos para que no los lea
    function cleanForTTS(text) {
      return text.replace(/```[\s\S]*?```/g, "")
                 .replace(/\*\*/g, "")
                 .replace(/\*/g, "")
                 .replace(/^[\s•\-–·]\s*/gm, "")
                 .trim();
    }

    function speak(text) {
      if (!text) return;
      speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(cleanForTTS(text));
      if (FIXED_VOICE) u.voice = FIXED_VOICE;
      u.lang = "es-MX";
      u.onstart = () => { if (AUTO_PLAY_VIDEO_WHEN_SPEAKS) $video.play(); };
      u.onend = () => { if (AUTO_PAUSE_VIDEO_AT_END) $video.pause(); };
      speechSynthesis.speak(u);
    }

    // -------- CONSULTA AL BACKEND --------
    async function ask(query) {
      const sess = getSession();
      const context = buildContext();
      const composed = context ? `Contexto:\n${context}\n\nPregunta:\n${query}` : query;
      const url = `${API_BASE}/api/ask?q=${encodeURIComponent(composed)}&file=${DEFAULT_FILE}&model=${PREFERRED_MODEL}&session=${sess.id}`;

      $status.textContent = "Consultando…";
      try {
        const res = await fetch(url);
        const data = await res.json();
        const raw = data.answer || data.result || JSON.stringify(data, null, 2);

        // Mostrar en pantalla
        $ans.textContent = raw;
        speak(raw); // Voz

        pushHistory('user', query);
        pushHistory('assistant', raw);

        $status.textContent = "Listo.";
      } catch {
        $status.textContent = "Error al consultar.";
      }
    }

    $ask.addEventListener('click', ()=> {
      if ($q.value.trim()) ask($q.value.trim());
    });

    $q.addEventListener('keydown', e => { if (e.key === 'Enter') $ask.click(); });

  </script>
</body>
</html>
