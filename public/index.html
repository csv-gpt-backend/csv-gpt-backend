<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Consulta Educativa</title>

<!-- PDF.js para extraer texto de PDFs en el navegador (silencioso) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<!-- jsPDF para exportar a PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  :root{
    --accent:#0078d7;
    --soft:#f5f6f8;
    --border:#e3e6ee;
    --radius:14px;
    --shadow:0 6px 24px rgba(0,0,0,.06);
    --maxw: 1080px;
  }
  *{ box-sizing:border-box; }
  body{
    margin:0;
    font-family: system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    color:#111;
    background:#fff;
  }
  .topbar{
    display:flex; align-items:center; justify-content:space-between;
    gap:16px; padding:14px 18px; border-bottom:1px solid var(--border);
  }
  .brand{ display:flex; align-items:center; gap:12px; }
  .brand img{ height:46px; display:block; }

  .wrap{ max-width: var(--maxw); margin: 16px auto 32px; padding: 0 14px; }

  /* Video centrado y moderado */
  .video-box{ display:flex; justify-content:center; margin: 10px auto 16px; }
  video{
    max-width: 900px; /* ajusta si quieres m√°s grande/peque√±o */
    width: 100%;
    height: auto;
    border-radius: 12px;
    box-shadow: var(--shadow);
  }

  .askbar{
    display:flex; gap:12px; align-items:flex-start; margin-top: 6px;
  }
  .askbar textarea{
    flex:1 1 auto;
    min-height: 56px; /* 2‚Äì3 l√≠neas */
    max-height: 160px;
    resize: vertical;
    padding: 12px 14px;
    border:1px solid var(--border);
    border-radius: var(--radius);
    font-size: 16px;
    line-height: 1.35;
    box-shadow: var(--shadow);
  }
  .btn{
    border:0; background:var(--accent); color:#fff;
    font-weight:600; border-radius:10px;
    padding: 12px 16px; cursor:pointer;
    white-space:nowrap; box-shadow: var(--shadow);
  }
  .btn.secondary{
    background:#fff; color:#111; border:1px solid var(--border);
  }
  .btn:disabled{ opacity:.6; cursor:not-allowed; }

  .answer{
    margin-top:14px; background: var(--soft);
    border:1px solid var(--border); border-radius: var(--radius);
    padding: 14px; min-height:60px; box-shadow: var(--shadow);
    white-space:pre-wrap;
  }

  .table-wrap{
    margin-top: 14px; background:#fff; border:1px solid var(--border);
    border-radius: var(--radius); overflow:auto; box-shadow: var(--shadow);
  }
  table.data{ width:100%; border-collapse:collapse; font-size:14px; }
  table.data thead th{
    position: sticky; top:0; background:#f3f5f7;
    border-bottom:1px solid #dee1e6; text-align:left; padding:10px 8px;
    font-weight:700; white-space:nowrap;
  }
  table.data tbody td{
    border-top:1px solid #f0f2f5; padding:8px 8px; vertical-align:top;
  }
  table.data tbody tr:nth-child(odd){ background:#fafbfc; }

  .exportbar{
    display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    margin-top: 14px;
  }
  select{
    border:1px solid var(--border); border-radius:10px;
    padding:10px 12px; font-size:14px; background:#fff;
  }

  @media (max-width: 700px){
    .askbar{ flex-direction: column; }
    .askbar .btns{ display:flex; gap:8px; }
  }
</style>
</head>
<body>

  <div class="topbar">
    <div class="brand"><img src="/left.png" alt="SANTILLANA"></div>
    <div class="brand"><img src="/right.png" alt="COMPARTIR"></div>
  </div>

  <div class="wrap">

    <div class="video-box">
      <video id="video" muted playsinline preload="metadata">
        <source src="https://xsmr71ubix2w6tve.public.blob.vercel-storage.com/OLIVIA%20IN%20CASUAL.mp4" type="video/mp4">
        Tu navegador no soporta video.
      </video>
    </div>

    <div class="askbar">
      <textarea id="pregunta" placeholder=""></textarea>
      <div class="btns" style="display:flex; flex-direction:column; gap:8px;">
        <button id="btnEnviar" class="btn">Enviar</button>
        <button id="btnMic" class="btn secondary" title="Dictar por voz">üé§ Voz</button>
      </div>
    </div>

    <div id="respuesta" class="answer">Aqu√≠ aparecer√° la explicaci√≥n...</div>
    <div id="tabla" class="table-wrap" hidden></div>

    <div class="exportbar">
      <select id="format">
        <option value="pdf">Exportar PDF</option>
        <option value="doc">Exportar Word</option>
        <option value="csv">Exportar CSV</option>
      </select>
      <button id="btnExport" class="btn">Exportar</button>
      <button id="btnStop" class="btn secondary">Detener voz</button>
      <button id="btnClear" class="btn secondary">Limpiar</button>
    </div>

  </div>

<script>
(() => {
  // ==========================
  // CONFIG
  // ==========================
  const CSV_FILE = "decimo.csv";
  const API_ENDPOINTS = ["/api/ask", "/api/preguntar"]; // fallback
  const PDF_URLS = [
    "https://csv-gpt-backend.vercel.app/lexium.pdf",
    "https://csv-gpt-backend.vercel.app/evaluaciones.pdf"
  ];
  const MEMORY_MS = 10 * 60 * 1000; // 10 min
  const MAX_PDF_TEXT_CHARS = 3000;  // resumen local de PDFs

  // Palabras que indican que el usuario QUIERE TABLA/LISTA
  const TABLE_WORDS = ["lista","listado","listar","enlista","enlistar","tabla","cuadro","table","cuadros"];

  // ==========================
  // UI refs
  // ==========================
  const pregunta = document.getElementById("pregunta");
  const respuesta = document.getElementById("respuesta");
  const tablaWrap = document.getElementById("tabla");
  const btnEnviar = document.getElementById("btnEnviar");
  const btnMic = document.getElementById("btnMic");
  const btnExport = document.getElementById("btnExport");
  const btnStop = document.getElementById("btnStop");
  const btnClear = document.getElementById("btnClear");
  const video = document.getElementById("video");
  const formatSel = document.getElementById("format");

  // ==========================
  // MEMORIA (oculta)
  // ==========================
  const MEMKEY = "ctx:last";
  function saveCtx(q) {
    try { localStorage.setItem(MEMKEY, JSON.stringify({ q, ts: Date.now() })); } catch {}
  }
  function loadCtx() {
    try{
      const raw = localStorage.getItem(MEMKEY);
      if(!raw) return null;
      const obj = JSON.parse(raw);
      if(Date.now() - obj.ts > MEMORY_MS) return null;
      return obj.q || null;
    }catch{ return null }
  }

  // ==========================
  // VOZ ‚Äî TTS (leer) y STT (dictar)
  // ==========================
  // --- selector de voz femenina es (persistente + ?voice=)
  const VOICE_WHITELIST = [
    "Microsoft Sabina Online (Natural) - Spanish (Mexico)",
    "Microsoft Sabina - Spanish (Mexico)",
    "Google espa√±ol (Latinoam√©rica)",
    "Google espa√±ol de Estados Unidos",
    "Dalia","Sabina","Beatriz","Abril","Camila","Lucia","Paulina","Monica","Lupe"
  ];
  const FEMALE_HINTS = ["female","mujer","femenina","dalia","sabina","beatriz","abril","camila","lucia","paola","valentina","monica","paulina"];
  const MALE_HINTS   = ["male","hombre","jorge","liberto","pablo","diego","miguel","enrique","hugo","carlos","alonso","manuel"];
  let chosenVoice = null;
  function scoreVoice(v){
    const name = (v.name||"").toLowerCase();
    const lang = (v.lang||"").toLowerCase();
    let s = 0;
    if (lang.startsWith("es-mx")) s += 120;
    else if (lang.startsWith("es-419")) s += 80;
    else if (lang.startsWith("es")) s += 50;
    if (VOICE_WHITELIST.some(t => name.includes(t.toLowerCase()))) s += 70;
    if (/(natural|neural|online)/i.test(name)) s += 30;
    if (FEMALE_HINTS.some(t => name.includes(t))) s += 40;
    if (MALE_HINTS.some(t => name.includes(t))) s -= 80;
    return s;
  }
  function pickVoice() {
    const voices = window.speechSynthesis?.getVoices?.() || [];
    if (!voices.length) return null;
    const urlForce = new URLSearchParams(location.search).get("voice");
    const saved = localStorage.getItem("voiceName");
    const target = (urlForce || saved || "").toLowerCase();
    if (target){
      const v = voices.find(v => (v.name||"").toLowerCase().includes(target));
      if (v) return v;
    }
    for (const t of VOICE_WHITELIST){
      const v = voices.find(v => (v.name||"").toLowerCase().includes(t.toLowerCase()));
      if (v) return v;
    }
    return voices.slice().sort((a,b)=> scoreVoice(b)-scoreVoice(a))[0] || voices[0];
  }
  function ensureVoiceSelected(){
    if (!chosenVoice){
      chosenVoice = pickVoice();
      if (chosenVoice) localStorage.setItem("voiceName", chosenVoice.name);
    }
  }
  window.speechSynthesis.onvoiceschanged = () => { chosenVoice = null; ensureVoiceSelected(); };

  function sanitizeSpeakText(t){
    return String(t||"")
      .replace(/\*\*/g,"").replace(/\*/g,"") // quita asteriscos
      .replace(/[_`>#]/g,"")                 // limpia markdown
      .replace(/\s{2,}/g," ")
      .trim();
  }
  function speakAuto(text){
    if(!window.speechSynthesis) return;
    stopSpeak();
    ensureVoiceSelected();
    const u = new SpeechSynthesisUtterance(sanitizeSpeakText(text));
    if (chosenVoice) u.voice = chosenVoice;
    u.lang = chosenVoice?.lang?.startsWith("es") ? chosenVoice.lang : "es-MX";
    u.rate = 1.12; u.pitch = 1.02; u.volume = 1.0;
    u.onstart = ()=> video?.play?.();
    u.onend   = ()=> video?.pause?.();
    u.onerror = ()=> video?.pause?.();
    window.speechSynthesis.speak(u);
  }
  function stopSpeak(){
    try{ window.speechSynthesis?.cancel?.(); }catch{}
    try{ video?.pause?.(); }catch{}
  }

  // Dictado (üé§) ‚Üí llena la pregunta y env√≠a
  function startDictation(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR){ alert("Tu navegador no soporta reconocimiento de voz."); return; }
    const rec = new SR();
    rec.lang = "es-MX"; rec.interimResults = false; rec.maxAlternatives = 1;
    rec.onresult = (e)=>{
      const t = e.results[0][0].transcript;
      pregunta.value = t;
      enviarPregunta();
    };
    rec.onerror = (e)=>{
      alert("Error de micr√≥fono: " + e.error + "\nVe al candado del navegador y permite el micr√≥fono para este sitio.");
    };
    rec.start();
  }

  // ==========================
  // PDFs (carga oculta ‚Üí contexto)
  // ==========================
  let pdfContextText = "";
  async function loadPDFText(url){
    try{
      const loadingTask = pdfjsLib.getDocument({ url });
      const pdf = await loadingTask.promise;
      let all = "";
      for (let i=1;i<=pdf.numPages;i++){
        const page = await pdf.getPage(i);
        const c = await page.getTextContent();
        const txt = c.items.map(it=> it.str).join(" ");
        all += txt + "\n";
        if (all.length > MAX_PDF_TEXT_CHARS) break;
      }
      return all.slice(0, MAX_PDF_TEXT_CHARS);
    }catch(e){
      console.warn("PDF error", url, e);
      return "";
    }
  }
  async function preloadPDFs(){
    const parts = await Promise.all(PDF_URLS.map(loadPDFText));
    pdfContextText = parts.filter(Boolean).join("\n\n").slice(0, MAX_PDF_TEXT_CHARS);
  }
  preloadPDFs(); // silencioso

  // ==========================
  // Helpers tabla y export
  // ==========================
  function escapeHTML(s){ return String(s||"").replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
  function parseMarkdownTable(text){
    const lines = text.split(/\r?\n/).map(l=>l.trim());
    const md = lines.filter(l => /^\|.*\|$/.test(l));
    if (md.length < 2) return null;
    const rows = md.map(l=>{
      const cells = l.replace(/^\|/,"").replace(/\|$/,"").split("|").map(c=>c.trim());
      return cells;
    });
    const sepIdx = rows.findIndex(r => r.every(c => /^:?-{3,}:?$/.test(c)));
    if (sepIdx >= 0) rows.splice(sepIdx,1);
    return rows.length >= 2 ? rows : null;
  }
  function extractCsvBlock(text){
    const m = text.match(/```(?:csv)?\s*([\s\S]*?)```/i);
    return m ? m[1].trim() : null;
  }
  function parseDelimited(text){
    const lines = text.split(/\r?\n/).filter(l=>l.trim().length);
    if (lines.length < 2) return null;
    const d = [",",";","\t","|"].sort((a,b)=>{
      const sa = lines.slice(0,10).reduce((acc,l)=> acc + (l.split(a).length-1),0);
      const sb = lines.slice(0,10).reduce((acc,l)=> acc + (l.split(b).length-1),0);
      return sb-sa;
    })[0];
    const rows = lines.map(l => l.split(d).map(c=>c.trim()));
    const maxCols = Math.max(...rows.map(r=>r.length));
    const norm = rows.map(r => {
      const copy = r.slice(0, maxCols);
      while(copy.length<maxCols) copy.push("");
      return copy;
    });
    if (maxCols < 2 || norm.length < 2) return null;
    return norm;
  }
  function renderTable(rows){
    // agrega columna de numeraci√≥n
    const head = ["#", ...rows[0]];
    const body = rows.slice(1);
    let html = '<table class="data"><thead><tr>';
    head.forEach(h => html += `<th>${escapeHTML(h)}</th>`);
    html += '</tr></thead><tbody>';
    body.forEach((r,i)=>{
      html += '<tr><td>'+(i+1)+'</td>';
      r.forEach(c=> html += `<td>${escapeHTML(c)}</td>`);
      html += '</tr>';
    });
    html += '</tbody></table>';
    return html;
  }
  function maybeRenderTableFromText(text){
    tablaWrap.hidden = true; tablaWrap.innerHTML = "";
    let rows = parseMarkdownTable(text);
    if (!rows){
      const csvBlock = extractCsvBlock(text);
      if (csvBlock) rows = parseDelimited(csvBlock);
    }
    if (!rows){
      rows = parseDelimited(text);
    }
    if (rows && rows.length>=2 && rows[0].length>=2){
      tablaWrap.innerHTML = renderTable(rows);
      tablaWrap.hidden = false;
      return true;
    }
    return false;
  }

  // export helpers
  function tableToRows(table){
    const rows = [];
    const ths = [...table.querySelectorAll("thead th")].map(th=>th.textContent.trim());
    rows.push(ths);
    [...table.querySelectorAll("tbody tr")].forEach(tr=>{
      const r = [...tr.children].map(td => td.textContent.trim());
      rows.push(r);
    });
    return rows;
  }
  function downloadBlob(blob, name){
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = name;
    document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 100);
  }
  function exportPDF(text, table){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:"pt", format:"a4" });
    const margin = 36, width = 523; // 595-2*36
    let y = margin;

    const txt = (text||"") + (text ? "\n\n" : "");
    const lines = doc.splitTextToSize(txt, width);
    if (lines.length){
      doc.text(lines, margin, y);
      y += (lines.length * 14) + 12;
    }
    if (table){
      const rows = tableToRows(table);
      doc.setFont(undefined,"bold");
      doc.text(rows[0].join("  |  "), margin, y); y+=16;
      doc.setFont(undefined,"normal");
      for (let i=1;i<rows.length;i++){
        const line = doc.splitTextToSize(rows[i].join(" | "), width);
        if (y + line.length*12 > 800){ doc.addPage(); y = margin; }
        doc.text(line, margin, y); y += line.length*12 + 8;
      }
    }
    doc.save("reporte.pdf");
  }
  function exportDOC(text, table){
    let html = `<h2>Resultado</h2>`;
    if (text) html += `<p>${escapeHTML(text).replace(/\n/g,"<br>")}</p>`;
    if (table) html += table.outerHTML;
    const blob = new Blob(
      [`<!DOCTYPE html><html><head><meta charset="utf-8"></head><body>${html}</body></html>`],
      { type: "application/msword" }
    );
    downloadBlob(blob, "reporte.doc");
  }
  function exportCSV(table, text){
    let csv = "";
    if (table){
      const rows = tableToRows(table);
      csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
    }else{
      csv = `"Texto"\n"${(text||"").replace(/"/g,'""')}"\n`;
    }
    const blob = new Blob([csv], {type: "text/csv;charset=utf-8"});
    downloadBlob(blob, "reporte.csv");
  }

  // ==========================
  // L√≥gica de env√≠o y render (sin duplicados)
  // ==========================
  function wantsTable(q){
    const s = (q||"").toLowerCase();
    return TABLE_WORDS.some(w => s.includes(w));
  }
  function cleanResponseText(t){
    // quita cualquier l√≠nea que diga "analizando ..." por si el backend lo incluyera
    return String(t||"").replace(/^\s*analizando\s+(csv|pdf).*$/gim, "").trim();
  }

  async function enviarPregunta(){
    const qRaw = pregunta.value.trim();
    if(!qRaw) return alert("Escribe una pregunta.");
    stopSpeak();
    const forceTable = wantsTable(qRaw);

    respuesta.textContent = "Consultando...";
    tablaWrap.hidden = true; tablaWrap.innerHTML = "";

    // Adjuntar contexto de PDFs (silencioso)
    const ctx = pdfContextText ? `\n\nREFERENCIAS (no mostrar):\n${pdfContextText}` : "";
    saveCtx(qRaw);

    let data = null, lastErr = null;
    for (const base of API_ENDPOINTS){
      try{
        const url = `${base}?q=${encodeURIComponent(qRaw + ctx)}&file=${encodeURIComponent(CSV_FILE)}`;
        const r = await fetch(url);
        if(!r.ok) throw new Error(`HTTP ${r.status}`);
        data = await r.json();
        break;
      }catch(e){ lastErr = e; }
    }
    if(!data){
      respuesta.textContent = "No se pudo contactar al servidor.";
      console.error(lastErr); return;
    }

    const textRaw = data.text || data.respuesta || "No se encontr√≥ respuesta.";
    const texto = cleanResponseText(textRaw);

    // Mostrar tabla SOLO si el usuario lo pidi√≥ (palabras clave)
    if (forceTable){
      const ok = maybeRenderTableFromText(texto);
      if (ok){
        // no duplicar texto si se present√≥ tabla
        respuesta.textContent = "Puede exportar su informaci√≥n.";
      }else{
        // el modelo no devolvi√≥ tabla: dejamos texto + nota
        respuesta.textContent = texto + "\n\nPuede exportar su informaci√≥n.";
      }
    }else{
      // Mostrar texto corrido (aunque el modelo haya enviado tabla)
      respuesta.textContent = texto + "\n\nPuede exportar su informaci√≥n.";
      tablaWrap.hidden = true; tablaWrap.innerHTML = "";
    }

    // Leer en voz alta el texto visible (no la tabla cruda)
    speakAuto(respuesta.textContent || "");
  }

  // enter para enviar (Shift+Enter hace salto de l√≠nea)
  pregunta.addEventListener("keydown", (e)=>{
    if(e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      enviarPregunta();
    }
  });
  btnEnviar.addEventListener("click", enviarPregunta);
  btnMic.addEventListener("click", startDictation);

  // Exportar
  btnExport.addEventListener("click", ()=>{
    const which = formatSel.value;
    const table = tablaWrap.hidden ? null : tablaWrap.querySelector("table");
    // Quitamos la l√≠nea final "Puede exportar..." del texto
    const visibleText = (respuesta.textContent||"").replace(/\s*Puede exportar su informaci√≥n\.\s*$/,"").trim();
    if (which === "pdf") exportPDF(visibleText, table);
    else if (which === "doc") exportDOC(visibleText, table);
    else if (which === "csv") exportCSV(table, visibleText);
  });
  btnStop.addEventListener("click", stopSpeak);
  btnClear.addEventListener("click", ()=>{
    stopSpeak();
    pregunta.value = "";
    respuesta.textContent = "";
    tablaWrap.hidden = true; tablaWrap.innerHTML = "";
  });

  // Inicializa voz
  ensureVoiceSelected();
})();
</script>

</body>
</html>
