<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Demo CSV + Voz</title>
  <style>
    html,body{margin:0;background:#fff;color:#111;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    /* 25% - 50% - 25% */
    .grid{display:grid;grid-template-columns:1fr 2fr 1fr;gap:16px;padding:16px}
    @media(max-width:1024px){.grid{grid-template-columns:1fr}}
    .col{display:flex;flex-direction:column;gap:16px}
    .side-img{width:100%;height:auto;object-fit:contain}
    .video-wrap{width:100%;border-radius:14px;overflow:hidden;background:#000}
    video{width:100%;height:auto;display:block;border:none;outline:none}
    textarea{width:100%;min-height:96px;resize:vertical;border:1px solid #d1d5db;border-radius:10px;padding:10px 12px;font-size:1rem}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    button{padding:10px 14px;border-radius:10px;font-size:1rem;cursor:pointer}
    .primary{background:#111;color:#fff;border:1px solid #111}
    .secondary{background:#fff;color:#111;border:1px solid #111}
    #texto{white-space:pre-wrap;margin-top:6px}
    table{border-collapse:collapse;width:100%}
    th,td{padding:8px 10px;border-bottom:1px solid #eee;text-align:left}
    th{font-weight:600}
    .num{width:48px;text-align:right}
  </style>
</head>
<body>
  <div class="grid">
    <!-- 25% izquierda: UNA sola imagen grande -->
    <div class="col">
      <img src="/left.png" alt="Imagen izquierda" class="side-img" onerror="this.style.display='none'">
    </div>

    <!-- 50% centro: SOLO el video arriba y luego la UI -->
    <div class="col">
      <div class="video-wrap">
        <video id="videoMain" playsinline muted preload="metadata" poster="/right.png"
               src="https://xsmr71ubix2w6tve.public.blob.vercel-storage.com/OLIVIA%20IN%20CASUAL.mp4"></video>
      </div>

      <textarea id="pregunta" placeholder="Escribe tu consulta (3 l√≠neas)‚Ä¶&#10;‚Ä¢ Puedes dictar con el micr√≥fono.&#10;‚Ä¢ Pide listas/rankings/tablas y c√°lculos."></textarea>

      <div class="row">
        <button class="primary" id="btnPreguntar" onclick="enviarPregunta()">Preguntar</button>
        <button class="secondary" id="btnDictar" onclick="toggleDictado()">üé§ Dictar</button>
        <button class="secondary" id="btnSilencio" onclick="toggleVoz()">üîä Silenciar voz</button>
        <button class="secondary" onclick="detenerVoz()">‚èπÔ∏è Detener voz</button>
        <button class="secondary" onclick="limpiar()">üßπ Limpiar</button>
        <button class="secondary" onclick="exportarPDF()">üìÑ Exportar PDF</button>
        <button class="secondary" onclick="exportarCSV()">üìä Exportar Excel</button>
      </div>

      <div id="texto" class="muted">Escribe o dicta una consulta y te mostrar√© los resultados.</div>
      <div id="respuesta"></div>
    </div>

    <!-- 25% derecha: UNA sola imagen grande -->
    <div class="col">
      <img src="/right.png" alt="Imagen derecha" class="side-img" onerror="this.style.display='none'">
    </div>
  </div>

  <script>
    // ===== Config =====
    const DEFAULT_FILE = "decimo.csv";
    const API = (q) => `/api/ask?q=${encodeURIComponent(q)}&file=${encodeURIComponent(DEFAULT_FILE)}&format=json`;
    const LONG_THRESHOLD = 800; // si la respuesta supera esto, el video sigue reproduci√©ndose

    // ===== Video =====
    const vid = () => document.getElementById("videoMain");
    function playVideo(){ const v=vid(); if(!v) return; v.play().catch(()=>{}); }
    function pauseVideo(){ const v=vid(); if(!v) return; if(!v.paused) v.pause(); }

    // ===== TTS (voz femenina es-MX si est√°) =====
    let VOICE_ON = true, VOICES=[], VOZ=null, DICTANDO=false;
    function cargarVoces(){
      return new Promise(resolve=>{
        const s=window.speechSynthesis; if(!s){resolve([]);return;}
        let vs=s.getVoices(); if(vs&&vs.length){VOICES=vs;resolve(vs);return;}
        const once=()=>{vs=s.getVoices(); VOICES=vs; resolve(vs); s.removeEventListener('voiceschanged',once);};
        s.addEventListener('voiceschanged',once);
        setTimeout(()=>{vs=s.getVoices(); VOICES=vs; resolve(vs);},1200);
      });
    }
    function elegirVoz(voices){
      const prefer=["Sabina","Paulina","Lupe","Luciana","Conchita","Helena","Google espa√±ol"];
      let v=voices.find(v=>/es(-|_)mx/i.test(v.lang)&&prefer.some(n=>v.name.toLowerCase().includes(n.toLowerCase())));
      if(v) return v;
      v=voices.find(v=>/es(-|_)mx/i.test(v.lang)); if(v) return v;
      v=voices.find(v=>/^es/i.test(v.lang)&&prefer.some(n=>v.name.toLowerCase().includes(n.toLowerCase())));
      return v || voices.find(v=>/^es/i.test(v.lang)) || voices[0] || null;
    }
    async function speak(text){
      if(!VOICE_ON || !window.speechSynthesis) return;
      const voices = VOICES.length? VOICES : await cargarVoces();
      VOZ = VOZ || elegirVoz(voices);
      const u = new SpeechSynthesisUtterance(String(text).replace(/\*/g,""));
      if(VOZ){ u.voice=VOZ; u.lang=VOZ.lang; } else { u.lang="es-MX"; }
      u.onstart = ()=> playVideo();
      u.onend   = ()=>{
        const t=document.getElementById("texto"), r=document.getElementById("respuesta");
        const len=(t?.innerText||"").length+(r?.innerText||"").length;
        if(len>LONG_THRESHOLD) playVideo(); else pauseVideo();
      };
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }
    function toggleVoz(){
      VOICE_ON=!VOICE_ON;
      document.getElementById("btnSilencio").textContent = VOICE_ON ? "üîä Silenciar voz" : "üîà Activar voz";
      if(!VOICE_ON) detenerVoz();
    }
    function detenerVoz(){ try{ window.speechSynthesis.cancel(); pauseVideo(); }catch(e){} }

    // ===== Dictado fiable (start/stop) =====
    let recog=null;
    function toggleDictado(){
      const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
      if(!SR){ alert("Este navegador no soporta dictado por voz."); return; }
      if(DICTANDO){ recog.stop(); return; }
      recog = new SR(); recog.lang="es-MX"; recog.interimResults=false; recog.maxAlternatives=1;
      recog.onresult = (ev)=>{
        const txt=ev.results[0][0].transcript||"";
        const ta=document.getElementById("pregunta");
        ta.value = (ta.value?ta.value+" ":"") + txt;
        enviarPregunta();
      };
      recog.onstart = ()=>{ DICTANDO=true; document.getElementById("btnDictar").textContent="‚èπÔ∏è Detener dictado"; };
      recog.onend   = ()=>{ DICTANDO=false; document.getElementById("btnDictar").textContent="üé§ Dictar"; };
      recog.onerror = ()=>{ DICTANDO=false; document.getElementById("btnDictar").textContent="üé§ Dictar"; };
      recog.start();
    }

    // ===== Render =====
    function ocultarTexto(){ const t=document.getElementById("texto"); if(t){ t.style.display="none"; t.textContent=""; } }
    function mostrarTexto(msg){ const t=document.getElementById("texto"); if(t){ t.style.display=""; t.textContent=msg; } }
    function renderTabla(rows, query){
      ocultarTexto();
      const cont=document.getElementById("respuesta"); cont.innerHTML="";
      const headers=Object.keys(rows[0]||{});
      const norm=h=>String(h).normalize("NFD").replace(/\p{Diacritic}/gu,"").toUpperCase();

      // Detectar columnas
      const nameCol = headers.find(h=>/^(NOMBRE|ESTUDIANTE|ALUMNO)$/i.test(norm(h))) ||
                      headers.find(h=>/NOMBRE|ESTUDIANTE|ALUMNO/i.test(norm(h))) || headers[0];
      const qn = norm(query||"");
      const scoreCols = headers.filter(h=>{
        const H=norm(h);
        if(/PROMEDIO|NOTA|PUNTAJE|SCORE|CALIFICACION|CALIFICACION|TOTAL/.test(H)) return true;
        if(/AGRESION|EMPATIA|TIMIDEZ|AUTOESTIMA|FISICO|TENSION|ANSIEDAD/.test(H) && /AGRES|EMPAT|TIMIDEZ|AUTOEST|FISIC|TENSION|ANSIEDAD/.test(qn)) return true;
        return false;
      });
      if(!scoreCols.length){
        // pick 1-2 num√©ricas
        const numeric = headers.filter(h=>rows.some(r=>!isNaN(parseFloat(String(r[h]).replace(",",".")))));
        scoreCols.push(...numeric.slice(0,2));
      }

      // Construir tabla
      const table=document.createElement("table");
      const thead=document.createElement("thead"), trh=document.createElement("tr");
      ["#", nameCol, ...scoreCols].forEach(h=>{ const th=document.createElement("th"); th.textContent=h; trh.appendChild(th); });
      thead.appendChild(trh); table.appendChild(thead);
      const tbody=document.createElement("tbody");
      rows.forEach((r,i)=>{
        const tr=document.createElement("tr");
        const tdN=document.createElement("td"); tdN.className="num"; tdN.textContent=String(i+1); tr.appendChild(tdN);
        const tdName=document.createElement("td"); tdName.textContent=r[nameCol]??""; tr.appendChild(tdName);
        for(const c of scoreCols){ const td=document.createElement("td"); td.textContent=r[c]??""; tr.appendChild(td); }
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      cont.appendChild(table);
    }

    // ===== Exportar =====
    function exportarPDF(){
      const w=window.open("","_blank");
      const html=`<html><head><title>Exportar PDF</title>
      <style>body{font-family:Arial;padding:16px}table{border-collapse:collapse;width:100%}th,td{border-bottom:1px solid #ddd;padding:6px 8px;text-align:left}</style>
      </head><body>${document.getElementById("respuesta").innerHTML}</body></html>`;
      w.document.write(html); w.document.close(); w.focus(); w.print();
    }
    function exportarCSV(){
      const table=document.querySelector("#respuesta table"); if(!table){ alert("No hay una tabla para exportar."); return; }
      let csv=""; table.querySelectorAll("tr").forEach(tr=>{
        const cols=[...tr.children].map(td=>`"${String(td.textContent).replace(/"/g,'""')}"`);
        csv += cols.join(",")+"\n";
      });
      const blob=new Blob([csv],{type:"text/csv;charset=utf-8"}); const a=document.createElement("a");
      a.href=URL.createObjectURL(blob); a.download="resultado.csv"; a.click(); URL.revokeObjectURL(a.href);
    }
    function limpiar(){
      detenerVoz();
      document.getElementById("pregunta").value="";
      document.getElementById("respuesta").innerHTML="";
      mostrarTexto("Listo para una nueva consulta.");
      pauseVideo();
    }

    // ===== L√≥gica principal =====
    async function enviarPregunta(){
      detenerVoz(); // por si estaba hablando
      const q=(document.getElementById("pregunta").value||"").trim();
      if(!q) return;
      document.getElementById("respuesta").innerHTML="";
      mostrarTexto("Procesando‚Ä¶");

      try{
        const r=await fetch(API(q)); let data=null, txt="";
        try{ data=await r.json(); }catch{ txt=await r.text(); }

        if(data && data.error){
          mostrarTexto("No hay resultados con esos criterios.");
          speak("No hay resultados con esos criterios.");
          return;
        }

        const rows = data?.rows;
        if(Array.isArray(rows) && rows.length){
          renderTabla(rows, q);  // tabla numerada sin texto duplicado
          const phrase = data?.speak || `Mostrando ${rows.length} resultados.`;
          speak(phrase);
          return;
        }

        const msg = data?.speak || txt || "No hay resultados.";
        mostrarTexto(msg);
        speak(msg);

      }catch(e){
        mostrarTexto("Ocurri√≥ un problema al procesar la consulta.");
        speak("Ocurri√≥ un problema al procesar la consulta.");
      }
    }

    // Enviar con Enter (Enter = enviar; Shift+Enter = salto)
    document.getElementById("pregunta").addEventListener("keydown", e=>{
      if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); enviarPregunta(); }
    });

    // Prime audio/voz tras primer gesto (necesario en algunos navegadores)
    window.addEventListener("click",()=>{ cargarVoces(); const v=vid(); if(v){ v.muted=true; v.play().then(()=>v.pause()).catch(()=>{});} },{once:true});
  </script>
</body>
</html>
