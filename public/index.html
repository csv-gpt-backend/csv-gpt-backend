<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Consulta Educativa</title>

  <!-- Librer√≠as para exportar -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      /* Ajustes finos */
      --accent: #0a63ff;
      --video-maxw: 1024px;   /* ancho m√°ximo del video */
      --video-pad: 8px;
      --radius: 14px;
      --shadow: 0 10px 30px rgba(0,0,0,.12);
      --debug-outline: 0; /* 1 para ver bordes verdes de depuraci√≥n */
    }

    *{ box-sizing: border-box; }
    html, body{
      margin:0; padding:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      color:#0b0f14; background:#fff;
    }

    .page{
      width: min(1180px, 100%);
      margin: 0 auto;
      padding: 14px;
    }

    /* Encabezado logos + video */
    .header{
      display:flex; align-items:center; justify-content:space-between;
      gap:16px; margin:8px 0 10px;
    }
    .brand { height:44px; }
    .brand.right{ height:46px; }

    /* Video */
    .video-wrap{
      display:flex; justify-content:center; margin: 2px auto 10px;
    }
    .video-wrap video{
      width: calc(100% - 10px);
      max-width: var(--video-maxw);
      height:auto; border-radius: 12px;
      box-shadow: var(--shadow);
      outline: calc(var(--debug-outline) * 2px) solid #12d66b;
    }

    /* Barra de interacci√≥n */
    .bar{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      margin: 14px auto 6px;
      width:min(100%, var(--video-maxw));
    }
    .bar textarea{
      flex:1 1 680px; padding:12px 14px;
      resize: vertical;
      min-height: 52px; max-height: 120px;
      border:1px solid #d8e0ea; border-radius: var(--radius);
      outline:none; box-shadow: var(--shadow);
    }
    .btn{
      appearance:none; border:0; cursor:pointer;
      background: var(--accent); color:#fff; border-radius: 12px;
      font-weight:700; padding: 12px 18px; box-shadow: var(--shadow);
      transition: transform .03s ease;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn.ghost{
      background:#f3f6fa; color:#0b0f14; font-weight:600;
    }
    .btn.mic{
      display:flex; gap:8px; align-items:center;
      font-size:16px;
    }
    .btn[disabled]{ opacity:.7; cursor:not-allowed; }

    /* Respuesta */
    .answer{
      width:min(100%, var(--video-maxw));
      margin: 8px auto 8px;
      background:#f7f9fc; border:1px solid #e5e9f2; border-radius: 12px;
      padding: 12px; min-height: 64px;
      line-height: 1.5; white-space: pre-wrap;
      outline: calc(var(--debug-outline) * 2px) dashed #2ecc71;
    }

    .table-wrap{
      width:min(100%, var(--video-maxw));
      margin:10px auto 14px; background:#fff;
      border:1px solid #e5e9f2; border-radius: 12px; overflow:auto;
      box-shadow: var(--shadow);
      outline: calc(var(--debug-outline) * 2px) dashed #2ecc71;
    }
    table.data{
      width:100%; border-collapse:collapse; font-size:14px;
    }
    thead th{
      position:sticky; top:0;
      background:#f1f5fb; border-bottom:1px solid #e5e9f2;
      text-align:left; padding:10px 8px; white-space:nowrap; font-weight:800;
    }
    tbody td{
      border-top:1px solid #f1f5fb; padding:8px 8px; vertical-align:top;
    }
    tbody tr:nth-child(odd){ background:#fafcff; }

    /* Botonera inferior */
    .actions{
      width:min(100%, var(--video-maxw)); margin: 10px auto 26px;
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    select{
      appearance:none; border:1px solid #d8e0ea; border-radius: 12px;
      padding: 10px 12px; background:#fff; box-shadow: var(--shadow);
    }

    .note{
      width:min(100%, var(--video-maxw));
      margin: 2px auto 24px; color:#6b7788; font-size:13px;
      text-align:center;
    }

    /* debug outlines toggle */
    .debug-outline{ outline: calc(var(--debug-outline) * 2px) solid #12d66b; }
  </style>
</head>
<body>
  <div class="page">
    <!-- encabezado -->
    <div class="header">
      <img src="/left.png" alt="Santillana" class="brand">
      <img src="/right.png" alt="COMPARTIR" class="brand right">
    </div>

    <!-- video -->
    <div class="video-wrap">
      <video id="video" muted playsinline preload="metadata" poster="" class="debug-outline">
        <source src="https://xsmr71ubix2w6tve.public.blob.vercel-storage.com/OLIVIA%20IN%20CASUAL.mp4" type="video/mp4">
        Tu navegador no soporta video.
      </video>
    </div>

    <!-- barra -->
    <div class="bar">
      <textarea id="pregunta" placeholder=""></textarea>
      <button id="btnEnviar" class="btn">Enviar</button>
      <button id="btnMic" class="btn mic ghost">
        <span>üéôÔ∏è</span> <span>Voz</span>
      </button>
    </div>

    <!-- respuesta texto -->
    <div id="respuesta" class="answer">Aqu√≠ aparecer√° la explicaci√≥n...</div>
    <!-- respuesta tabla -->
    <div id="tabla" class="table-wrap" hidden></div>

    <!-- acciones -->
    <div class="actions">
      <select id="exportTipo">
        <option value="pdf">Exportar PDF</option>
        <option value="word">Exportar Word</option>
        <option value="excel">Exportar Excel</option>
      </select>
      <button id="btnExport" class="btn">Exportar</button>
      <button id="btnStop" class="btn ghost">Detener voz</button>
      <button id="btnClear" class="btn ghost">Limpiar</button>
    </div>

    <div class="note">La memoria se conserva por ~10 minutos para dar contexto entre preguntas.</div>
  </div>

  <script>
  // =================== CONFIG ===================
  const ENDPOINTS = ["/api/ask"]; // oculto; el backend mezcla CSV y PDFs internamente
  // Forzar voz femenina espa√±ol (M√©xico / LatAm)
  const FEMALE_HINTS = ["female","mujer","femenina","sabina","dalia","beatriz","abril","camila","lucia","paola","valentina"];
  const MALE_HINTS   = ["male","hombre","jorge","liberto","pablo","diego","miguel","enrique","hugo","carlos"];
  let chosenVoice = null;
  let speaking = false;
  // =================================================

  const video   = document.getElementById("video");
  const txtIn   = document.getElementById("pregunta");
  const outBox  = document.getElementById("respuesta");
  const tablaWrap = document.getElementById("tabla");
  const btnEnviar = document.getElementById("btnEnviar");
  const btnMic    = document.getElementById("btnMic");
  const btnStop   = document.getElementById("btnStop");
  const btnClear  = document.getElementById("btnClear");
  const btnExport = document.getElementById("btnExport");
  const exportTipo= document.getElementById("exportTipo");

  // ---------- Voz (TTS) ----------
  function scoreVoice(v){
    const name = (v.name||"").toLowerCase();
    const lang = (v.lang||"").toLowerCase();
    let s = 0;
    if (lang.startsWith("es-mx")) s += 100;
    else if (lang.startsWith("es-419")) s += 70;
    else if (lang.startsWith("es")) s += 40;
    if (FEMALE_HINTS.some(t => name.includes(t))) s += 35;
    if (/(neural|natural|online)/i.test(name)) s += 25;
    if (MALE_HINTS.some(t => name.includes(t))) s -= 60;
    return s;
  }
  function pickSpanishFemale(){
    const voices = window.speechSynthesis?.getVoices?.() || [];
    if (!voices.length) return null;
    const best = voices.slice().sort((a,b)=> scoreVoice(b)-scoreVoice(a))[0];
    return best || voices[0];
  }
  function ensureVoice(){
    if (!chosenVoice) chosenVoice = pickSpanishFemale();
  }
  function speak(text){
    if(!window.speechSynthesis) return;
    stopSpeak();
    ensureVoice();
    const clean = (text||"").replace(/\*/g,"").trim(); // no leer asteriscos
    if (!clean) return;
    const u = new SpeechSynthesisUtterance(clean);
    if (chosenVoice) u.voice = chosenVoice;
    u.lang = chosenVoice?.lang?.startsWith("es") ? chosenVoice.lang : "es-MX";
    u.rate = 1.05; u.pitch = 1.02; u.volume = 1.0;
    u.onstart = ()=>{ speaking = true; try{ video?.play?.(); }catch{} };
    u.onend   = ()=>{ speaking = false; try{ video?.pause?.(); }catch{} };
    u.onerror = ()=>{ speaking = false; try{ video?.pause?.(); }catch{} };
    window.speechSynthesis.speak(u);
  }
  function stopSpeak(){
    if(!window.speechSynthesis) return;
    try{ window.speechSynthesis.cancel(); }catch{}
    speaking = false; try{ video?.pause?.(); }catch{}
  }
  window.speechSynthesis?.addEventListener?.("voiceschanged", ()=>{ chosenVoice = null; ensureVoice(); });

  // Leer autom√°ticamente cuando cambie #respuesta
  let lastSpoken = "";
  const mo = new MutationObserver(()=>{
    const t = outBox.textContent.trim();
    if(t && t !== lastSpoken){
      lastSpoken = t;
      speak(t);
    }
  });
  mo.observe(outBox, {childList:true, subtree:true, characterData:true});

  // ---------- Mic (ASR) ----------
  function startListening(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR){ alert("Tu navegador no soporta reconocimiento de voz."); return; }
    const rec = new SR();
    rec.lang = "es-MX";
    rec.interimResults = false; rec.maxAlternatives = 1;
    rec.onresult = e=>{
      const t = e.results?.[0]?.[0]?.transcript || "";
      if(t){
        txtIn.value = t;
        enviarPregunta();
      }
    };
    rec.onerror = e=>{
      alert("Error de micr√≥fono: " + e.error + "\nVe al candado del navegador y permite el micr√≥fono para este sitio.");
    };
    rec.start();
  }
  btnMic.addEventListener("click", startListening);

  // ---------- Tabla helpers ----------
  const escapeHtml = s => String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  function pickDelimiter(sampleLines){
    const cands = [",",";","\t","|"];
    let best = ",", bestScore = -1;
    for (const d of cands){
      let score = 0;
      for (const line of sampleLines){
        const parts = line.split(d);
        if (parts.length > 1) score += parts.length;
      }
      if (score > bestScore){ bestScore = score; best = d; }
    }
    return best;
  }
  function parseMarkdownTable(text){
    const lines = text.split(/\r?\n/).map(l=>l.trim());
    const md = lines.filter(l => /^\|.*\|$/.test(l));
    if (md.length < 2) return null;
    const rows = md.map(l=> l.replace(/^\|/,"").replace(/\|$/,"").split("|").map(c=>c.trim()));
    const sepIdx = rows.findIndex(r => r.every(c => /^:?-{3,}:?$/.test(c)));
    if (sepIdx >= 0) rows.splice(sepIdx,1);
    return rows.length >= 2 ? rows : null;
  }
  function parseJsonTable(text){
    try{
      const obj = JSON.parse(text);
      if (Array.isArray(obj) && obj.length && typeof obj[0] === "object"){
        const headers = Array.from(obj.reduce((s,r)=>{ Object.keys(r).forEach(k=>s.add(k)); return s;}, new Set()));
        return [headers, ...obj.map(o=> headers.map(h=> o[h]??""))];
      }
    }catch{}
    return null;
  }
  function extractCsvBlock(text){
    const m = text.match(/```(?:csv)?\s*([\s\S]*?)```/i);
    return m ? m[1].trim() : null;
  }
  function parseDelimited(text){
    const lines = text.split(/\r?\n/).filter(l=>l.trim().length);
    if (lines.length < 2) return null;
    const sample = lines.slice(0,10);
    const d = pickDelimiter(sample);
    const rows = lines.map(l => l.split(d).map(c=>c.trim()));
    const maxCols = Math.max(...rows.map(r=>r.length));
    const normalized = rows.map(r=>{
      const a = r.slice(0,maxCols);
      while(a.length < maxCols) a.push("");
      return a;
    });
    if (maxCols < 2 || normalized.length < 2) return null;
    return normalized;
  }
  function addNumbering(rows){
    if(!rows || !rows.length) return rows;
    const headers = rows[0].map(h=> String(h).toUpperCase());
    if (!headers.includes("#") && !headers.includes("N¬∞") && !headers.includes("N¬∞.")){
      // Add # column as first
      const newRows = [["#", ...rows[0]]];
      for (let i=1;i<rows.length;i++){
        newRows.push([String(i), ...rows[i]]);
      }
      return newRows;
    }
    return rows;
  }
  function renderTable(rows){
    rows = addNumbering(rows);
    const [head, ...body] = rows;
    let html = '<table class="data"><thead><tr>';
    for (const h of head) html += `<th>${escapeHtml(h)}</th>`;
    html += '</tr></thead><tbody>';
    for (const r of body){
      html += '<tr>';
      for (const c of r) html += `<td>${escapeHtml(c)}</td>`;
      html += '</tr>';
    }
    html += '</tbody></table>';
    return html;
  }
  function maybeRenderTableFromText(text){
    tablaWrap.hidden = true; tablaWrap.innerHTML = "";
    // Intentos: JSON, bloque csv, tabla markdown, delimitado gen√©rico
    let rows = parseJsonTable(text);
    if (!rows){
      const csvBlock = extractCsvBlock(text);
      if (csvBlock) rows = parseDelimited(csvBlock);
    }
    if (!rows) rows = parseMarkdownTable(text);
    if (!rows) rows = parseDelimited(text);

    if (rows && rows.length >= 2 && rows[0].length >= 2){
      tablaWrap.innerHTML = renderTable(rows);
      tablaWrap.hidden = false;
      return true;
    }
    return false;
  }

  // ---------- Export ----------
  function exportar(){
    const tipo = exportTipo.value;
    const container = document.createElement("div");
    // Clonamos explicaci√≥n o tabla (solo uno)
    if (!tablaWrap.hidden) container.appendChild(tablaWrap.cloneNode(true));
    else {
      const p = document.createElement("div");
      p.innerHTML = `<h3>Resultado</h3><div>${escapeHtml(outBox.textContent)}</div>`;
      container.appendChild(p);
    }

    if (tipo === "pdf"){
      const { jsPDF } = window.jspdf;
      html2canvas(container, {scale:2}).then(canvas=>{
        const img = canvas.toDataURL("image/png");
        const pdf = new jsPDF("p","pt","a4");
        // Escalar a ancho de p√°gina
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight= pdf.internal.pageSize.getHeight();
        const imgWidth  = pageWidth - 40;
        const imgHeight = canvas.height * imgWidth / canvas.width;
        let y = 20;
        if (imgHeight < pageHeight){
          pdf.addImage(img, "PNG", 20, y, imgWidth, imgHeight);
        } else {
          // paginar
          let position = 20;
          let heightLeft = imgHeight;
          while (heightLeft > 0){
            pdf.addImage(img, "PNG", 20, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
            if (heightLeft > 0) { pdf.addPage(); position = 0; }
          }
        }
        pdf.save("reporte.pdf");
      });
    } else if (tipo === "word"){
      const html = `
        <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
        <head><meta charset='utf-8'></head>
        <body>${container.innerHTML}</body></html>`;
      const blob = new Blob([html], {type: "application/msword"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "reporte.doc";
      a.click();
      URL.revokeObjectURL(a.href);
    } else if (tipo === "excel"){
      // Convertimos tabla si existe, o texto en una celda
      if (!tablaWrap.hidden){
        const table = tablaWrap.querySelector("table");
        const wb = XLSX.utils.table_to_book(table, {sheet:"Datos"});
        XLSX.writeFile(wb, "reporte.xlsx");
      } else {
        const ws = XLSX.utils.aoa_to_sheet([["Resultado"], [outBox.textContent]]);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Datos");
        XLSX.writeFile(wb, "reporte.xlsx");
      }
    }
  }
  btnExport.addEventListener("click", exportar);

  // ---------- Enviar ----------
  async function enviarPregunta(){
    const q = txtIn.value.trim();
    if(!q){ alert("Escribe una pregunta."); return; }
    outBox.textContent = "Consultando...";
    tablaWrap.hidden = true; tablaWrap.innerHTML = "";

    let data = null, lastErr = null;
    for (const base of ENDPOINTS){
      try{
        const url = `${base}?q=${encodeURIComponent(q)}&file=${encodeURIComponent("decimo.csv")}`;
        const resp = await fetch(url);
        const raw  = await resp.text(); // robusto: primero texto
        let json = null;
        try{ json = JSON.parse(raw); }catch{ /* si viene HTML de error, lo mostramos */ }
        if (!resp.ok){
          outBox.textContent = json?.text || raw || `HTTP ${resp.status}`;
          return;
        }
        data = json || { text: raw };
        break;
      }catch(e){ lastErr = e; }
    }
    if (!data){
      outBox.textContent = "No se pudo contactar al servidor.";
      console.error(lastErr); return;
    }

    const texto = data.text || data.respuesta || "No se encontr√≥ respuesta.";
    // Solo mostramos una cosa: tabla si detecta; si no, texto
    const hasTable = maybeRenderTableFromText(texto);
    outBox.textContent = hasTable ? "" : texto;
  }
  btnEnviar.addEventListener("click", enviarPregunta);
  txtIn.addEventListener("keydown", e=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); enviarPregunta(); }});

  btnStop.addEventListener("click", stopSpeak);
  btnClear.addEventListener("click", ()=>{
    stopSpeak();
    txtIn.value = "";
    outBox.textContent = "Aqu√≠ aparecer√° la explicaci√≥n...";
    tablaWrap.hidden = true; tablaWrap.innerHTML = "";
  });

  // Autoselecci√≥n de voz al cargar
  ensureVoice();
  </script>
</body>
</html>
