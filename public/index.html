<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Consulta Educativa</title>

  <!-- anti-cache mientras reparamos -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
<style>
:root{
  /* sube el header 15%: de 300px a 345px */
  --header-h: 345px;
  --accent:#0078d7;
}

/* ...lo dem√°s igual... */

/* Barra de controles en 2 filas */
.interaction{ padding:18px 12px; }
.bar{
  max-width:1100px;
  margin:0 auto;
}
.bar-row{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  justify-content:center;   /* centrados */
  align-items:center;
  margin-top:8px;
}
.bar-row:first-child{ margin-top:0; }

.bar textarea{
  flex:1 1 700px;
  min-height:84px;
  padding:12px 14px;
  font-size:16px;
  border:1px solid #d0d0d0;
  border-radius:8px;
}

.btn{ padding:12px 14px; border:0; border-radius:8px; background:var(--accent); color:#fff; font-weight:600; cursor:pointer; }
.btn:disabled{ opacity:.6; cursor:not-allowed; }
.btn.alt{ background:#6c757d; }
.btn.warn{ background:#ffc107; color:#000; }
.btn.mic{ font-size:18px; line-height:1; }

/* ‚Äúselector‚Äù con look neutro tipo input */
.select{
  padding:10px 12px;
  border:1px solid #d0d0d0;
  border-radius:8px;
  font-size:15px;
  background:#fff; color:#111;
}

  </style>
  <style>
    :root{ --header-h: 300px; --accent:#0078d7; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:system-ui, Arial; color:#111; background:#fff; }

    /* Encabezado 20/60/20 */
    .header-rail{ display:flex; align-items:center; justify-content:center; height:var(--header-h); }
    .header-rail .col{ display:flex; justify-content:center; align-items:center; height:100%; padding:0 8px; overflow:hidden; }
    .header-rail .left,.header-rail .right{ flex:0 0 20%; }
    .header-rail .center{ flex:0 0 60%; }
    .header-rail img{ max-height:100%; max-width:100%; object-fit:contain; }
    .header-rail video{ height:100%; max-width:100%; object-fit:contain; }

    /* Barra simple, estable */
    .interaction{ padding:18px 12px; }
    .bar{ display:flex; gap:8px; align-items:flex-start; max-width:1100px; margin:0 auto; flex-wrap:wrap; }
    .bar textarea{ flex:1 1 700px; min-height:84px; padding:12px 14px; font-size:16px; border:1px solid #d0d0d0; border-radius:8px; }
    .btn{ padding:12px 14px; border:0; border-radius:8px; background:var(--accent); color:#fff; font-weight:600; cursor:pointer; }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    .btn.alt{ background:#6c757d; }
    .btn.warn{ background:#ffc107; color:#000; }
    .btn.mic{ font-size:18px; line-height:1; }

    /* Salidas */
    #respuesta{ margin:12px auto 0; width:min(90%,1100px); min-height:64px;
      padding:14px; background:#f7f7f8; border:1px solid #e5e5e7; border-radius:10px; white-space:pre-wrap; }
    .table-wrap{ width:min(95%,1100px); margin:12px auto; border:1px solid #e5e5e7; border-radius:10px; overflow:auto; background:#fff; }
    table{ width:100%; border-collapse:collapse; font-size:14px; }
    thead th{ position:sticky; top:0; background:#f3f5f7; border-bottom:1px solid #dee1e6; padding:8px; text-align:left; }
    tbody td{ border-top:1px solid #f0f2f5; padding:8px; }
  </style>
</head>
<body>
  <!-- HEADER -->
  <div class="header-rail">
    <div class="col left"><img src="/left.png" alt="izq"></div>
    <div class="col center">
      <video id="video" muted playsinline preload="metadata">
        <source src="https://xsmr71ubix2w6tve.public.blob.vercel-storage.com/OLIVIA%20IN%20CASUAL.mp4" type="video/mp4">
      </video>
    </div>
    <div class="col right"><img src="/right.png" alt="der"></div>
  </div>

  <!-- BARRA ESTABLE -->
  <div class="interaction">
    <div class="bar">
      <textarea id="pregunta" placeholder="Escribe o dicta tu pregunta‚Ä¶"></textarea>
      <button class="btn" onclick="enviarPregunta()">‚û§ Enviar</button>
      <button class="btn mic" onclick="startListening()" title="Dictar por voz">üé§ Dictar</button>

      <select id="exportType" class="btn alt" style="background:#fff;color:#111;border:1px solid #d0d0d0;">
        <option value="pdf">PDF (vista previa)</option>
        <option value="csv">CSV (descarga)</option>
        <option value="docx">DOCX (Word)</option>
      </select>
      <button id="btnExportar" class="btn alt" onclick="exportSeleccion()" disabled>‚¨á Exportar</button>

      <button class="btn warn" onclick="reinicioEmergencia()">üö® Reiniciar</button>
      <button class="btn alt" onclick="limpiar()">üßπ Limpiar</button>
    </div>

    <div id="respuesta">Aqu√≠ aparecer√° la respuesta‚Ä¶</div>
    <div id="tabla" class="table-wrap" hidden></div>
    <div id="printable" style="display:none"></div>
  </div>

  <!-- DOCX (opcional; puedes comentarlo si no lo usas hoy) -->
  <script src="https://unpkg.com/docx@8.5.0/build/index.umd.js"></script>

  <script>
    // ===== Config m√≠nima para que funcione YA =====
    const ENDPOINT = "/api/ask";
    const SOURCES = [
      "datos/decimo.csv",
      "documentos/lexium.pdf",
      "documentos/evaluaciones.pdf",
      "documentos/emocionales.pdf"
    ];
    const out = document.getElementById("respuesta");
    const tablaWrap = document.getElementById("tabla");
    const video = document.getElementById("video");
    let lastRows = null;

    // ===== Utilidades UI =====
    function updateExportButton(){
      const btn = document.getElementById("btnExportar");
      const hasTable = Array.isArray(lastRows) && lastRows.length > 1;
      const txt = out?.textContent?.trim() || "";
      btn.disabled = !(hasTable || txt.length > 0);
    }
    function escapeHtml(s){return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;");}

    // ===== Voz b√°sica (misma l√≥gica que ten√≠as) =====
    function sanitizeForSpeech(text){
      if (!text) return "";
      let t = text.replace(/```[\s\S]*?```/g, " "); t = t.replace(/\*/g,"");
      t = t.replace(/^[#>\-\u2022]\s*/gm,""); t = t.replace(/\s{2,}/g," ").trim();
      return t;
    }
    function speak(text){
      try{
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(sanitizeForSpeech(text));
        u.lang = "es-MX"; u.rate = 1.12; u.pitch = 1.02;
        u.onstart = ()=> video?.play();
        u.onend   = ()=> video?.pause();
        window.speechSynthesis.speak(u);
      }catch{}
    }
    function stopSpeech(){ try{ window.speechSynthesis.cancel(); }catch{} try{ video?.pause(); }catch{} }

    // ===== Parse m√≠nimo para CSV en bloque ```csv ... ``` =====
    function extractCsvBlock(text){
      const m = text.match(/```(?:csv)?\s*([\s\S]*?)```/i); return m ? m[1].trim() : null;
    }
    function parseDelimited(csvText){
      const lines = csvText.split(/\r?\n/).filter(Boolean);
      if (lines.length<2) return null;
      const cand=[",",";","\t","|"]; let best=",",score=0,cols=0;
      for (const d of cand){
        let good=0,c=null;
        for (const line of lines.slice(0,20)){ const p=line.split(d); if(p.length<2)continue; if(c==null)c=p.length; if(p.length===c)good++; }
        if (good>score){ score=good; best=d; cols=c||0; }
      }
      if (score<2||cols<2) return null;
      const rows = lines.map(l=>l.split(best).map(c=>c.trim()));
      const max = Math.max(...rows.map(r=>r.length));
      return rows.map(r=>{const a=r.slice(0,max); while(a.length<max)a.push(""); return a;});
    }
    function renderTable(rows){
      const [head,...body]=rows;
      let html='<table><thead><tr>'+head.map(h=>`<th>${escapeHtml(h)}</th>`).join("")+'</tr></thead><tbody>';
      for(const r of body){ html+='<tr>'+r.map(c=>`<td>${escapeHtml(c)}</td>`).join("")+'</tr>'; }
      html+='</tbody></table>'; return html;
    }

    // ===== Exportaci√≥n =====
    function exportSeleccion(){
      const tipo = document.getElementById("exportType").value;
      if (tipo==="pdf") return exportPDF();
      if (tipo==="csv") return exportCSV();
      if (tipo==="docx") return exportDOCX();
      alert("Formato no soportado.");
    }
    function exportPDF(){
      const printable = document.getElementById("printable");
      let html = "";
      if (!tablaWrap.hidden){ html = tablaWrap.innerHTML; }
      else { html = `<div style="white-space:pre-wrap;font-family:Arial">${escapeHtml(out.textContent||"")}</div>`; }
      printable.innerHTML = `<h2 style="font-family:Arial">Resultados</h2>${html}`;
      const after = ()=>{ printable.innerHTML=""; window.removeEventListener('afterprint',after); };
      window.addEventListener('afterprint', after);
      setTimeout(after, 3000);
      window.print();
    }
    function exportCSV(){
      if (lastRows && lastRows.length){
        const csv = lastRows.map(r=>r.map(c=>`"${String(c??"").replace(/"/g,'""')}"`).join(",")).join("\r\n");
        descargar(csv,"resultado.csv","text/csv;charset=utf-8"); return;
      }
      const t = out.textContent?.trim()||"";
      if (!t) return alert("No hay datos para exportar.");
      const csv = `#,"Respuesta"\r\n1,"${t.replace(/"/g,'""')}"\r\n`;
      descargar(csv,"resultado.csv","text/csv;charset=utf-8");
    }
    async function exportDOCX(){
      try{
        const { Document, Packer, Paragraph, Table, TableRow, TableCell, WidthType, HeadingLevel } = window.docx;
        const children = [ new Paragraph({ text:"Resultados", heading:HeadingLevel.HEADING_1 }) ];
        if (lastRows && lastRows.length){
          const rows = lastRows.map(r=> new TableRow({ children: r.map(c=> new TableCell({ width:{size:100/r.length,type:WidthType.PERCENTAGE}, children:[new Paragraph(String(c??""))] })) }));
          children.push(new Table({ width:{size:100,type:WidthType.PERCENTAGE}, rows }));
        } else {
          (out.textContent||"Sin datos.").split(/\n/).forEach(line=> children.push(new Paragraph(String(line))));
        }
        const doc = new Document({ sections:[{ children }] });
        const blob = await Packer.toBlob(doc);
        descargarBlob(blob,"resultado.docx");
      }catch(e){ console.error(e); alert("No se pudo generar DOCX."); }
    }
    function descargarBlob(blob, nombre){
      const url=URL.createObjectURL(blob); const a=document.createElement("a");
      a.href=url; a.download=nombre; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }
    function descargar(contenido,nombre,tipo){ descargarBlob(new Blob([contenido],{type:tipo}), nombre); }

    // ===== Micr√≥fono simple =====
    function startListening(){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SR){ alert("Tu navegador no soporta reconocimiento de voz."); return; }
      const rec = new SR(); rec.lang="es-MX"; rec.interimResults=false; rec.maxAlternatives=1;
      rec.onresult = e => { document.getElementById("pregunta").value = e.results[0][0].transcript; enviarPregunta(); };
      rec.onerror  = e => alert("Error de micr√≥fono: "+e.error);
      rec.start();
    }

    // ===== Enviar =====
    async function enviarPregunta(){
      stopSpeech();
      lastRows = null; tablaWrap.hidden = true; tablaWrap.innerHTML = "";
      out.textContent = "Consultando‚Ä¶";

      const q = document.getElementById("pregunta").value.trim();
      const p = new URLSearchParams({ q, ts: Date.now().toString() });
      for (const s of SOURCES) p.append("src", s);

      try{
        const r = await fetch(`${ENDPOINT}?${p.toString()}`, { cache:"no-store" });
        const txt = await r.text();
        let data; try{ data = JSON.parse(txt); }catch{ data = { text: txt||"" }; }

        const texto = data.text || "";
        // intentar detectar bloque CSV y renderizar tabla
        const csvBlock = extractCsvBlock(texto);
        if (csvBlock){
          const rows = parseDelimited(csvBlock);
          if (rows){ lastRows = rows; tablaWrap.innerHTML = renderTable(rows); tablaWrap.hidden = false; out.textContent=""; updateExportButton(); stopSpeech(); return; }
        }
        out.textContent = texto || "Sin respuesta.";
        speak(texto);
      }catch(e){
        console.error(e); out.textContent = "Error de red al contactar el backend.";
      } finally {
        updateExportButton();
      }
    }

    // ===== Limpiar & Reinicio =====
    function limpiar(){
      stopSpeech();
      document.getElementById("pregunta").value = "";
      out.textContent = ""; tablaWrap.hidden = true; tablaWrap.innerHTML = ""; lastRows = null;
      updateExportButton();
    }
    function reinicioEmergencia(){
      try{ window.speechSynthesis.cancel(); }catch{}
      try{ video?.pause(); }catch{}
      try{ localStorage.clear(); }catch{}; try{ sessionStorage.clear(); }catch{};
      limpiar(); alert("Listo. Recarga con Ctrl+F5 si sigue raro.");
    }

    // Enter env√≠a (sin Shift)
    document.getElementById("pregunta").addEventListener("keydown", (e)=>{
      if (e.key==="Enter" && !e.shiftKey){ e.preventDefault(); enviarPregunta(); }
    });

    // Beacon
    console.log("üîî FRONT BUILD ESTABLE");
  </script>
</body>
</html>
