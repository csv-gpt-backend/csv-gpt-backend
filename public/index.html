<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Consulta Educativa</title>

  <style>
    :root {
      --header-height: 260px;
      --video-shift: 5px;
      --accent: #0078d7;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      background: #fff;
      font-family: Arial, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, sans-serif;
      color: #111;
    }

    /* ====== ENCABEZADO 25/50/25 ====== */
    .header-rail {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: var(--header-height);
      background: #fff;
      overflow: hidden;
      border-bottom: 1px solid #ddd;
    }

    .header-rail .col {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
      overflow: hidden;
      padding: 0 8px;
    }

    .header-rail .col.left,
    .header-rail .col.right {
      flex: 0 0 25%;
    }

    .header-rail .col.center {
      flex: 0 0 50%;
      position: relative;
    }

    .header-rail img,
    .header-rail video {
      max-height: 100%;
      max-width: 100%;
      height: auto;
      width: auto;
      object-fit: contain;
      display: block;
    }

    /* ====== INTERACCIÃ“N ====== */
    .interaction {
      padding: 24px 16px;
      text-align: center;
    }

    .bar {
      display: flex;
      gap: 8px;
      justify-content: center;
      align-items: center;
      max-width: 900px;
      margin: 0 auto;
    }

    .bar input[type="text"] {
      flex: 1 1 600px;
      padding: 12px 14px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 8px;
      outline: none;
    }

    .btn {
      padding: 12px 16px;
      border: 0;
      border-radius: 8px;
      background: var(--accent);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
    }

    .btn:hover { filter: brightness(0.95); }

    #respuesta {
      margin: 20px auto 0;
      width: min(90%, 900px);
      min-height: 64px;
      padding: 14px;
      background: #f7f7f8;
      border: 1px solid #e5e5e7;
      border-radius: 10px;
      text-align: left;
      line-height: 1.45;
      white-space: pre-wrap;
      font-size: 15px;
    }

    .footer-bar {
      width: min(95%, 900px);
      margin: 20px auto;
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>

  <!-- ====== ENCABEZADO ====== -->
  <div class="header-rail">
    <div class="col left">
      <img src="/left.png" alt="Logo Izquierda">
    </div>
    <div class="col center">
      <video id="video" autoplay muted loop playsinline>
        <source src="https://xsmr71ubix2w6tve.public.blob.vercel-storage.com/OLIVIA%20IN%20CASUAL.mp4" type="video/mp4">
        Tu navegador no soporta video.
      </video>
    </div>
    <div class="col right">
      <img src="/right.png" alt="Logo Derecha">
    </div>
  </div>

  <!-- ====== INTERACCIÃ“N ====== -->
  <div class="interaction">
    <div class="bar">
      <input id="pregunta" type="text" placeholder="Haz tu pregunta aquÃ­..." />
      <button class="btn" onclick="enviarPregunta()">Enviar</button>
      <button class="btn" onclick="startListening()">ðŸŽ¤</button>
    </div>

    <div id="respuesta">AquÃ­ aparecerÃ¡ la respuesta...</div>

    <div class="footer-bar">
      <button class="btn" onclick="exportPDF()">Exportar PDF</button>
      <button class="btn" onclick="stopSpeech()">Detener voz</button>
      <button class="btn" onclick="limpiar()">Limpiar</button>
    </div>
  </div>

  <!-- ====== SCRIPT PRINCIPAL ====== -->
  <script>
    const ENDPOINT = "/api/ask";
    const DEFAULT_FILE = "datos/decimo.csv";

    const video = document.getElementById("video");
    const out = document.getElementById("respuesta");

    // ====== Voz ======
    let chosenVoice = null;
    function ensureVoiceSelected() {
      const voices = window.speechSynthesis.getVoices();
      if (!voices.length) return null;
      chosenVoice = voices.find(v => v.lang.startsWith("es")) || voices[0];
    }
    window.speechSynthesis.onvoiceschanged = ensureVoiceSelected;

    function speak(text) {
      if (!window.speechSynthesis) return;
      const u = new SpeechSynthesisUtterance(text);
      if (chosenVoice) u.voice = chosenVoice;
      u.lang = "es-MX";
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
      video.play();
      u.onend = () => video.pause();
    }

    function stopSpeech() {
      try { window.speechSynthesis.cancel(); } catch {}
      try { video.pause(); } catch {}
    }

    // ====== Enviar pregunta ======
    async function enviarPregunta() {
      const pregunta = document.getElementById("pregunta").value.trim();
      if (!pregunta) return alert("Escribe una pregunta.");

      out.textContent = "Consultando...";

      const params = new URLSearchParams({ q: pregunta, src: DEFAULT_FILE });
      const resp = await fetch(`${ENDPOINT}?${params.toString()}`);
      const data = await resp.json();

      const texto = data.text || "Sin respuesta.";
      out.textContent = texto;
      speak(texto);
    }

    // ====== Exportar PDF ======
    function exportPDF() {
      const texto = out.textContent || "";
      const win = window.open("", "_blank");
      win.document.write(`<pre>${texto}</pre>`);
      win.print();
    }

    // ====== Limpiar ======
    function limpiar() {
      stopSpeech();
      document.getElementById("pregunta").value = "";
      out.textContent = "AquÃ­ aparecerÃ¡ la respuesta...";
    }

    // ====== MicrÃ³fono ======
    function startListening() {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) return alert("Tu navegador no soporta reconocimiento de voz.");
      const rec = new SR();
      rec.lang = "es-MX";
      rec.onresult = e => {
        const t = e.results[0][0].transcript;
        document.getElementById("pregunta").value = t;
        enviarPregunta();
      };
      rec.start();
    }
  </script>
</body>
</html>
