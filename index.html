<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HHCSV/PDF ‚Üî GPT (MX/EC)</title>
  <style>
    :root{
      --brand:#1f6fff;
      --bg:#fafafa; --card:#fff; --ink:#1b1e23; --muted:#6b7280; --ring:#e5e7eb;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0; font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial; color:var(--ink); background:var(--bg)}

    /* Header sticky con video y logos */
    .hero{ position:sticky; top:0; z-index:50; background:#fff; border-bottom:1px solid var(--ring) }
    .hero-inner{ max-width:1200px; margin:0 auto; padding:16px 20px; display:grid;
      grid-template-columns: 1fr minmax(420px,640px) 1fr; gap:12px; align-items:center }
    .brand,.partner{display:flex; align-items:center; justify-content:center}
    .brand img,.partner img{ max-height:80px; width:auto; object-fit:contain }
    .video-shell{ border-radius:16px; overflow:hidden; border:1px solid var(--ring); background:#000; width:100%; aspect-ratio:16/9 }
    .video-shell video{ width:100%; height:100%; object-fit:cover; display:block }

    .container{ max-width:1200px; margin:24px auto; padding:0 20px }
    .card{ background:var(--card); border:1px solid var(--ring); border-radius:14px; padding:16px }
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center }
    textarea{ width:100%; min-height:74px; padding:12px 14px; border-radius:12px; border:1px solid var(--ring); outline:none; font-size:16px; resize:vertical; background:#fff }
    .btn{ display:inline-flex; align-items:center; gap:8px; padding:10px 16px; border:1px solid var(--ring); border-radius:999px; background:#fff; cursor:pointer; font-weight:600 }
    .btn.primary{ background:var(--brand); color:#fff; border-color:transparent }
    .muted{ color:var(--muted); font-size:14px }
    h3{ margin:0 0 10px 0 }
    .out,.tables{ min-height:64px; padding:12px 14px; border-radius:12px; border:1px dashed var(--ring); background:#fff }
    .tables pre{ white-space:pre-wrap; font-family:ui-monospace,SFMono-Regular,Consolas,monospace }
  </style>
</head>
<body>
  <header class="hero">
    <div class="hero-inner">
      <div class="brand"><img src="/left.png" alt="Santillana" onerror="this.style.opacity=0.2"></div>
      <div class="video-shell">
        <!-- Tu video -->
        <video id="coachVideo" playsinline muted preload="auto" poster="/right.png" crossorigin="anonymous">
          <source src="https://xsmr71ubix2w6tve.public.blob.vercel-storage.com/OLIVIA%20IN%20CASUAL.mp4" type="video/mp4">
        </video>
      </div>
      <div class="partner"><img src="/right.png" alt="Compartir" onerror="this.style.opacity=0.2"></div>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <div class="row" style="margin-bottom:12px">
        <textarea id="q" placeholder="Escribe tu pregunta o usa dictado‚Ä¶"></textarea>
      </div>
      <div class="row">
        <button class="btn primary" id="send">Enviar</button>
        <button class="btn" id="micBtn">üéôÔ∏è Dictado</button>
        <button class="btn" id="muteBtn">üîá Silenciar voz</button>
        <button class="btn" id="clearBtn">üßπ Limpiar</button>
        <button class="btn" id="newBtn">üÜï Nueva sesi√≥n</button>
        <span class="muted" id="status">Listo</span>
      </div>
    </section>

    <section class="card">
      <h3>Respuesta</h3>
      <div id="answer" class="out muted">‚Äî</div>
    </section>

    <section class="card">
      <h3>Tablas y Listas</h3>
      <div id="tables" class="tables muted">‚Äî</div>
    </section>
  </main>

  <script>
    const txt = document.getElementById('q');
    const btnSend = document.getElementById('send');
    const btnMic  = document.getElementById('micBtn');
    const btnMute = document.getElementById('muteBtn');
    const btnClear= document.getElementById('clearBtn');
    const btnNew  = document.getElementById('newBtn');
    const statusEl= document.getElementById('status');
    const out     = document.getElementById('answer');
    const tables  = document.getElementById('tables');
    const video   = document.getElementById('coachVideo');

    // ---- Speech synthesis (voz femenina es-MX si existe)
    const synth = window.speechSynthesis;
    let currentUtter = null;

    function pickSpanishVoice() {
      const voices = synth.getVoices() || [];
      let best = voices.find(v => /es-?MX/i.test(v.lang) || /mex/i.test(v.name));
      if (!best) best = voices.find(v => /^es/i.test(v.lang));
      return best || null;
    }
    function stopSpeaking() {
      if (synth && synth.speaking) try{ synth.cancel(); }catch(_){}
      currentUtter = null;
      try{ video.pause(); }catch(_){}
    }
    function speak(text){
      stopSpeaking();
      if (!text || !('speechSynthesis' in window)) return;
      const u = new SpeechSynthesisUtterance(text);
      u.rate = 1; u.pitch = 1;
      const go = () => {
        const v = pickSpanishVoice();
        if (v) u.voice = v;
        currentUtter = u;
        try{ video.currentTime = 0; video.play().catch(()=>{}); }catch(_){}
        synth.speak(u);
      };
      if (synth.getVoices().length===0) {
        speechSynthesis.onvoiceschanged = () => go();
      } else { go(); }
      u.onend = () => { currentUtter=null; try{ video.pause(); }catch(_){} };
      u.onerror = () => { currentUtter=null; try{ video.pause(); }catch(_){} };
    }

    // ---- Dictado (sin duplicaciones)
    let rec=null, recOn=false;
    function toggleDictado(){
      if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
        alert('Tu navegador no soporta dictado.');
        return;
      }
      const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!rec) {
        rec = new SpeechRec();
        rec.lang = 'es-MX';
        rec.continuous = false; rec.interimResults = false;
        rec.onresult = (e) => {
          const t = e.results[0][0].transcript || '';
          txt.value = (txt.value + ' ' + t).trim();
        };
        rec.onend = ()=>{ recOn=false; statusEl.textContent='Listo'; };
        rec.onerror = ()=>{ recOn=false; statusEl.textContent='Listo'; };
      }
      if (!recOn) { recOn=true; statusEl.textContent='Escuchando‚Ä¶'; rec.start(); }
      else { rec.stop(); recOn=false; statusEl.textContent='Listo'; }
    }

    // ---- Enviar pregunta
    async function send(){
      const question = (txt.value || '').trim();
      if (!question) {
        out.textContent = 'Por favor, escribe una pregunta.'; out.classList.remove('muted');
        return;
      }
      stopSpeaking();
      statusEl.textContent='Consultando‚Ä¶';
      out.textContent = 'Procesando‚Ä¶'; out.classList.add('muted');
      tables.textContent = '‚Äî'; tables.classList.add('muted');

      try{
        const r = await fetch('/api/ask', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ question })
        });
        const data = await r.json();

        const texto = data?.texto || 'No obtuve respuesta.';
        out.textContent = texto; out.classList.remove('muted');

        const md = data?.tablas_markdown || '';
        if (md) { tables.innerHTML = '<pre>'+md+'</pre>'; tables.classList.remove('muted'); }
        else { tables.textContent='‚Äî'; tables.classList.add('muted'); }

        // Voz + video si hay una respuesta real
        if (texto && !/^no obtuve respuesta/i.test(texto)) speak(texto);
        statusEl.textContent='Listo';
      }catch(err){
        console.error(err);
        statusEl.textContent='Error';
        out.textContent='Ocurri√≥ un problema procesando la consulta. Intenta nuevamente.';
      }
    }

    // ---- Botones
    btnSend.onclick = send;
    btnMic.onclick  = toggleDictado;
    btnMute.onclick = stopSpeaking;
    btnClear.onclick= ()=>{ txt.value=''; out.textContent='‚Äî'; out.classList.add('muted'); tables.textContent='‚Äî'; tables.classList.add('muted'); stopSpeaking(); };
    btnNew.onclick  = ()=>{ txt.value=''; stopSpeaking(); out.textContent='‚Äî'; out.classList.add('muted'); tables.textContent='‚Äî'; tables.classList.add('muted'); statusEl.textContent='Listo'; };

    // Autoplay silencioso para ‚Äúdespertar‚Äù el video (algunos navegadores necesitan una primera interacci√≥n, pero esto ayuda)
    document.addEventListener('DOMContentLoaded', ()=>{ try{ video.play().then(()=>video.pause()).catch(()=>{}); }catch(_){ } });
  </script>
</body>
</html>
