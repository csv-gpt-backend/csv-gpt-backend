<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CSV/PDF â‡¢ GPT (MX/EC)</title>
  <style>
    :root{
      --border:#e5e7eb; --muted:#6b7280; --ink:#111827; --accent:#2563eb; --amber:#f59e0b;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:#fff;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans","Helvetica Neue",Arial}
    .page{display:grid;grid-template-rows:auto 1fr;height:100dvh}

    /* PRIMERA PARTE: fija arriba */
    header{position:sticky;top:0;z-index:1000;background:#fff;border-bottom:1px solid var(--border);padding:8px 10px 12px}
    .media-row{display:grid;grid-template-columns:1fr 2fr 1fr;gap:10px;align-items:center}
    .media-row img{width:100%;height:110px;object-fit:contain}
    .media-row video{width:92%;height:110px;object-fit:cover;border-radius:12px;border:none}

    .controls{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:8px}
    textarea{width:min(1100px,98%);height:70px;padding:10px 12px;border-radius:12px;border:1px solid var(--border);font-size:15px;resize:vertical}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#fff;cursor:pointer;font-weight:600}
    .btn:hover{border-color:var(--accent);box-shadow:0 0 0 3px rgba(37,99,235,.12)}
    .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .btn.yellow{background:var(--amber);color:#111;border-color:var(--amber)}
    .btn.mic{font-size:18px;padding:12px 18px}
    select{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#fff;font-weight:600}

    /* SEGUNDA y TERCERA PARTE: scroll propio */
    main{display:grid;grid-template-rows:1fr 1fr;height:calc(100dvh - 230px)}
    .panel{padding:12px;overflow:auto}
    .panel + .panel{border-top:1px solid var(--border)}
    .panel h2{margin:4px 0 10px;font-size:16px;color:var(--muted);font-weight:700;letter-spacing:.2px}
    .result{max-width:1200px;margin:0 auto;line-height:1.55;font-size:15px}
    .result p{margin:0 0 10px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,Monaco,"Liberation Mono","Courier New";font-size:13px;color:#111;background:#fafafa;border:1px dashed var(--border);border-radius:12px;padding:10px}

    .result table{width:100%;border-collapse:collapse;font-size:14px}
    .result th,.result td{border:1px solid var(--border);padding:6px 8px;text-align:left}
    .result th{background:#f8fafc;position:sticky;top:0}
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="media-row">
        <img id="leftImg" alt="left" src="left.png"/>
        <video id="heroVideo" src="https://xsmr71ubix2w6tve.public.blob.vercel-storage.com/OLIVIA%20IN%20CASUAL.mp4" muted playsinline></video>
        <img id="rightImg" alt="right" src="right.png"/>
      </div>

      <div class="controls" style="margin-top:10px">
        <textarea id="question" placeholder="Escribe tu pregunta (o usa dictado)â€¦"></textarea>
      </div>

      <div class="controls">
        <button id="sendBtn" class="btn primary">Enviar</button>
        <button id="micBtn" class="btn mic">ðŸŽ¤ Dictado</button>

        <select id="exportType">
          <option value="pdf">PDF</option>
          <option value="xlsx">XLSX</option>
          <option value="doc">DOC</option>
        </select>
        <button id="exportBtn" class="btn">Exportar</button>

        <button id="muteBtn" class="btn">ðŸ”‡ Silenciar voz</button>
        <button id="clearBtn" class="btn">ðŸ§¹ Limpiar</button>
        <button id="newSessionBtn" class="btn yellow">ðŸ†• Nueva sesiÃ³n</button>
      </div>
    </header>

    <main>
      <section class="panel" id="textPanel">
        <h2>Respuesta</h2>
        <div id="textOutput" class="result"></div>
      </section>

      <section class="panel" id="tablePanel">
        <h2>Tablas y Listas</h2>
        <div id="tableOutput" class="result"></div>
      </section>
    </main>
  </div>

<script>
(() => {
  // ===== Estado y elementos =====
  let sessionId = 'S-' + new Date().toISOString().replace(/[:.]/g,'-');
  let ttsEnabled = true;
  let utter = null;
  const heroVideo   = document.getElementById('heroVideo');
  const questionEl  = document.getElementById('question');
  const textOutput  = document.getElementById('textOutput');
  const tableOutput = document.getElementById('tableOutput');

  // ===== Voz =====
  function stopSpeaking(){ try{ speechSynthesis.cancel(); }catch{} utter=null; heroVideo.pause(); }
  function pickSpanishFemaleVoice(){
    const voices = speechSynthesis.getVoices() || [];
    const prefer = [
      'Microsoft Sabina Online (Natural) - Spanish (Mexico)',
      'Microsoft Dalia Online (Natural) - Spanish (Mexico)',
      'Paulina','Lucia','Conchita','Camila','Lupe'
    ];
    for (const name of prefer){
      const v = voices.find(x => (x.name||'').includes(name));
      if (v) return v;
    }
    const esMx = voices.find(v => /^es[-_]?mx/i.test(v.lang||'')); if (esMx) return esMx;
    const es   = voices.find(v => /^es[-_]?/i.test(v.lang||''));   if (es)   return es;
    return voices[0] || null;
  }
  function speak(text){
    if (!ttsEnabled || !text) return;
    stopSpeaking();
    utter = new SpeechSynthesisUtterance((text||'').replace(/\*/g,''));
    const setV = () => {
      const v = pickSpanishFemaleVoice();
      if (v) utter.voice = v;
      utter.lang = (v && v.lang) || 'es-MX';
      utter.rate = 1; utter.pitch = 1; utter.volume = 1;
      heroVideo.play().catch(()=>{});
      speechSynthesis.speak(utter);
    };
    if (speechSynthesis.getVoices().length) setV();
    else speechSynthesis.onvoiceschanged = setV;

    utter.onend = () => heroVideo.pause();
    utter.onerror = () => heroVideo.pause();
  }

  // ===== Render tablas Markdown simple =====
  function renderTablesMarkdown(md){
    tableOutput.innerHTML = '';
    if (!md || !md.trim()) return;
    const blocks = md.split(/\n{2,}/);
    const html = blocks.map(block=>{
      if (/^\s*\|.+\|\s*$/.test(block) && /---/.test(block)){
        const lines  = block.trim().split(/\n/);
        const header = lines[0].split('|').slice(1,-1).map(s=>s.trim());
        const rows   = lines.slice(2).map(l => l.split('|').slice(1,-1).map(s=>s.trim()));
        const thead  = '<thead><tr>'+header.map(h=>`<th>${h}</th>`).join('')+'</tr></thead>';
        const tbody  = '<tbody>'+rows.map(r=>'<tr>'+r.map(c=>`<td>${c}</td>`).join('')+'</tr>').join('')+'</tbody>';
        return `<table>${thead}${tbody}</table>`;
      }
      if (/\|/.test(block)){
        return `<pre class="mono">${block.replace(/[&<>]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]))}</pre>`;
      }
      return `<p>${block.replace(/\n/g,'<br/>')}</p>`;
    }).join('\n');
    tableOutput.innerHTML = html;
  }

  // ===== Llamada al backend =====
  async function ask(question){
    const q = String(question||'').replace(/\*/g,'').trim();
    if (!q) return;
    textOutput.innerHTML = 'Procesandoâ€¦'; tableOutput.innerHTML = '';
    try{
      const resp = await fetch('/api/ask', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ q })
      });
      if (!resp.ok) throw new Error('Error en API');
      const data = await resp.json();
      const texto = (data.respuesta || data.texto || '').replace(/\*/g,'');
      textOutput.innerHTML = texto.replace(/\n/g,'<br/>');

      // Si el texto parece contener tablas, intenta dibujarlas
      const maybeTables = /\|.+\|/.test(texto) ? texto : '';
      renderTablesMarkdown(maybeTables);

      speak(texto);
    }catch(e){
      stopSpeaking();
      textOutput.innerHTML = 'OcurriÃ³ un problema. Intenta otra vez.';
    }
  }

  // ===== Dictado (una sola vez, sin duplicados) =====
  (function initDictado(){
    const btn = document.getElementById('micBtn');
    if (!btn) return;
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR){ btn.disabled=true; btn.title='Dictado no soportado'; return; }
    const rec = new SR();
    rec.lang='es-MX'; rec.interimResults=false; rec.continuous=false;
    let listening=false;
    btn.addEventListener('click', ()=>{
      if (listening){ rec.stop(); return; }
      listening=true; btn.classList.add('primary');
      rec.start();
      rec.onresult = (e)=>{
        const final = Array.from(e.results).filter(r=>r.isFinal).map(r=>r[0].transcript).join(' ');
        if (final) questionEl.value = (questionEl.value + ' ' + final).trim();
      };
      rec.onerror = ()=>{ listening=false; btn.classList.remove('primary'); };
      rec.onend   = ()=>{ listening=false; btn.classList.remove('primary'); };
    });
  })();

  // ===== Botones =====
  document.getElementById('sendBtn')?.addEventListener('click', ()=> ask(questionEl.value));
  questionEl?.addEventListener('keydown', (e)=>{ if ((e.ctrlKey||e.metaKey)&&e.key==='Enter') ask(questionEl.value); });

  document.getElementById('muteBtn')?.addEventListener('click', ()=>{ ttsEnabled=!ttsEnabled; stopSpeaking(); });
  document.getElementById('clearBtn')?.addEventListener('click', ()=>{ stopSpeaking(); textOutput.innerHTML=''; tableOutput.innerHTML=''; });
  document.getElementById('newSessionBtn')?.addEventListener('click', ()=>{
    stopSpeaking(); sessionId = 'S-' + new Date().toISOString().replace(/[:.]/g,'-');
    textOutput.innerHTML=''; tableOutput.innerHTML=''; questionEl.value='';
  });

  // Exportar (PDF = vista previa/imprimir)
  document.getElementById('exportBtn')?.addEventListener('click', ()=>{
    const type = document.getElementById('exportType')?.value || 'pdf';
    if (type !== 'pdf'){ alert('Para XLSX/DOC usa tu exportador luego. Ahora: PDF con vista previa.'); }
    const w = window.open('', '_blank');
    const html = `
      <!doctype html><html><head><meta charset="utf-8"><title>SesiÃ³n ${sessionId}</title>
      <style>
        body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;padding:16px}
        h1,h2{margin:8px 0} table{width:100%;border-collapse:collapse;font-size:14px}
        th,td{border:1px solid #ddd;padding:6px 8px;text-align:left} th{background:#f8fafc}
      </style></head><body>
        <h1>SesiÃ³n ${sessionId}</h1>
        <h2>Pregunta</h2><pre>${(questionEl.value||'').replace(/[&<>]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]))}</pre>
        <h2>Respuesta</h2><div>${textOutput.innerHTML}</div>
        <h2>Tablas / Listas</h2><div>${tableOutput.innerHTML}</div>
        <script>window.onload=()=>window.print();<\/script>
      </body></html>`;
    w.document.write(html); w.document.close();
  });

  // Precalentar voces (algunas veces vienen vacÃ­as hasta que se llama)
  if ('speechSynthesis' in window) speechSynthesis.getVoices();
})();
</script>
</body>
</html>
