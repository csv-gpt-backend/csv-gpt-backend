<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>VCSV/PDF â†” GPT (MX/EC)</title>

<style>
  :root{
    --bg:#fff; --fg:#111; --muted:#6b7280; --brand:#2563eb; --border:#e5e7eb; --card:#fafafa;
  }
  html,body{height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  *{box-sizing:border-box}

  .wrap{max-width:1160px;margin:0 auto;padding:16px}
  .header-fixed{position:sticky; top:0; z-index:1000; background:var(--bg); border-bottom:1px solid var(--border); transition: box-shadow .2s ease}
  .header-fixed.is-stuck{box-shadow:0 8px 24px -10px rgba(0,0,0,.25)}

  .header-grid{display:grid; grid-template-columns: 1fr min(720px, 70vw) 1fr; align-items:center; gap:16px; padding:8px 0}
  .brand-left img,.brand-right img{max-height:64px;width:auto;display:block}

  .video-shell{border-radius:14px; overflow:hidden; background:#000; aspect-ratio:16/6.5; border:1px solid var(--border)}
  #heroVideo{width:100%; height:100%; object-fit:cover; display:block}

  .card{background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px}
  .row{display:flex; gap:12px; flex-wrap:wrap}
  .grow{flex:1 1 auto}
  .textarea{width:100%; min-height:64px; resize:vertical; border:1px solid var(--border); padding:10px 12px; border-radius:10px; font-size:16px; outline:none}
  .btn{appearance:none; border:1px solid var(--border); background:#fff; color:#111; cursor:pointer; padding:10px 14px; border-radius:10px; font-weight:600; transition:.15s ease}
  .btn:hover{transform:translateY(-1px)} .btn:active{transform:translateY(0)}
  .btn.primary{background:var(--brand); color:#fff; border-color:transparent}
  .muted{color:var(--muted); font-size:14px}
  .section-title{font-weight:700; margin:16px 0 10px}

  #textOutput{white-space:pre-wrap; line-height:1.55}
  #tableOutput{margin-top:8px}
  .table{width:100%; border-collapse:collapse; margin:8px 0; font-size:14px}
  .table th,.table td{border:1px solid var(--border); padding:8px; text-align:left}
  .table th{background:#f4f5f7}

  @media (max-width: 900px){
    .header-grid{grid-template-columns:1fr}
    .brand-left,.brand-right{display:none}
  }
</style>
</head>
<body>

<!-- HEADER pegado con logos y video -->
<header class="header-fixed">
  <div class="wrap header-grid">
    <div class="brand-left"><img src="/left.png" alt="Santillana" /></div>

    <div class="video-shell">
      <!-- Si tienes un video local, colÃ³calo como primer <source>, por ejemplo /lexium.mp4 -->
      <video id="heroVideo" muted playsinline preload="auto" poster="/right.png">
        <source src="/lexium.mp4" type="video/mp4" />
        <!-- Fallback pÃºblico para evitar pantalla negra si no existe lexium.mp4 -->
        <source src="https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4" type="video/mp4" />
      </video>
    </div>

    <div class="brand-right"><img src="/right.png" alt="Compartir" /></div>
  </div>
</header>

<!-- CONSULTA -->
<main class="wrap">
  <div class="card">
    <textarea id="questionInput" class="textarea" placeholder="Escribe tu pregunta o usa el micrÃ³fonoâ€¦"></textarea>
    <div class="row" style="margin-top:10px">
      <button id="sendBtn" class="btn primary">Enviar</button>
      <button id="dictateBtn" class="btn">ðŸŽ¤ Dictado</button>
      <button id="muteBtn" class="btn">ðŸ”‡ Silenciar voz</button>
      <button id="clearBtn" class="btn">ðŸ§¹ Limpiar</button>
      <button id="newSessionBtn" class="btn">ðŸ†• Nueva sesiÃ³n</button>
      <span id="status" class="muted grow"></span>
    </div>
  </div>

  <h3 class="section-title">Respuesta</h3>
  <div id="textOutput" class="card"></div>

  <h3 class="section-title">Tablas y Listas</h3>
  <div id="tableOutput" class="card"></div>
</main>

<script>
/* ---------------- Sticky header con sombra al fijarse ---------------- */
(() => {
  const header = document.querySelector('.header-fixed');
  const s = document.createElement('div');
  s.style.position='absolute'; s.style.top='0'; s.style.width='1px'; s.style.height='1px';
  header.parentElement.insertBefore(s, header);
  const io = new IntersectionObserver((e)=>{
    if(e[0].isIntersecting) header.classList.remove('is-stuck');
    else header.classList.add('is-stuck');
  }, {rootMargin:'-1px 0px 0px 0px'});
  io.observe(s);
})();

/* ---------------- Voz femenina ES-MX (fallback ES) ---------------- */
const TTS = (() => {
  let pref=null;
  function load(){
    const v = speechSynthesis.getVoices() || [];
    pref = v.find(x=>/es[-_]?mx/i.test(x.lang) && /female|mujer/i.test(x.name+x.voiceURI)) ||
           v.find(x=>/es[-_]?mx/i.test(x.lang)) ||
           v.find(x=>/^es/i.test(x.lang)) || null;
  }
  if ('speechSynthesis' in window){ load(); speechSynthesis.onvoiceschanged=load; }

  function speak(text,{rate=.98,pitch=1.02,volume=1,onend}={}){
    try{ speechSynthesis.cancel(); }catch{}
    if (!text) return;
    const u = new SpeechSynthesisUtterance(text);
    if (pref) u.voice=pref; u.lang = (pref && pref.lang) || 'es-MX';
    u.rate=rate; u.pitch=pitch; u.volume=volume;
    u.onend=()=>{ if(onend) onend(); };
    u.onerror=()=>{ if(onend) onend(); };
    speechSynthesis.speak(u);
  }
  function stop(){ try{ speechSynthesis.cancel(); }catch{} }
  return {speak, stop};
})();

/* ---------------- Video sincronizado: play al preguntar, pausa al terminar ---------------- */
const VideoSync = (() => {
  const v = document.getElementById('heroVideo');
  if (!v) return { onAsk(){}, onStop(){} };

  function play(){
    try{ v.muted=true; v.play().catch(()=>{}); }catch{}
  }
  function pause(){ try{ v.pause(); }catch{} }

  return { onAsk: play, onStop: pause };
})();

/* ---------------- Helpers UI ---------------- */
const $ = s=>document.querySelector(s);
const questionEl = $('#questionInput');
const textOut = $('#textOutput');
const tableOut = $('#tableOutput');
const statusEl = $('#status');
function setStatus(m){ statusEl.textContent = m||''; }
function disableUI(d){
  ['sendBtn','dictateBtn','muteBtn','clearBtn','newSessionBtn'].forEach(id=>{
    const b=document.getElementById(id); if(b) b.disabled=!!d;
  });
}

/* ---------------- Render texto y tablas ---------------- */
function renderText(t){ textOut.textContent = t||''; }
function renderTables(html=''){ tableOut.innerHTML = html||''; }

/* ---------------- Llamada al backend ---------------- */
async function askServer(q){
  setStatus('Procesandoâ€¦'); disableUI(true);
  try{
    const r = await fetch('/api/ask', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ question:q })
    });
    const data = await r.json().catch(()=>({}));
    if(!r.ok){
      const msg = data?.texto || `Error ${r.status}`;
      throw new Error(msg);
    }

    const texto = data?.texto || '';
    const tablas = data?.tablas_markdown || '';

    renderText(texto);
    renderTables(tablas);
    setStatus('');

    // Leer en voz y detener video al finalizar la lectura
    TTS.speak(texto, { onend: () => { VideoSync.onStop(); } });

  }catch(err){
    renderText('');
    renderTables('');
    setStatus('OcurriÃ³ un problema procesando la consulta. Intenta nuevamente.');
    console.error(err);
  }finally{
    disableUI(false);
  }
}

/* ---------------- Botones ---------------- */
$('#sendBtn').addEventListener('click', ()=>{
  const q=(questionEl.value||'').trim();
  if(!q){ renderText('Por favor, escribe una pregunta.'); renderTables(''); return; }
  TTS.stop(); VideoSync.onAsk();
  askServer(q);
});
$('#clearBtn').addEventListener('click', ()=>{ questionEl.value=''; renderText(''); renderTables(''); setStatus(''); TTS.stop(); });
$('#muteBtn').addEventListener('click', ()=>{ TTS.stop(); });
$('#newSessionBtn').addEventListener('click', ()=>{ questionEl.value=''; renderText(''); renderTables(''); setStatus('Nueva sesiÃ³n iniciada.'); TTS.stop(); });

/* ---------------- Dictado (auto-envÃ­a al terminar) ---------------- */
(() => {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) return;
  let listening=false, rec=null;

  $('#dictateBtn').addEventListener('click', ()=>{
    if(listening) return;
    rec = new SR();
    rec.lang='es-MX';
    rec.interimResults=false; rec.continuous=false; rec.maxAlternatives=1;
    listening=true; setStatus('ðŸŽ¤ Escuchandoâ€¦');

    rec.onresult = (e)=>{
      const t = e.results?.[0]?.[0]?.transcript || '';
      if(t){
        questionEl.value = questionEl.value ? (questionEl.value+' '+t) : t;
        // auto-envÃ­o
        const q=(questionEl.value||'').trim();
        if(q){ TTS.stop(); VideoSync.onAsk(); askServer(q); }
      }
    };
    rec.onerror = ()=>{ setStatus(''); listening=false; };
    rec.onend = ()=>{ setStatus(''); listening=false; };
    try{ rec.start(); }catch{}
  });
})();

/* ---------------- Arranque: video en pausa hasta preguntar ---------------- */
try{ document.getElementById('heroVideo')?.pause(); }catch{}
</script>
</body>
</html>
