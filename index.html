<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CCSV/PDF ↔ GPT (MX/EC)</title>

<style>
  :root{
    --bg:#fff;
    --fg:#111;
    --muted:#6b7280;
    --brand:#2663ff;
    --border:#e5e7eb;
    --card:#fafafa;
  }
  html,body{height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  *{box-sizing:border-box}

  .wrap{max-width:1160px;margin:0 auto;padding:16px}
  .header-fixed{
    position: sticky; top: 0; z-index: 1000;
    background: var(--bg);
    border-bottom:1px solid var(--border);
    transition: box-shadow 220ms ease, backdrop-filter 220ms ease, border-color 220ms ease;
  }
  .header-fixed.is-stuck{
    box-shadow: 0 6px 22px -12px rgba(0,0,0,.25);
    backdrop-filter: saturate(1.15) blur(3px);
    border-color: rgba(0,0,0,.06);
  }

  .header-grid{
    display:grid; grid-template-columns: 1fr min(720px, 70vw) 1fr;
    align-items:center; gap:16px; padding:8px 0;
  }
  .brand-left img, .brand-right img{max-height:64px; width:auto; display:block}
  .video-shell{
    border-radius:14px; overflow:hidden; background:#000; aspect-ratio:16/6.5;
    border:1px solid var(--border);
  }
  #heroVideo{width:100%; height:100%; object-fit:cover; display:block}

  .card{background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px}
  .row{display:flex; gap:12px; flex-wrap:wrap}
  .grow{flex:1 1 auto}
  .textarea{
    width:100%; min-height:64px; resize:vertical; border:1px solid var(--border);
    padding:10px 12px; border-radius:10px; font-size:16px; outline:none;
  }
  .btn{
    appearance:none; border:1px solid var(--border); background:#fff; color:#111; cursor:pointer;
    padding:10px 14px; border-radius:10px; font-weight:600; transition:.15s ease;
  }
  .btn:hover{transform:translateY(-1px)}
  .btn:active{transform:translateY(0)}
  .btn.primary{background:var(--brand); color:#fff; border-color:transparent}
  .btn.ghost{background:#fff}
  .btn.warn{background:#ffecec; border-color:#fbcaca; color:#a00000}

  .section-title{font-weight:700; margin:16px 0 10px}
  .muted{color:var(--muted); font-size:14px}

  #status{min-height:22px; margin-top:4px; color:var(--muted)}
  #textOutput{white-space:pre-wrap; line-height:1.55}
  #tableOutput{margin-top:8px}

  /* markdown tablas simple */
  .table{width:100%; border-collapse:collapse; margin:8px 0; font-size:14px}
  .table th,.table td{border:1px solid var(--border); padding:8px; text-align:left}
  .table th{background:#f4f5f7}

  /* móvil */
  @media (max-width: 900px){
    .header-grid{grid-template-columns: 1fr}
    .brand-left,.brand-right{display:none}
  }
</style>
</head>
<body>

  <!-- HEADER: logos + video (sticky con sombra al “pegarse”) -->
  <header class="header-fixed">
    <div class="wrap header-grid">
      <div class="brand-left"><img src="left.png" alt="Santillana" /></div>
      <div class="video-shell">
        <video id="heroVideo" autoplay muted playsinline loop preload="auto">
          <!-- usa tu fuente actual, dejo una genérica de ejemplo por si acaso -->
          <source src="lexium.mp4" type="video/mp4" />
        </video>
      </div>
      <div class="brand-right"><img src="right.png" alt="Compartir" /></div>
    </div>
  </header>

  <!-- CONSULTA -->
  <main class="wrap">
    <div class="card">
      <textarea id="questionInput" class="textarea" placeholder="Escribe tu pregunta o usa el micrófono…"></textarea>
      <div class="row" style="margin-top:10px">
        <button id="sendBtn" class="btn primary">Enviar</button>
        <button id="dictateBtn" class="btn ghost">🎤 Dictado</button>
        <button id="muteBtn" class="btn ghost">🔇 Silenciar voz</button>
        <button id="clearBtn" class="btn ghost">🧹 Limpiar</button>
        <button id="newSessionBtn" class="btn ghost">🆕 Nueva sesión</button>
        <span id="status" class="muted grow"></span>
      </div>
    </div>

    <h3 class="section-title">Respuesta</h3>
    <div id="textOutput" class="card"></div>

    <h3 class="section-title">Tablas y Listas</h3>
    <div id="tableOutput" class="card"></div>
  </main>

<script>
/* ----------------------------
   1) Header pegado con sombra
----------------------------- */
(() => {
  const header = document.querySelector('.header-fixed');
  if (!header) return;

  const sentinel = document.createElement('div');
  sentinel.style.position = 'absolute';
  sentinel.style.top = '0'; sentinel.style.left = '0';
  sentinel.style.width = '1px'; sentinel.style.height = '1px';
  header.parentElement.insertBefore(sentinel, header);

  const io = new IntersectionObserver(
    (entries) => {
      const e = entries[0];
      if (e.isIntersecting) header.classList.remove('is-stuck');
      else header.classList.add('is-stuck');
    },
    { rootMargin: `-${(header.offsetTop || 0) + 1}px 0px 0px 0px`, threshold: [0,1] }
  );
  io.observe(sentinel);
})();

/* --------------------------------
   2) Voz femenina (ES-MX / ES-ES)
---------------------------------- */
const TTS = (() => {
  let voices = [];
  let preferredVoice = null;
  let speaking = false;

  const femaleMatches = [
    /es[-_]?mx.*female/i, /mex.*female/i, /es[-_]?mx/i, /spanish.*mexico/i,
    /es[-_]?es.*female/i, /español.*femenina/i, /spanish.*female/i
  ];

  function loadVoices() {
    voices = speechSynthesis.getVoices() || [];
    for (const m of femaleMatches) {
      const v = voices.find(v => m.test(`${v.lang} ${v.name}`));
      if (v) { preferredVoice = v; break; }
    }
    if (!preferredVoice) preferredVoice = voices.find(v => /^es/i.test(v.lang)) || null;
  }

  if ('speechSynthesis' in window) {
    loadVoices();
    window.speechSynthesis.onvoiceschanged = loadVoices;
  }

  function speak(text, { rate=0.98, pitch=1.02, volume=1 } = {}) {
    if (!('speechSynthesis' in window)) return;
    stop();
    if (!text) return;
    const u = new SpeechSynthesisUtterance(text);
    if (preferredVoice) u.voice = preferredVoice;
    u.lang = (preferredVoice && preferredVoice.lang) || 'es-MX';
    u.rate = rate; u.pitch = pitch; u.volume = volume;
    speaking = true;
    u.onend = () => speaking = false;
    u.onerror = () => speaking = false;
    speechSynthesis.speak(u);
  }
  function stop(){ try{ speechSynthesis.cancel(); }catch{} speaking=false; }

  return { speak, stop, get speaking(){ return speaking; } };
})();

/* -------------------------------------------------
   3) Video sincronizado con interacción + lectura
-------------------------------------------------- */
const VideoSync = (() => {
  const video = document.getElementById('heroVideo');
  if (!video) return { onAskStart(){}, onAnswerShown(){} };

  video.muted = true;
  function fadeVolume(target=0.45, ms=350){
    const step=50; const delta=(target-video.volume)/(ms/step); let t=0;
    const iv=setInterval(()=>{ t+=step; let next=video.volume+delta; next=Math.min(1,Math.max(0,next)); video.volume=next; if(t>=ms) clearInterval(iv); }, step);
  }
  async function playSafely(){ try{ await video.play(); }catch(e){} }

  return {
    onAskStart(){ fadeVolume(0.55,400); playSafely(); },
    onAnswerShown(){
      if (TTS.speaking) fadeVolume(0.18,400); else fadeVolume(0.20,400);
      setTimeout(()=>{ try{ video.pause(); }catch{} },1200);
    }
  };
})();

/* -------------------------------------------------------------------
   4) UI helpers
-------------------------------------------------------------------- */
const $ = sel => document.querySelector(sel);
const questionEl = $('#questionInput');
const textOut = $('#textOutput');
const tableOut = $('#tableOutput');
const statusEl = $('#status');

function setStatus(msg){ statusEl.textContent = msg || ''; }
function setDisabled(disabled){
  ['sendBtn','dictateBtn','muteBtn','clearBtn','newSessionBtn'].forEach(id=>{
    const b = document.getElementById(id); if(b) b.disabled = !!disabled;
  });
}

/* -------------------------------------------------------------------
   5) Render de respuesta + markdown tabular simple
-------------------------------------------------------------------- */
function renderText(text){
  textOut.textContent = text || '';
}
function renderTables(md=''){
  // Si backend envía HTML, lo ponemos directo. Si envía markdown simple, puedes parsearlo aquí.
  // Por ahora, asumimos que envía HTML de tablas (o lo dejas vacío).
  tableOut.innerHTML = md || '';
}

/* -------------------------------------------------------------------
   6) Llamada al backend  /api/ask
-------------------------------------------------------------------- */
async function askServer(question){
  setStatus('Procesando…'); setDisabled(true);
  try{
    const r = await fetch('/api/ask', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ question })
    });
    const data = await r.json().catch(()=>({}));
    if (!r.ok){
      throw new Error(data?.texto || 'Hubo un error');
    }
    renderText(data?.texto || '');
    renderTables(data?.tablas_markdown || '');
    setStatus('');

    // 🔊 voz + 🎬 video cuando ya está pintado
    if (window.__onAnswerRendered) window.__onAnswerRendered();

  }catch(err){
    renderText('');
    renderTables('');
    setStatus('Ocurrió un problema procesando la consulta. Intenta nuevamente.');
    console.error(err);
  }finally{
    setDisabled(false);
  }
}

/* Expone para el bloque que habla y ajusta video */
window.__onAnswerRendered = function(){
  const plain = textOut ? textOut.innerText.trim() : '';
  if (plain) TTS.speak(plain, {rate:0.98, pitch:1.02, volume:1});
  VideoSync.onAnswerShown();
};

/* -------------------------------------------------------------------
   7) Botones básicos
-------------------------------------------------------------------- */
$('#sendBtn').addEventListener('click', ()=>{
  const q = (questionEl.value || '').trim();
  if (!q){ renderText('Por favor, escribe una pregunta.'); renderTables(''); return; }
  TTS.stop();
  VideoSync.onAskStart();
  askServer(q);
});

$('#clearBtn').addEventListener('click', ()=>{
  questionEl.value=''; renderText(''); renderTables(''); setStatus('');
  TTS.stop();
});
$('#muteBtn').addEventListener('click', ()=>{ TTS.stop(); try{ $('#heroVideo').volume=0.2; }catch{}; });
$('#newSessionBtn').addEventListener('click', ()=>{
  // Simple: limpia todo. Si luego quieres manejar ID de sesión, aquí.
  questionEl.value=''; renderText(''); renderTables(''); setStatus('Nueva sesión iniciada.');
  TTS.stop();
});

/* -------------------------------------------------------------------
   8) Dictado por voz (sin duplicados, español, un solo resultado)
-------------------------------------------------------------------- */
const SpeechInput = (() => {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  let recognition = null;
  let listening = false;

  function available(){ return !!SR; }

  function start(){
    if (!available()) { alert('Tu navegador no soporta dictado por voz (Web Speech API).'); return; }
    if (listening) return; // evita duplicado
    listening = true; setStatus('🎤 Escuchando…');

    recognition = new SR();
    recognition.lang = 'es-MX';               // preferencia MX
    recognition.interimResults = false;
    recognition.continuous = false;           // una sola frase
    recognition.maxAlternatives = 1;

    recognition.onresult = (e)=>{
      const t = e.results?.[0]?.[0]?.transcript || '';
      if (t){
        questionEl.value = questionEl.value ? (questionEl.value + ' ' + t) : t;
      }
    };
    recognition.onerror = (e)=>{ console.warn('STT error', e.error); };
    recognition.onend = ()=>{ listening=false; setStatus(''); };

    try{ recognition.start(); }catch{}
  }

  function stop(){
    try{ recognition && recognition.stop(); }catch{}
    listening = false; setStatus('');
  }

  return { start, stop, available };
})();

$('#dictateBtn').addEventListener('click', ()=>{
  // toggle simple: si ya escuchando, se ignora; al terminar, onend limpia estado
  SpeechInput.start();
});
</script>
</body>
</html>
