<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>yXCSV/PDF ‚Üî GPT (MX/EC)</title>
<link rel="icon" href="data:," />
<!-- Markdown parser + export libs -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root{
    --bg:#fff; --ink:#111827; --muted:#6b7280; --border:#e5e7eb;
    --accent:#2563eb; --amber:#f59e0b; --danger:#dc2626;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto}
  /* Layout: header fijo + 2 paneles con scroll */
  .page{display:grid;grid-template-rows:auto 1fr;min-height:100dvh}
  header{position:sticky;top:0;z-index:1000;background:#fff;border-bottom:1px solid var(--border);padding:10px 12px}
  /* Fila de medios 25/50/25 */
  .media-row{display:grid;grid-template-columns:1fr 2fr 1fr;gap:12px;align-items:center}
  .media-row img{width:100%;height:110px;object-fit:contain}
  .media-row video{
    width:100%;height:210px; /* ‚Üê video m√°s grande */
    object-fit:cover;border-radius:12px;border:none;background:#000;
  }
  .controls{display:flex;flex-wrap:wrap;justify-content:center;gap:8px;margin-top:10px}
  textarea{width:min(1100px,98%);height:64px;resize:vertical;padding:10px 12px;border:1px solid var(--border);border-radius:12px}
  .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#fff;font-weight:600;cursor:pointer}
  .btn:hover{border-color:var(--accent);box-shadow:0 0 0 3px rgba(37,99,235,.12)}
  .btn.yellow{background:var(--accent);color:#fff;border-color:var(--accent)}
  .btn.yellow{background:var(--amber);border-color:var(--amber);color:#111}
  .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
  select{padding:10px 12px;border:1px solid var(--border);border-radius:12px;font-weight:600}

  main{display:grid;grid-template-rows:1fr 1fr;min-height:0} /* para que los hijos puedan scrollear */
  .panel{padding:12px;overflow:auto}
  .panel + .panel{border-top:1px solid var(--border)}
  .panel h2{margin:0 0 8px;color:var(--muted);font-size:15px;text-transform:uppercase;letter-spacing:.2px}
  #textPanel{max-height:38vh}
  #tablePanel{max-height:38vh}
  .result{max-width:1200px;margin:0 auto;line-height:1.55}
  /* Tabla bonita */
  #tableOutput table{width:100%;border-collapse:collapse;font-size:14px}
  #tableOutput th,#tableOutput td{border:1px solid var(--border);padding:6px 8px;text-align:left}
  #tableOutput th{background:#f8fafc}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:13px;background:#fafafa;border:1px dashed var(--border);border-radius:10px;padding:8px}
</style>
</head>
<body>
<div class="page">
  <header>
    <!-- Medios 25/50/25 fijos arriba -->
    <div class="media-row">
      <img src="/left.png" alt="Left logo">
      <video id="heroVideo" src="https://xsmr71ubix2w6tve.public.blob.vercel-storage.com/OLIVIA%20IN%20CASUAL.mp4" muted playsinline></video>
      <img src="/right.png" alt="Right logo">
    </div>

    <!-- Caja de texto + botones -->
    <div class="controls" style="margin-top:10px">
      <textarea id="question" placeholder="Escribe tu pregunta o usa dictado‚Ä¶"></textarea>
    </div>
    <div class="controls">
      <button id="sendBtn" class="btn primary">Enviar</button>
      <button id="micBtn" class="btn">üé§ Dictado</button>
      <select id="exportType">
        <option value="pdf">PDF</option>
        <option value="xlsx">XLSX</option>
        <option value="doc">DOC</option>
      </select>
      <button id="exportBtn" class="btn">Exportar</button>
      <button id="muteBtn" class="btn">üîá Silenciar voz</button>
      <button id="clearBtn" class="btn">üßπ Limpiar</button>
      <button id="newSessionBtn" class="btn yellow">üÜï Nueva sesi√≥n</button>
    </div>
  </header>

  <main>
    <section class="panel" id="textPanel">
      <h2>Respuesta</h2>
      <div id="textOutput" class="result"></div>
    </section>
    <section class="panel" id="tablePanel">
      <h2>Tablas y Listas</h2>
      <div id="tableOutput" class="result"></div>
    </section>
  </main>
</div>

<script>
(() => {
  // ====== Estado y refs ======
  let sessionId = 'S-' + new Date().toISOString().replace(/[:.]/g,'-');
  let ttsEnabled = true;
  let typing = false;
  const heroVideo = document.getElementById('heroVideo');
  const questionEl = document.getElementById('question');
  const textOutput = document.getElementById('textOutput');
  const tableOutput = document.getElementById('tableOutput');

  // ====== Voz femenina ES (MX/EC) ======
  function pickSpanishFemaleVoice(){
    const v = speechSynthesis.getVoices();
    const pref = [
      'Microsoft Sabina Online (Natural) - Spanish (Mexico)',
      'Microsoft Dalia Online (Natural) - Spanish (Mexico)',
      'Google espa√±ol',
      'Google espa√±ol de Estados Unidos',
      'Conchita','Lucia','Paulina','Lupe','Camila'
    ];
    let c = v.find(x => /es-|es_/.test(x.lang||'') && /female|mujer|woman/i.test(x.name));
    if (c) return c;
    for(const n of pref){ const f=v.find(x=>(x.name||'').includes(n)); if(f) return f; }
    return v.find(x=>(x.lang||'').startsWith('es')) || v[0];
  }
  function speak(text){
    if(!ttsEnabled) return Promise.resolve();
    return new Promise(resolve=>{
      const u = new SpeechSynthesisUtterance(String(text||'').replace(/\*/g,''));
      const set = () => { const v=pickSpanishFemaleVoice(); if(v) u.voice=v; u.lang=(v&&v.lang)||'es-MX'; u.rate=1; u.pitch=1; speechSynthesis.speak(u); heroVideo.play().catch(()=>{}); };
      if(speechSynthesis.getVoices().length) set(); else speechSynthesis.onvoiceschanged=set;
      u.onend=()=>{ if(!typing) heroVideo.pause(); resolve(); };
      u.onerror=()=>{ if(!typing) heroVideo.pause(); resolve(); };
    });
  }

  // ====== UI helpers ======
  async function typeInto(el, text, delay=6){
    typing = true; heroVideo.play().catch(()=>{});
    el.innerHTML = '';
    for(let i=0;i<text.length;i++){
      el.innerHTML += text[i]==='\n' ? '<br/>' : text[i];
      if(i%3===0) await new Promise(r=>setTimeout(r,delay));
    }
    typing = false; heroVideo.pause();
  }

  // ====== Normalizador + Render Markdown ‚Üí HTML ======
  function normalizeMarkdownTables(md){
    if(!md || !md.trim()) return '';
    let m = md.trim();

    // si todo viene en una sola l√≠nea, forzar saltos antes de cada fila | N |
    m = m.replace(/\s*\|\s*(\d+)\s*\|/g, '\n| $1 |').trim();

    // si falta l√≠nea separadora, la agregamos tras la cabecera
    const lines = m.split('\n');
    if(lines.length>=2 && !/^(\s*\|[-\s:]+\|)+\s*$/.test(lines[1])){
      const cols = (lines[0].match(/\|/g) || []).length - 1;
      if(cols>0){ lines.splice(1,0,'|'+'---|'.repeat(cols)); m = lines.join('\n'); }
    }
    return m;
  }
  function renderTablesMarkdown(md){
    const el = tableOutput;
    if(!md || !md.trim()){ el.innerHTML=''; return; }
    const m = normalizeMarkdownTables(md);
    try{
      el.innerHTML = marked.parse(m);
    }catch{
      // Fallback simple
      const rows = m.split('\n').map(r=>r.replace(/^\||\|$/g,'').split('|').map(c=>c.trim()));
      const head = rows[0]||[]; const body = rows.slice(2);
      let html = '<table><thead><tr>'+head.map(h=>`<th>${h}</th>`).join('')+'</tr></thead><tbody>';
      body.forEach(r=>{ html+='<tr>'+r.map(c=>`<td>${c}</td>`).join('')+'</tr>'; });
      html+='</tbody></table>'; el.innerHTML=html;
    }
  }

  // ====== Llamada al backend ======
  async function ask(q){
    q = String(q||'').replace(/\*/g,'').trim();
    if(!q) return;
    document.getElementById('sendBtn').disabled = true;
    try{
      await typeInto(textOutput,'Procesando‚Ä¶');
      const resp = await fetch('/api/ask', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ question:q, sessionId })
      });
      if(!resp.ok) throw new Error('Error API');
      const data = await resp.json();

      const texto  = String(data.texto||data.text||'').replace(/\*/g,'');
      const tablas = String(data.tablas_markdown||'').replace(/\*/g,'');

      await typeInto(textOutput, texto);
      renderTablesMarkdown(tablas);
      await speak(texto);
    }catch(e){
      await typeInto(textOutput,'Ocurri√≥ un problema. Intenta otra vez.');
    }finally{
      document.getElementById('sendBtn').disabled = false;
    }
  }

  // ====== Botones ======
  document.getElementById('sendBtn').onclick = () => ask(questionEl.value);
  questionEl.addEventListener('keydown', e=>{ if((e.ctrlKey||e.metaKey)&&e.key==='Enter') ask(questionEl.value); });
  document.getElementById('clearBtn').onclick = () => { textOutput.innerHTML=''; tableOutput.innerHTML=''; };
  document.getElementById('muteBtn').onclick  = () => { ttsEnabled=!ttsEnabled; };
  document.getElementById('newSessionBtn').onclick = () => { sessionId='S-'+new Date().toISOString().replace(/[:.]/g,'-'); textOutput.innerHTML=''; tableOutput.innerHTML=''; questionEl.value=''; };

  // ====== Dictado ======
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  let rec=null, listening=false;
  function ensureRec(){ if(!SR) return null; const r = new SR(); r.lang='es-MX'; r.interimResults=true; r.continuous=false; return r; }
  document.getElementById('micBtn').onclick = ()=>{
    if(!rec) rec = ensureRec();
    if(!rec){ alert('Dictado no disponible en este navegador.'); return; }
    if(!listening){
      rec.start(); listening=true; document.getElementById('micBtn').classList.add('primary');
      rec.onresult = e => { const t = Array.from(e.results).map(r=>r[0].transcript).join(' '); questionEl.value = (questionEl.value+' '+t).trim(); };
      rec.onend = ()=>{ listening=false; document.getElementById('micBtn').classList.remove('primary'); };
      rec.onerror = ()=>{ listening=false; document.getElementById('micBtn').classList.remove('primary'); };
    }else{
      rec.stop(); listening=false; document.getElementById('micBtn').classList.remove('primary');
    }
  };

  // ====== Exportar ======
  document.getElementById('exportBtn').onclick = async ()=>{
    const type = document.getElementById('exportType').value;
    const container = document.createElement('div');
    container.innerHTML = `
      <h1>Sesi√≥n ${sessionId}</h1>
      <h2>Pregunta</h2><div class="mono">${(questionEl.value||'').replace(/</g,'&lt;')}</div>
      <h2>Respuesta</h2><div>${textOutput.innerHTML}</div>
      <h2>Tablas y Listas</h2><div>${tableOutput.innerHTML}</div>
    `;
    if(type==='pdf'){
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ unit:'pt', format:'a4' });
      const canvas = await html2canvas(container,{scale:2,windowWidth:1000});
      const img = canvas.toDataURL('image/png');
      const w = pdf.internal.pageSize.getWidth(); const p=16;
      const prop = pdf.getImageProperties(img); const ratio = Math.min((w-p*2)/prop.width,1);
      pdf.addImage(img,'PNG',p,p,prop.width*ratio,prop.height*ratio);
      pdf.save(`sesion-${sessionId}.pdf`);
    }else if(type==='xlsx'){
      const wb = XLSX.utils.book_new();
      const texto = textOutput.innerText||'';
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([[`Sesi√≥n ${sessionId}`],['Respuesta'],[texto]]), 'Texto');
      const tables = Array.from(tableOutput.querySelectorAll('table'));
      if(!tables.length){
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([['No hay tablas']]), 'Tablas');
      }else{
        tables.forEach((tbl,i)=>{
          const rows = Array.from(tbl.querySelectorAll('tr')).map(tr=>Array.from(tr.children).map(td=>td.innerText));
          XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rows), `Tabla_${i+1}`);
        });
      }
      XLSX.writeFile(wb, `sesion-${sessionId}.xlsx`);
    }else{
      const blob = new Blob([`<!doctype html><meta charset='utf-8'>${container.innerHTML}`],{type:'application/msword'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`sesion-${sessionId}.doc`; a.click(); URL.revokeObjectURL(a.href);
    }
  };
})();
</script>
</body>
</html>
