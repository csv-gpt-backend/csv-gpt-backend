<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV GPT</title>
    <style>
        :root {
            --color-primary: #007BFF;
            --color-secondary: #28a745;
            --color-warning: #ffc107;
            --color-danger: #dc3545;
            --color-light: #f8f9fa;
            --color-dark: #343a40;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: white;
            color: var(--color-dark);
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .fixed-top {
            position: fixed;
            top: 0;
            width: 100%;
            background-color: white;
            z-index: 1000;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            gap: 20px;
        }

        .header-content img, .header-content video {
            max-height: 150px;
            width: auto;
            border-radius: 10px;
        }

        .header-content video {
            max-width: 50%;
        }

        .controls-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            margin-top: 20px;
        }

        .controls-top {
            display: flex;
            align-items: center;
            width: 100%;
            max-width: 800px;
            gap: 10px;
            margin-bottom: 15px;
        }

        .controls-top input[type="text"] {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
        }

        .controls-bottom {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            width: 100%;
        }

        .controls-bottom button, .controls-bottom select {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }
        
        button.action-button {
            background-color: var(--color-primary);
            color: white;
        }

        button.action-button:hover {
            background-color: #0056b3;
        }

        #mic-btn {
            background-color: var(--color-secondary);
            color: white;
            padding: 12px 20px;
            font-size: 16px;
        }

        #mic-btn:hover {
            background-color: #1e7e34;
        }

        #new-session-btn {
            background-color: var(--color-warning);
        }

        #new-session-btn:hover {
            background-color: #d69900;
        }

        main {
            display: flex;
            flex-direction: column;
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
            margin-top: 250px; /* Adjusted to accommodate fixed header */
        }

        .content-section {
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 20px;
            background-color: var(--color-light);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            max-height: 40vh; /* Ajustado para scroll */
            overflow-y: auto; /* Permite el scroll */
        }

        #text-response-area {
            min-height: 200px;
        }

        #table-response-area {
            min-height: 200px;
        }

        #table-response-area table {
            width: 100%;
            border-collapse: collapse;
        }

        #table-response-area th, #table-response-area td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }

        #table-response-area th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>

    <div class="fixed-top">
        <div class="header-content">
            <img src="/public/left.png" alt="Left Image" id="left-img">
            <video id="background-video" src="https://xsmr71ubix2w6tve.public.blob.vercel-storage.com/OLIVIA%20IN%20CASUAL.mp4" muted loop></video>
            <img src="/public/right.png" alt="Right Image" id="right-img">
        </div>
        
        <div class="controls-area">
            <div class="controls-top">
                <input type="text" id="user-input" placeholder="Escribe tu pregunta o usa el micr√≥fono...">
                <button class="action-button" id="send-btn">Enviar</button>
                <button id="mic-btn">üéôÔ∏è</button>
            </div>
            <div class="controls-bottom">
                <select id="export-options">
                    <option value="">Exportar</option>
                    <option value="pdf">PDF</option>
                    <option value="xls">XLS</option>
                    <option value="doc">DOC</option>
                </select>
                <button class="action-button" id="mute-btn">üîá Silenciar Voz</button>
                <button class="action-button" id="clear-btn">Limpiar</button>
                <button id="new-session-btn">Nueva Sesi√≥n</button>
                <a href="historial.html" target="_blank" style="text-decoration: none;">
                    <button class="action-button">Ver Historial</button>
                </a>
            </div>
        </div>
    </div>
    
    <main>
        <div class="content-section" id="text-response-area">
            <h3>Respuesta</h3>
            <div id="text-output"></div>
        </div>
        <div class="content-section" id="table-response-area">
            <h3>Tablas y Listas</h3>
            <div id="table-output"></div>
        </div>
    </main>

    <!-- Modal para notificaciones -->
    <div id="modal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); padding:20px; background-color:#fff; border:1px solid #ccc; border-radius:8px; box-shadow:0 4px 8px rgba(0,0,0,0.2);">
        <p id="modal-message"></p>
        <button onclick="document.getElementById('modal').style.display='none'">Cerrar</button>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Variables globales
        let db, auth, userId;
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let chatHistory = [];

        // Inicializaci√≥n de Firebase
        if (Object.keys(firebaseConfig).length > 0) {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("Usuario autenticado con UID:", userId);
                } else {
                    const __initial_auth_token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    try {
                        if (__initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Error signing in:", error);
                    }
                }
            });
        } else {
            console.error("Firebase config not available. Session saving will not work.");
        }

        // DOM elements
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const micBtn = document.getElementById('mic-btn');
        const exportOptions = document.getElementById('export-options');
        const muteBtn = document.getElementById('mute-btn');
        const clearBtn = document.getElementById('clear-btn');
        const newSessionBtn = document.getElementById('new-session-btn');
        const video = document.getElementById('background-video');
        const textOutput = document.getElementById('text-output');
        const tableOutput = document.getElementById('table-output');

        let isMuted = false;
        let isRecording = false;

        // --- Funciones de la Aplicaci√≥n ---

        // Funci√≥n para mostrar notificaciones
        function showNotification(message) {
            const modal = document.getElementById('modal');
            const modalMessage = document.getElementById('modal-message');
            modalMessage.textContent = message;
            modal.style.display = 'block';
        }

        // Manejo del video
        function playVideo() {
            video.currentTime = 0;
            video.play();
        }

        function pauseVideo() {
            video.pause();
        }

        // Manejo de la voz (Texto a Voz)
        // La voz de mujer en espa√±ol ecuatoriano/mexicano se gestionar√° en el backend como solicitaste.
        // Aqu√≠ solo se simular√° la reproducci√≥n de voz.
        async function speakResponse(text) {
            // Simulamos la duraci√≥n de la voz
            const duration = text.length * 50; // 50ms por caracter
            playVideo();
            await new Promise(resolve => setTimeout(resolve, duration));
            pauseVideo();
        }

        // Manejo del micr√≥fono (Voz a Texto)
        if ('webkitSpeechRecognition' in window) {
            const recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'es-MX'; // Idioma espa√±ol
            recognition.interimResults = false;

            micBtn.addEventListener('click', () => {
                if (isRecording) {
                    recognition.stop();
                    isRecording = false;
                    micBtn.textContent = 'üéôÔ∏è';
                } else {
                    recognition.start();
                    isRecording = true;
                    micBtn.textContent = 'üî¥ Grabando...';
                    showNotification('Escuchando...');
                }
            });

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                userInput.value = transcript;
                isRecording = false;
                micBtn.textContent = 'üéôÔ∏è';
                showNotification('Grabaci√≥n finalizada.');
            };

            recognition.onerror = (event) => {
                console.error("Error de reconocimiento de voz:", event.error);
                showNotification('Error en el reconocimiento de voz. Por favor, intenta de nuevo.');
                isRecording = false;
                micBtn.textContent = 'üéôÔ∏è';
            };
        } else {
            micBtn.style.display = 'none';
            console.error("Reconocimiento de voz no soportado en este navegador.");
        }

        // Enviar pregunta
        sendBtn.addEventListener('click', async () => {
            const question = userInput.value.trim();
            if (question === '') {
                showNotification("Por favor, ingresa una pregunta.");
                return;
            }

            textOutput.innerHTML = "Analizando tu pregunta...";
            tableOutput.innerHTML = "";
            userInput.value = "";

            try {
                // Paso 1: Leer los archivos locales. En un entorno real, esto se har√≠a
                // a trav√©s de un backend. Aqu√≠ simulamos la lectura.
                const pdfFiles = ['emocionales.pdf', 'lexium.pdf', 'evaluaciones.pdf'];
                const csvFile = 'datos/decimo.csv';
                
                const formData = new FormData();
                formData.append('question', question);

                const filesToProcess = [...pdfFiles, csvFile];
                for (const filePath of filesToProcess) {
                    try {
                        const response = await fetch(filePath);
                        if (!response.ok) throw new Error(`Error al cargar el archivo: ${filePath}`);
                        const blob = await response.blob();
                        formData.append('files', blob, filePath.substring(filePath.lastIndexOf('/') + 1));
                    } catch (e) {
                        console.error(`Error procesando el archivo ${filePath}:`, e);
                        showNotification(`Error: No se pudo cargar el archivo ${filePath}.`);
                        return;
                    }
                }

                // Paso 2: Conexi√≥n con el backend del usuario
                const response = await fetch('https://csv-gpt-backend.vercel.app', {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    throw new Error(`Error del servidor: ${response.statusText}`);
                }

                const data = await response.json();
                
                // Asumiendo que el backend devuelve un objeto con 'text' y 'tables'
                const { text, tables } = data;

                // Mostrar la respuesta de texto
                textOutput.innerHTML = text;

                // Reproducir la respuesta de voz (simulaci√≥n) y controlar el video
                if (!isMuted) {
                    await speakResponse(text);
                }

                // Mostrar las tablas si existen
                if (tables && tables.length > 0) {
                    let tableHTML = '';
                    tables.forEach(table => {
                        tableHTML += `<table><thead><tr>`;
                        table.columns.forEach(col => {
                            tableHTML += `<th>${col}</th>`;
                        });
                        tableHTML += `</tr></thead><tbody>`;
                        table.data.forEach(row => {
                            tableHTML += `<tr>`;
                            row.forEach(cell => {
                                tableHTML += `<td>${cell}</td>`;
                            });
                            tableHTML += `</tr>`;
                        });
                        tableHTML += `</tbody></table>`;
                    });
                    tableOutput.innerHTML = tableHTML;
                } else {
                    tableOutput.innerHTML = "<p>No hay tablas o listas para mostrar.</p>";
                }

                // Guardar la sesi√≥n en la memoria de la p√°gina
                chatHistory.push({ question, text, tables });
                
            } catch (error) {
                console.error("Error al obtener la respuesta:", error);
                textOutput.innerHTML = "Ocurri√≥ un error. Por favor, intenta de nuevo.";
            }
        });

        // Bot√≥n para silenciar la voz
        muteBtn.addEventListener('click', () => {
            isMuted = !isMuted;
            muteBtn.textContent = isMuted ? 'üîä Habilitar Voz' : 'üîá Silenciar Voz';
        });

        // Bot√≥n para limpiar
        clearBtn.addEventListener('click', () => {
            userInput.value = '';
            textOutput.innerHTML = '';
            tableOutput.innerHTML = '';
        });

        // Bot√≥n de nueva sesi√≥n (borra memoria y guarda en Firestore)
        newSessionBtn.addEventListener('click', async () => {
            if (chatHistory.length > 0) {
                if (db && userId) {
                    try {
                        const sessionsRef = collection(db, `artifacts/${appId}/users/${userId}/sessions`);
                        await setDoc(doc(sessionsRef), {
                            timestamp: new Date(),
                            history: chatHistory
                        });
                        showNotification("Sesi√≥n guardada y reiniciada.");
                    } catch (e) {
                        console.error("Error al guardar la sesi√≥n:", e);
                        showNotification("Error al guardar la sesi√≥n. Intenta de nuevo.");
                    }
                }
            }
            chatHistory = [];
            userInput.value = '';
            textOutput.innerHTML = '';
            tableOutput.innerHTML = '';
            showNotification("Nueva sesi√≥n iniciada.");
        });

        // Funci√≥n para exportar (PDF, XLS, DOC)
        exportOptions.addEventListener('change', (event) => {
            const format = event.target.value;
            if (format) {
                // Aqu√≠ ir√≠a la l√≥gica de exportaci√≥n. Necesitar√≠as una biblioteca
                // como jspdf, SheetJS, o similar.
                // Como ejemplo, mostraremos una notificaci√≥n.
                showNotification(`La funci√≥n de exportar a ${format.toUpperCase()} est√° en desarrollo.`);
                exportOptions.value = ""; // Resetea el selector
            }
        });

    </script>
</body>
</html>
