<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MMCSV/PDF ‚á¢ GPT</title>
  <style>
    :root{
      --brand:#1f6feb;
      --bg:#f6f8fa;
      --text:#0b1021;
      --muted:#6b7280;
      --card:#ffffff;
      --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;
      color:var(--text);
      background:var(--bg);
    }

    /* Header con video sticky */
    .header-wrap{
      position: sticky;       /* üëà se queda pegado */
      top: 0;                 /* distancia desde arriba */
      z-index: 50;
      background: var(--bg);  /* color de fondo para que no ‚Äútrasluzca‚Äù */
      border-bottom: 1px solid var(--border);
    }
    .header{
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px 16px 10px;
      display: grid;
      grid-template-columns: 1fr min(800px,60vw) 1fr;
      gap: 16px;
      align-items: center;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .brand img{max-height:64px}
    .video-wrap{
      border-radius: 14px;
      overflow: hidden;
      background:#000;
      aspect-ratio: 16 / 6;
      display:flex;align-items:center;justify-content:center;
    }
    .video-wrap video{
      width:100%; height:100%;
      object-fit: cover;
    }
    .right-brand{display:flex;justify-content:flex-end}
    .right-brand img{max-height:64px}

    .main{
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    /* Caja de pregunta: 2 l√≠neas */
    .ask-card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:16px;
      margin:12px 0 10px;
      box-shadow:0 0 0 rgba(0,0,0,0);
    }
    .ask-row{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:12px;
      align-items:start;
    }
    textarea{
      width:100%;
      min-height: 56px;   /* üëà 2 l√≠neas aprox */
      max-height: 110px;  /* evita que crezca demasiado */
      padding:12px 14px;
      border:1px solid var(--border);
      border-radius:10px;
      resize:vertical;
      font-size:15px;
      line-height:1.4;
    }
    .toolbar{
      display:flex;flex-wrap:wrap;gap:10px;
      margin-top:10px
    }
    .btn{
      background:#fff;border:1px solid var(--border);
      padding:10px 14px;border-radius:10px;
      cursor:pointer;
      font-weight:600;color:var(--text)
    }
    .btn-primary{background:var(--brand);color:#fff;border-color:var(--brand)}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .panel{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:16px;margin:14px 0;
    }
    .panel h3{margin:0 0 10px 0}

    /* Tabla */
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{
      position: sticky; top: 0; z-index: 1;
      background: #fbfbfb;
      border-bottom: 1px solid var(--border);
    }
    th, td{
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      border-right:1px solid var(--border);
      text-align:left;
      font-size:14px;
    }
    th:first-child,td:first-child{border-left:1px solid var(--border)}
    tbody tr:nth-child(odd){background:#fafafa}
    .table-scroll{
      max-height: 58vh;    /* scroll vertical, sin mover el video (el video est√° sticky arriba) */
      overflow:auto;
      border:1px solid var(--border);
      border-radius: 10px;
    }
    .muted{color:var(--muted);font-size:13px}

    .export-row{display:flex;gap:10px;justify-content:center;margin-top:12px}
    .center{display:flex;justify-content:center;align-items:center}
  </style>
</head>
<body>

  <!-- HEADER con video sticky -->
  <div class="header-wrap">
    <div class="header">
      <div class="brand">
        <img src="./left.png" alt="Santillana" />
      </div>
      <div class="video-wrap">
        <!-- MUTE SIEMPRE: el audio de respuestas lo hace TTS -->
        <video id="agentVideo" src="https://xsmr71ubix2w6tve.public.blob.vercel-storage.com/OLIVIA%20IN%20CASUAL.mp4"
               autoplay muted playsinline preload="metadata" loop></video>
      </div>
      <div class="right-brand">
        <img src="./right.png" alt="Compartir" />
      </div>
    </div>
  </div>

  <div class="main">
    <!-- PREGUNTA -->
    <div class="ask-card">
      <div class="ask-row">
        <textarea id="question" placeholder="Escribe tu pregunta (ej. 'Lista todos los estudiantes con sus promedios')"></textarea>
        <button id="sendBtn" class="btn btn-primary">Enviar</button>
      </div>
      <div class="toolbar center">
        <button id="dictBtn" class="btn">üéôÔ∏è Dictado</button>
        <button id="muteBtn" class="btn">üîá Silenciar voz</button>
        <button id="clearBtn" class="btn">üßΩ Limpiar</button>
        <button id="newBtn" class="btn">üÜï Nueva sesi√≥n</button>
      </div>
      <!-- export centrado -->
      <div class="export-row">
        <button data-exp="pdf"  class="btn">PDF</button>
        <button data-exp="doc"  class="btn">Word</button>
        <button data-exp="csv"  class="btn">CSV</button>
      </div>
    </div>

    <!-- RESPUESTA -->
    <div class="panel" id="respPanel">
      <h3>Respuesta</h3>
      <div id="answer" class="muted">Escribe una pregunta y presiona Enviar.</div>
    </div>

    <!-- TABLAS -->
    <div class="panel">
      <h3>Tablas y Listas</h3>
      <div class="table-scroll" id="tableScroll">
        <table id="resultTable">
          <thead></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="muted" id="tableHint"></div>
    </div>
  </div>

  <script>
    const qEl   = document.getElementById('question');
    const aEl   = document.getElementById('answer');
    const send  = document.getElementById('sendBtn');
    const muteB = document.getElementById('muteBtn');
    const clearB= document.getElementById('clearBtn');
    const dictB = document.getElementById('dictBtn');
    const newB  = document.getElementById('newBtn');

    const thead = document.querySelector('#resultTable thead');
    const tbody = document.querySelector('#resultTable tbody');
    const hint  = document.getElementById('tableHint');

    // ---------- VIDEO CONTROL: se reproduce cuando hablamos; pausa al terminar
    const agentVideo = document.getElementById('agentVideo');
    function videoPlay(){ try{ agentVideo.currentTime = 0; agentVideo.play(); }catch{} }
    function videoPause(){ try{ agentVideo.pause(); }catch{} }

    // ---------- TTS: voz femenina es-MX (fijo volumen)
    let synth   = window.speechSynthesis;
    let voices  = [];
    let selectedVoice = null;
    let voiceReady = false;
    let speakingNow = false;

    function loadVoices(){
      voices = synth.getVoices();
      if(!voices.length) return;

      // 1) es-MX femenina
      selectedVoice =
        voices.find(v => v.lang?.toLowerCase()==='es-mx' && /female|mujer/i.test(v.name)) ||
      // 2) cualquier voz es-* femenina
        voices.find(v => v.lang?.toLowerCase().startsWith('es') && /female|mujer/i.test(v.name)) ||
      // 3) cualquier es-*
        voices.find(v => v.lang?.toLowerCase().startsWith('es')) ||
      // 4) fallback
        voices[0];

      voiceReady = true;
    }
    loadVoices();
    if(typeof speechSynthesis !== 'undefined'){
      speechSynthesis.onvoiceschanged = loadVoices;
    }

    let muted = false;
    muteB.addEventListener('click', () => {
      muted = !muted;
      muteB.textContent = muted ? 'üîà Activar voz' : 'üîá Silenciar voz';
      if(muted) { synth.cancel(); videoPause(); }
    });

    function speak(text){
      if(!text || muted) return;
      if(!voiceReady){ loadVoices(); }

      const utter = new SpeechSynthesisUtterance(text);
      utter.voice  = selectedVoice || null;
      utter.lang   = (selectedVoice?.lang || 'es-MX');
      utter.rate   = 1.0;
      utter.pitch  = 1.0;
      utter.volume = 1.0;

      utter.onstart = ()=>{ speakingNow = true; videoPlay(); };
      utter.onend   = ()=>{ speakingNow = false; videoPause(); };

      synth.cancel(); // corta cualquier cola previa
      synth.speak(utter);
    }

    // Lee respuesta + (opcional) algunas filas de tabla
    function speakAll(respText, tableData){
      // respuesta
      if(respText) speak(respText);

      // tabla (lee hasta 15 filas)
      if(!muted && tableData?.rows?.length){
        const cols = tableData.headers || [];
        const rows = tableData.rows.slice(0, 15); // ‚Üê ajusta si quieres m√°s
        // narra un resumen
        speak(`Ahora te leo la tabla. Columnas: ${cols.join(', ')}. Te leo las primeras ${rows.length} filas.`);
        for(let i=0;i<rows.length;i++){
          const n = i+1;
          // arma "Fila 1: Nombre: Juan, Asertividad: 70, Liderazgo: 65"
          const parts = [];
          cols.forEach((c,idx) => {
            const val = rows[i][idx] ?? '';
            if(val!=='' && val!=null) parts.push(`${c}: ${val}`);
          });
          speak(`Fila ${n}: ${parts.join(', ')}`);
        }
        speak('Fin de la tabla.');
      }
    }

    // ---------- render de tabla
    function renderTable(headers, rows){
      thead.innerHTML = '';
      tbody.innerHTML = '';
      hint.textContent = '';

      if(!headers?.length){ hint.textContent = 'Sin datos de tabla.'; return; }

      // encabezados numerados con #
      const trh = document.createElement('tr');
      const thNum = document.createElement('th'); thNum.textContent = '#';
      trh.appendChild(thNum);
      headers.forEach(h => {
        const th = document.createElement('th'); th.textContent = h;
        trh.appendChild(th);
      });
      thead.appendChild(trh);

      rows.forEach((r, idx) => {
        const tr = document.createElement('tr');
        const tdNum = document.createElement('td'); tdNum.textContent = String(idx+1);
        tr.appendChild(tdNum);
        r.forEach(val=>{
          const td = document.createElement('td');
          td.textContent = val ?? '';
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      hint.textContent = `Mostrando ${rows.length} filas.`;
    }

    // ---------- UX
    clearB.addEventListener('click', ()=>{
      qEl.value='';
      aEl.textContent='Escribe una pregunta y presiona Enviar.';
      thead.innerHTML = '';
      tbody.innerHTML = '';
      hint.textContent = '';
      synth.cancel(); videoPause();
    });

    newB.addEventListener('click', ()=>{
      clearB.click();
    });

    // Dictado sencillo (navegadores Chromium)
    dictB.addEventListener('click', ()=>{
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SR){ alert('Tu navegador no soporta dictado.'); return; }
      const rec = new SR(); rec.lang='es-MX'; rec.interimResults=false; rec.maxAlternatives=1;
      rec.onresult = e => {
        qEl.value = e.results[0][0].transcript;
      };
      rec.start();
    });

    // ---------- Env√≠o
    async function ask(){
      const question = qEl.value.trim();
      if(!question){ aEl.textContent='Por favor, escribe una pregunta.'; return; }

      send.disabled = true; aEl.textContent='Pensando...'; synth.cancel(); videoPlay();

      try{
        const res = await fetch('/api/ask', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ question })
        });
        const data = await res.json();

        // Respuesta
        aEl.textContent = data?.texto || 'Sin respuesta.';

        // Tabla (si llega)
        if(Array.isArray(data?.tabla?.headers)){
          renderTable(data.tabla.headers, data.tabla.rows || []);
        }else{
          renderTable([],[]);
        }

        // Voz
        speakAll(aEl.textContent, data?.tabla);

      }catch(err){
        console.error(err);
        aEl.textContent = 'Ocurri√≥ un problema procesando la consulta. Intenta nuevamente.';
      }finally{
        send.disabled = false;
      }
    }
    send.addEventListener('click', ask);
    qEl.addEventListener('keydown', e=>{
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); ask(); }
    });

    // ---------- Export (PDF/DOC/CSV) ‚Äî deja tu l√≥gica ya existente si prefieres
    document.querySelectorAll('[data-exp]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const type = btn.dataset.exp;
        const headers = Array.from(thead.querySelectorAll('th')).map(th => th.textContent).slice(1);
        const rows = Array.from(tbody.querySelectorAll('tr')).map(tr => Array.from(tr.children).slice(1).map(td=>td.textContent));

        if(!headers.length){ alert('No hay tabla que exportar.'); return; }

        if(type==='csv'){
          const csv = [ ['#',...headers].join(',') ]
            .concat(rows.map((r,i)=> [String(i+1),...r].map(x=> `"${String(x).replace(/"/g,'""')}"`).join(',')))
            .join('\r\n');
          const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href=url; a.download='tabla.csv'; a.click(); URL.revokeObjectURL(url);
        }else if(type==='doc'){
          const html = `
            <html><head><meta charset="utf-8"><title>Tabla</title></head>
            <body>
            <h2>Tabla exportada</h2>
            <table border="1" cellspacing="0" cellpadding="6">
              <thead><tr><th>#</th>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead>
              <tbody>
                ${rows.map((r,i)=>`<tr><td>${i+1}</td>${r.map(c=>`<td>${c}</td>`).join('')}</tr>`).join('')}
              </tbody>
            </table>
            </body></html>`;
          const blob = new Blob([html], {type:'application/msword'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href=url; a.download='tabla.doc'; a.click(); URL.revokeObjectURL(url);
        }else{ // pdf simple via ventana
          const html = `
            <html><head><meta charset="utf-8"><title>Tabla</title></head>
            <body>
            <h2>Tabla exportada</h2>
            <table border="1" cellspacing="0" cellpadding="6">
              <thead><tr><th>#</th>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead>
              <tbody>
                ${rows.map((r,i)=>`<tr><td>${i+1}</td>${r.map(c=>`<td>${c}</td>`).join('')}</tr>`).join('')}
              </tbody>
            </table>
            <script>window.print();</script>
            </body></html>`;
          const w = window.open('', '_blank');
          w.document.write(html);
          w.document.close();
        }
      });
    });

    // listo
    console.log('Listo');
  </script>
</body>
</html>
