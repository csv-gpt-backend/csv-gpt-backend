<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TdCSV/PDF â†” GPT (MX/EC)</title>
<link rel="icon" href="data:," />

<!-- LibrerÃ­as de apoyo -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  :root{
    --bg:#fff; --ink:#111827; --muted:#6b7280; --border:#e5e7eb;
    --accent:#2563eb; --amber:#f59e0b; --danger:#dc2626;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto}
  .page{display:grid;grid-template-rows:auto 1fr;min-height:100dvh}

  header{position:sticky;top:0;z-index:1000;background:#fff;border-bottom:1px solid var(--border);padding:10px 12px}

  /* Fila 25 / 50 / 25, con video 5% mÃ¡s angosto */
  .media-row{display:grid;grid-template-columns:1fr 1.9fr 1fr;gap:12px;align-items:center}
  .media-row img{width:100%;height:110px;object-fit:contain}
  .media-row video{width:100%;height:200px;object-fit:cover;border-radius:12px;border:none;background:#000}

  .controls{display:flex;flex-wrap:wrap;justify-content:center;gap:8px;margin-top:10px}
  textarea{width:min(1100px,98%);height:64px;resize:vertical;padding:10px 12px;border:1px solid var(--border);border-radius:12px}
  .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#fff;font-weight:600;cursor:pointer}
  .btn:hover{border-color:var(--accent);box-shadow:0 0 0 3px rgba(37,99,235,.12)}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .btn.yellow{background:var(--amber);border-color:var(--amber);color:#111}
  .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
  select{padding:10px 12px;border:1px solid var(--border);border-radius:12px;font-weight:600}

  main{display:grid;grid-template-rows:1fr 1fr;min-height:0}
  .panel{padding:12px;overflow:auto}
  .panel + .panel{border-top:1px solid var(--border)}
  .panel h2{margin:0 0 8px;color:var(--muted);font-size:15px;text-transform:uppercase;letter-spacing:.2px}
  #textPanel{max-height:38vh}
  #tablePanel{max-height:38vh}

  .result{max-width:1200px;margin:0 auto;line-height:1.55}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:13px;background:#fafafa;border:1px dashed var(--border);border-radius:10px;padding:8px}

  /* Tablas */
  #tableOutput table{width:100%;border-collapse:collapse;font-size:14px}
  #tableOutput th,#tableOutput td{border:1px solid var(--border);padding:6px 8px;text-align:left}
  #tableOutput th{background:#f8fafc}
</style>
</head>
<body>
<div class="page">
  <header>
    <div class="media-row">
      <img src="/left.png" alt="Left logo" crossorigin="anonymous">
      <video id="heroVideo"
             src="https://xsmr71ubix2w6tve.public.blob.vercel-storage.com/OLIVIA%20IN%20CASUAL.mp4"
             muted playsinline crossorigin="anonymous"></video>
      <img src="/right.png" alt="Right logo" crossorigin="anonymous">
    </div>

    <div class="controls" style="margin-top:10px">
      <textarea id="question" placeholder="Escribe tu pregunta o usa dictadoâ€¦"></textarea>
    </div>
    <div class="controls">
      <button id="sendBtn" class="btn primary">Enviar</button>
      <button id="micBtn" class="btn">ðŸŽ¤ Dictado</button>
      <select id="exportType">
        <option value="pdf">PDF</option>
        <option value="xlsx">XLSX</option>
        <option value="doc">DOC</option>
      </select>
      <button id="exportBtn" class="btn">Exportar</button>
      <button id="muteBtn" class="btn">ðŸ”‡ Silenciar voz</button>
      <button id="clearBtn" class="btn">ðŸ§¹ Limpiar</button>
      <button id="newSessionBtn" class="btn yellow">ðŸ†• Nueva sesiÃ³n</button>
    </div>
  </header>

  <main>
    <section class="panel" id="textPanel">
      <h2>Respuesta</h2>
      <div id="textOutput" class="result"></div>
    </section>
    <section class="panel" id="tablePanel">
      <h2>Tablas y Listas</h2>
      <div id="tableOutput" class="result"></div>
    </section>
  </main>
</div>

<script>
(() => {
  // ====== Estado
  let sessionId = 'S-' + new Date().toISOString().replace(/[:.]/g,'-');
  let ttsEnabled = true;
  let typing = false;

  const heroVideo = document.getElementById('heroVideo');
  const questionEl = document.getElementById('question');
  const textOutput = document.getElementById('textOutput');
  const tableOutput = document.getElementById('tableOutput');

  // ====== Utilidades
  async function typeInto(el, text, delay=6){
    typing = true; heroVideo.play().catch(()=>{});
    el.innerHTML = '';
    for(let i=0;i<text.length;i++){
      el.innerHTML += text[i]==='\n' ? '<br/>' : text[i];
      if(i%3===0) await new Promise(r=>setTimeout(r,delay));
    }
    typing = false; heroVideo.pause();
  }

  // ====== Voz femenina latina/MX
  function pickSpanishFemaleVoice() {
    const voices = speechSynthesis.getVoices() || [];
    const prefer = [
      'Microsoft Sabina Online (Natural) - Spanish (Mexico)',
      'Microsoft Dalia Online (Natural) - Spanish (Mexico)',
      'Paulina','Lucia','Conchita','Camila','Lupe'
    ];
    const byLang = (langs)=>voices.find(v=>langs.some(L=>(v.lang||'').toLowerCase().startsWith(L)));
    let v = byLang(['es-mx','es-419']); // MÃ©xico / LatAm
    if(!v) v = voices.find(x=>/^es-/i.test(x.lang||'') && /female|mujer|woman/i.test(x.name||''));
    if(!v){
      for(const n of prefer){ const c = voices.find(x=>(x.name||'').includes(n)); if(c) return c; }
      v = voices.find(x=>/^es-/i.test(x.lang||'')) || voices[0];
    }
    return v;
  }
  function speak(text){
    if(!ttsEnabled) return Promise.resolve();
    return new Promise(resolve=>{
      const u = new SpeechSynthesisUtterance(String(text||'').replace(/\*/g,''));
      const set = ()=>{
        const v = pickSpanishFemaleVoice();
        if(v) u.voice=v;
        u.lang=(v&&v.lang)||'es-MX'; u.rate=1; u.pitch=1;
        window.speechSynthesis.cancel(); // corta cualquier locuciÃ³n previa
        speechSynthesis.speak(u);
        heroVideo.play().catch(()=>{});
      };
      if(speechSynthesis.getVoices().length) set();
      else speechSynthesis.onvoiceschanged=set;
      u.onend=()=>{ if(!typing) heroVideo.pause(); resolve(); };
      u.onerror=()=>{ if(!typing) heroVideo.pause(); resolve(); };
    });
  }

  // ====== Normalizar + render de tablas
  function normalizeMarkdownTables(md){
    if(!md || !md.trim()) return '';
    let m = md.replace(/\r/g,'').trim();
    // mete saltos si todo vino pegado
    m = m.replace(/\s*\|\s*(\d+)\s*\|/g, '\n| $1 |').trim();
    // arregla guiones raros
    m = m.split('\n').map(l=>l.replace(/[â€”â€“-]{3,}/g,'---')).join('\n');
    // une filas partidas
    const L=m.split('\n'); const fixed=[];
    for(let i=0;i<L.length;i++){
      const line=L[i].trim();
      if(i>0 && (line.split('|').length<3) && fixed.length){
        fixed[fixed.length-1]=(fixed[fixed.length-1]+' '+line).trim();
      }else fixed.push(line);
    }
    // inserta separador si falta
    if(fixed.length>=2 && !/^(\s*\|[-\s:]+\|)+\s*$/.test(fixed[1])){
      const cols=(fixed[0].match(/\|/g)||[]).length-1;
      if(cols>0) fixed.splice(1,0,'|'+'---|'.repeat(cols));
    }
    return fixed.join('\n').replace(/\|\s*/g,'| ').replace(/\s*\|/g,' |');
  }
  function renderTablesMarkdown(md){
    if(!md || !md.trim()){ tableOutput.innerHTML=''; return; }
    const m = normalizeMarkdownTables(md);
    try{
      tableOutput.innerHTML = marked.parse(m);
    }catch{
      const rows = m.split('\n').map(r=>r.replace(/^\||\|$/g,'').split('|').map(c=>c.trim()));
      const head=rows[0]||[], body=rows.slice(2);
      let html = '<table><thead><tr>'+head.map(h=>`<th>${h}</th>`).join('')+'</tr></thead><tbody>';
      body.forEach(r=>{ html+='<tr>'+r.map(c=>`<td>${c}</td>`).join('')+'</tr>'; });
      html+='</tbody></table>'; tableOutput.innerHTML=html;
    }
  }

  // ====== Backend
  async function ask(q){
    q = String(q||'').replace(/\*/g,'').trim();
    if(!q) return;
    document.getElementById('sendBtn').disabled = true;
    try{
      await typeInto(textOutput,'Procesandoâ€¦');
      const resp = await fetch('/api/ask', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ question:q, sessionId })
      });
      if(!resp.ok) throw new Error('Error API');
      const data = await resp.json();
      const texto  = String(data.texto||data.text||'').replace(/\*/g,'');
      const tablas = String(data.tablas_markdown||'').replace(/\*/g,'');

      await typeInto(textOutput,texto);
      renderTablesMarkdown(tablas);
      await speak(texto);
    }catch(e){
      await typeInto(textOutput,'OcurriÃ³ un problema. Intenta otra vez.');
    }finally{
      document.getElementById('sendBtn').disabled=false;
    }
  }

  // ====== Botones
  document.getElementById('sendBtn').onclick = ()=>ask(questionEl.value);
  questionEl.addEventListener('keydown',e=>{ if((e.ctrlKey||e.metaKey)&&e.key==='Enter') ask(questionEl.value); });
  document.getElementById('clearBtn').onclick = ()=>{ textOutput.innerHTML=''; tableOutput.innerHTML=''; };
  document.getElementById('muteBtn').onclick  = ()=>{
    ttsEnabled = !ttsEnabled;
    if(!ttsEnabled) window.speechSynthesis.cancel();
    document.getElementById('muteBtn').textContent = ttsEnabled ? 'ðŸ”‡ Silenciar voz' : 'ðŸ”Š Activar voz';
  };
  document.getElementById('newSessionBtn').onclick = ()=>{
    sessionId='S-'+new Date().toISOString().replace(/[:.]/g,'-');
    textOutput.innerHTML=''; tableOutput.innerHTML=''; questionEl.value='';
  };

  // ====== Dictado SIN repeticiones
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  let rec=null, listening=false;
  function ensureRec(){
    if(!SR) return null;
    const r = new SR(); r.lang='es-MX'; r.interimResults=false; r.continuous=false; return r;
  }
  document.getElementById('micBtn').onclick = ()=>{
    if(!rec) rec = ensureRec();
    if(!rec){ alert('Dictado no disponible en este navegador.'); return; }
    if(!listening){
      listening=true; document.getElementById('micBtn').classList.add('primary');
      rec.start();
      rec.onresult = e=>{
        const res = e.results[e.results.length-1];
        if(res && res.isFinal){
          const t=res[0].transcript.trim();
          questionEl.value = (questionEl.value+' '+t).trim();
        }
      };
      rec.onend  = ()=>{ listening=false; document.getElementById('micBtn').classList.remove('primary'); };
      rec.onerror= ()=>{ listening=false; document.getElementById('micBtn').classList.remove('primary'); };
    }else{
      rec.stop(); listening=false; document.getElementById('micBtn').classList.remove('primary');
    }
  };

  // ====== Exportar (PDF con previsualizaciÃ³n)
  document.getElementById('exportBtn').onclick = async ()=>{
    const type = document.getElementById('exportType').value;
    const container = document.createElement('div');
    container.style.padding='16px';
    container.innerHTML = `
      <h1 style="margin:0 0 8px">SesiÃ³n ${sessionId}</h1>
      <h2>Pregunta</h2><div class="mono">${(questionEl.value||'').replace(/</g,'&lt;')}</div>
      <h2>Respuesta</h2><div>${textOutput.innerHTML}</div>
      <h2>Tablas y Listas</h2><div>${tableOutput.innerHTML}</div>
    `;
    if(type==='pdf'){
      const w=window.open('','_blank');
      if(!w){ alert('Bloqueado por el navegador. Habilita ventanas emergentes.'); return; }
      w.document.write(`<!doctype html><html><head><meta charset="utf-8">
        <title>PrevisualizaciÃ³n PDF</title>
        <style>
          body{font-family:system-ui,-apple-system,Segoe UI,Roboto;margin:24px;}
          table{border-collapse:collapse;width:100%}
          th,td{border:1px solid #ddd;padding:6px 8px}
          th{background:#f8fafc}
        </style>
        </head><body>${container.innerHTML}
        <script>window.onload=()=>window.print();<\/script>
      </body></html>`);
      w.document.close();
    }else if(type==='xlsx'){
      const wb=XLSX.utils.book_new();
      const texto=textOutput.innerText||'';
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([['Respuesta'],[texto]]), 'Texto');
      const tables=Array.from(tableOutput.querySelectorAll('table'));
      if(!tables.length){
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([['No hay tablas']]), 'Tablas');
      }else{
        tables.forEach((tbl,i)=>{
          const rows=Array.from(tbl.querySelectorAll('tr')).map(tr=>Array.from(tr.children).map(td=>td.innerText));
          XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rows), `Tabla_${i+1}`);
        });
      }
      XLSX.writeFile(wb, `sesion-${sessionId}.xlsx`);
    }else{
      const blob=new Blob([`<!doctype html><meta charset='utf-8'>${container.innerHTML}`],{type:'application/msword'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`sesion-${sessionId}.doc`; a.click(); URL.revokeObjectURL(a.href);
    }
  };
})();
</script>
</body>
</html>
