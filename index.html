<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>FAsistente ¬∑ CSV + TXT + PDF</title>
<style>
  :root {
    color-scheme: light dark;
    --headerH: 220px;       /* ‚Üê altura fija de la franja superior (video + logos) */
    --pad: 12px;
  }
  * { box-sizing: border-box; }
  html, body { height: 100%; }
  body { margin: 0; font-family: system-ui, Arial, sans-serif; background:#fff; color:#111; }

  /* ===== PARTE 1: IM√ÅGENES + VIDEO (FIJO) ===== */
  header {
    position: fixed;        /* ‚Üê NO se mueve con el scroll */
    top: 0; left: 0; right: 0;
    height: var(--headerH);
    background: #fff;
    z-index: 20;
    border-bottom: 1px solid #eee;
  }
  .topbar {
    height: 100%;
    display: grid;
    grid-template-columns: 1fr 2fr 1fr;   /* 25% - 50% - 25% */
    gap: 12px;
    align-items: center;
    padding: 0 var(--pad);
  }
  .topbar img { max-height: calc(var(--headerH) - 40px); width: auto; }
  .video-wrap { width: 100%; height: 100%; }
  .video-wrap video {
    width: 100%; height: 100%;
    object-fit: cover;      /* llena el alto fijo sin deformarse */
    border: 0;
  }

  /* El resto de la p√°gina empieza debajo de la franja fija */
  main {
    position: relative;
    padding-top: var(--headerH); /* deja espacio bajo el header fijo */
    height: 100vh;
  }

  /* Contenedor con dos paneles apilados, cada uno con su propio scroll */
  .panes {
    height: calc(100vh - var(--headerH));
    display: grid;
    grid-template-rows: 1fr 1fr;  /* Parte 2 y Parte 3 ocupan mitad y mitad */
  }
  .pane {
    overflow: auto;          /* cada parte se desplaza por separado */
    padding: 14px 16px;
    border-bottom: 1px solid #f2f2f2;
  }
  .pane:last-child { border-bottom: none; }
  h2 { margin: 0 0 10px 0; font-size: 18px; }

  /* Barra de controles (est√° en Parte 2) con sticky para que no ‚Äúescape‚Äù al leer respuestas largas */
  .controls {
    position: sticky; top: 0;
    z-index: 5;
    background: #fff;
    padding: 8px 0 10px;
    border-bottom: 1px solid #eee;
    margin-bottom: 12px;
  }
  .controls .row {
    display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; align-items: center;
  }
  textarea { width: min(1100px, 98%); height: 64px; padding: 10px; font-size: 15px; }
  button, select { padding: 10px 12px; font-size: 14px; cursor: pointer; }
  .mic { font-size: 18px; padding: 12px 16px; }
  .new { background: #ffd54f; border: 1px solid #f0b400; }
  .right { margin-left: auto; }
  .small { font-size: 12px; color: #666; }
  .muted { opacity: .5 }

  /* Tablas/listas (Parte 3) */
  table { width: 100%; border-collapse: collapse; margin: 12px 0; font-size: 14px; }
  th, td { border: 1px solid #ddd; padding: 6px 8px; text-align: left; vertical-align: top; }
  th { background: #f7f7f7; }
  ol { margin: 10px 0 16px 22px; }
  .list-card { margin: 10px 0; }
</style>
</head>
<body>

<!-- ====== PARTE 1 (FIJA): IM√ÅGENES + VIDEO ====== -->
<header>
  <div class="topbar">
    <img src="/left.png" alt="left">
    <div class="video-wrap">
      <video id="vid" src="https://xsmr71ubix2w6tve.public.blob.vercel-storage.com/OLIVIA%20IN%20CASUAL.mp4" muted playsinline></video>
    </div>
    <img src="/right.png" alt="right">
  </div>
</header>

<!-- ====== PARTES 2 y 3, cada una con su propio scroll ====== -->
<main>
  <div class="panes">

    <!-- ===== PARTE 2: PREGUNTA + BOTONES + RESPUESTA ===== -->
    <section id="pane2" class="pane">
      <div class="controls">
        <div class="row">
          <textarea id="q" placeholder="Escribe tu pregunta (o usa el micr√≥fono)‚Ä¶"></textarea>
        </div>
        <div class="row">
          <button id="send">Enviar</button>
          <button id="mic" class="mic">üé§ Dictar</button>
          <button id="mute">Silenciar voz</button>
          <button id="clear">Limpiar</button>
          <button id="new" class="new">Nueva sesi√≥n</button>
          <select id="exportKind">
            <option value="pdf">Exportar: PDF</option>
            <option value="xls">Exportar: XLS</option>
            <option value="doc">Exportar: DOC</option>
          </select>
          <button id="export">Exportar</button>
          <a class="right small" href="/historial.html">Historial ‚Üí</a>
        </div>
      </div>

      <h2>Respuesta (texto e informaci√≥n general)</h2>
      <div id="general"></div>
    </section>

    <!-- ===== PARTE 3: LISTAS NUMERADAS y TABLAS ===== -->
    <section id="pane3" class="pane">
      <h2>Listas numeradas y tablas</h2>
      <div id="lists"></div>
      <div id="tables"></div>
    </section>

  </div>
</main>

<script>
/* ========= TTS (voz) y STT (dictado) ========= */
let voices = []; speechSynthesis.onvoiceschanged = ()=>voices = speechSynthesis.getVoices(); voices = speechSynthesis.getVoices();
let muted = false; const vid = document.getElementById("vid");

function speak(text){
  if(!text) return;
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "es-MX";
  const v = voices.find(v=>/es|span/i.test(v.lang) && /female|mujer|Google|Microsoft/i.test(v.name)) || voices.find(v=>/es/i.test(v.lang));
  if (v) u.voice = v;
  u.volume = muted ? 0 : 1;
  u.onstart = ()=>{ try{ vid.play().catch(()=>{});}catch{} };
  u.onend   = ()=>{ try{ vid.pause(); }catch{} };
  speechSynthesis.speak(u);
}

let rec, recOn=false;
function toggleRec(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){ alert("Reconocimiento de voz no soportado en este navegador."); return; }
  if(!rec){ rec = new SR(); rec.lang="es-MX"; rec.continuous=false; rec.interimResults=false; }
  if(!recOn){
    rec.start(); recOn=true; mic.classList.add("muted");
    rec.onresult=(e)=>{ const t=e.results[0][0].transcript||""; q.value=(q.value+" "+t).trim(); recOn=false; mic.classList.remove("muted"); };
    rec.onend=   ()=>{ recOn=false; mic.classList.remove("muted"); };
  } else { rec.stop(); recOn=false; mic.classList.remove("muted"); }
}

/* ========= Sesiones ========= */
let sessionId="s-"+Date.now();
let session={ id:sessionId, startedAt:new Date().toISOString(), items:[] };
const storeKey="sesiones-v1";
function saveSession(){
  const all=JSON.parse(localStorage.getItem(storeKey)||"[]");
  const i=all.findIndex(s=>s.id===session.id);
  if(i>=0) all[i]=session; else all.unshift(session);
  localStorage.setItem(storeKey, JSON.stringify(all));
}

/* ========= UI ========= */
const q=document.getElementById("q");
const $gen=document.getElementById("general");
const $lists=document.getElementById("lists");
const $tables=document.getElementById("tables");
const mic=document.getElementById("mic");

document.getElementById("mute").onclick = ()=>{ muted=!muted; alert(muted?"Voz silenciada":"Voz activada"); };
document.getElementById("clear").onclick= ()=>{ $gen.innerHTML=""; $lists.innerHTML=""; $tables.innerHTML=""; q.value=""; };
document.getElementById("new").onclick  = ()=>{ sessionId="s-"+Date.now(); session={id:sessionId, startedAt:new Date().toISOString(), items:[]}; $gen.innerHTML=""; $lists.innerHTML=""; $tables.innerHTML=""; q.value=""; alert("Nueva sesi√≥n creada."); };
mic.onclick = toggleRec;

/* ========= Render listas/tablas ========= */
function renderLists(lists){
  $lists.innerHTML="";
  if(!lists || (Array.isArray(lists)&&lists.length===0)) return;

  if(Array.isArray(lists) && typeof lists[0]==="string"){
    const wrap=document.createElement("div"); wrap.className="list-card";
    const ol=document.createElement("ol");
    lists.forEach(item=>{ const li=document.createElement("li"); li.textContent=item; ol.appendChild(li); });
    wrap.appendChild(ol); $lists.appendChild(wrap);
    return;
  }
  (lists||[]).forEach(L=>{
    const wrap=document.createElement("div"); wrap.className="list-card";
    if(L.title){ const h=document.createElement("h3"); h.textContent=L.title; wrap.appendChild(h); }
    const ol=document.createElement("ol");
    (L.items||[]).forEach(item=>{ const li=document.createElement("li"); li.textContent=item; ol.appendChild(li); });
    wrap.appendChild(ol); $lists.appendChild(wrap);
  });
}
function renderTables(tables){
  $tables.innerHTML="";
  (tables||[]).forEach(t=>{
    const title=document.createElement("h3"); title.textContent=t.title||"Tabla";
    const table=document.createElement("table");
    const thead=document.createElement("thead");
    const trh=document.createElement("tr");
    (t.columns||[]).forEach(c=>{ const th=document.createElement("th"); th.textContent=c; trh.appendChild(th); });
    thead.appendChild(trh);
    const tbody=document.createElement("tbody");
    (t.rows||[]).forEach(r=>{
      const tr=document.createElement("tr");
      r.forEach(v=>{ const td=document.createElement("td"); td.textContent=v; tr.appendChild(td); });
      tbody.appendChild(tr);
    });
    table.appendChild(thead); table.appendChild(tbody);
    $tables.appendChild(title); $tables.appendChild(table);
  });
}

/* ========= Enviar ========= */
document.getElementById("send").onclick = async ()=>{
  const prompt=(q.value||"").replaceAll("*","");
  if(!prompt.trim()){ q.focus(); return; }

  $gen.innerHTML="<em>Analizando‚Ä¶</em>";
  $lists.innerHTML=""; $tables.innerHTML="";

  const r = await fetch("/api/answer", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ question: prompt })
  }).then(r=>r.json()).catch(e=>({ok:false,error:String(e)}));

  if(!r.ok){
    $gen.textContent = "Hubo un problema al analizar: " + (r.error || "desconocido");
    return;
  }

  const ans=r.answer||{};
  $gen.innerHTML=(ans.general||"").replace(/\n/g,"<br>");
  renderLists(ans.lists || ans.lista || []);
  renderTables(ans.tables || []);
  speak(ans.general||"");

  session.items.push({ at:new Date().toISOString(), q:prompt, a:ans });
  saveSession();
};

/* ========= Exportar ========= */
document.getElementById("export").onclick = ()=>{
  const kind=document.getElementById("exportKind").value;
  if(kind==="pdf"){
    window.print();
  } else if(kind==="doc"){
    const html=`<html><head><meta charset="UTF-8"></head><body>
      <h1>Respuesta</h1>${$gen.innerHTML}
      <h2>Listas</h2>${$lists.innerHTML}
      <h2>Tablas</h2>${$tables.innerHTML}
    </body></html>`;
    const blob=new Blob([html],{type:"application/msword"});
    const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="respuesta.doc"; a.click();
  } else if(kind==="xls"){
    const tables=$tables.querySelectorAll("table");
    let csv="";
    tables.forEach((tb,i)=>{
      const rows=tb.querySelectorAll("tr");
      rows.forEach(tr=>{
        const cells=[...tr.children].map(td=>`"${td.textContent.replace(/"/g,'""')}"`);
        csv += cells.join(",") + "\n";
      });
      if(i<tables.length-1) csv += "\n";
    });
    const blob=new Blob([csv],{type:"application/vnd.ms-excel"});
    const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="tablas.xls"; a.click();
  }
};
</script>
</body>
</html>
