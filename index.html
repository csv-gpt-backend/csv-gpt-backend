<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>HEADER Asistente ¬∑ CSV</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<style>
  :root{
    /* Alto de la PARTE 1 (video e im√°genes) */
    --headerH: 50vh;         /* puedes subir a 60‚Äì75vh si lo deseas */
    /* Colch√≥n extra para que NADA quede debajo del video */
    --gapBelowHeader: 72px;  /* antes 28px ‚Üí ahora 72px */
    --pad: 12px;
  }
  *{ box-sizing: border-box; }
  html,body{ height:100%; margin:0; font-family:Arial, system-ui, sans-serif; background:#fff; color:#111; }

  /* ===== PARTE 1: FIJA (no se mueve) ===== */
  header{
    position: fixed; top:0; left:0; right:0; height:var(--headerH);
    background:#fff; border-bottom:1px solid #eee; z-index:20;
  }
  #histLink{
    position:absolute; top:6px; right:10px; font-size:12px; color:#666; text-decoration:none;
    opacity:.55; text-shadow:0 1px 1px rgba(0,0,0,.06); transition: opacity .15s ease;
  }
  #histLink:hover{ opacity:.85; text-decoration:underline; }

  .topbar{
    position:relative; height:100%;
    display:grid;
    grid-template-columns: 1fr 2.6fr 1fr;
    gap:12px; align-items:center; padding:0 var(--pad);
  }

  /* Im√°genes laterales: CENTRADAS y reducidas */
  .topbar img{
    justify-self: center;          /* <- centrado horizontal en su columna */
    max-height: calc(var(--headerH) * 0.40);
    max-width: 130px;
    width:auto; object-fit:contain;
    opacity:.95;
  }

  .video-wrap{ width:100%; height:100%; display:flex; align-items:center; justify-content:center; }
  .video-box{ width:100%; height:100% !important; display:flex; align-items:center; justify-content:center; }
  .video-box video{ width:100%; height:100%; object-fit:contain !important; border:0; background:#fff; }

  /* ===== Debajo de la franja fija ===== */
  main{ padding-top: calc(var(--headerH) + var(--gapBelowHeader)); }
  #scrollWrap{ height: calc(100vh - (var(--headerH) + var(--gapBelowHeader))); overflow:auto; display:block; }

  /* RESPUESTAS / controles */
  #pane{ padding:14px 16px; }
  .controls{ margin-bottom:10px; }
  .controls .row{
    display:flex; flex-wrap:wrap; gap:8px; justify-content:center !important; align-items:center; width:100%;
  }

  /* Caja de texto: 2 l√≠neas aprox */
  textarea{
    width:min(1100px,98%);
    height: 52px;             /* ~2 l√≠neas */
    line-height: 1.3;
    padding:10px; font-size:15px;
    border:1px solid #e6e6e6; border-radius:8px; background:#fff; outline:none;
    resize: vertical; max-height: 90px;
  }

  button, select{
    padding:10px 12px; font-size:14px; cursor:pointer; border:none; outline:none; border-radius:8px; background:#f3f3f3; color:#111;
  }
  button:hover, select:hover{ background:#ececec; }
  .toggle{ background:#ffd54f; }
  .replay{ background:#e1bee7; }
  .mic{ font-size:18px; padding:12px 16px; }
  .new{ background:#ffe082; }
  h2{ margin:8px 0 10px 0; font-size:18px; font-weight:normal; }
  .muted{ opacity:.5; }
  .status{ margin:6px 0 0; text-align:center; font-size:12px; color:#666; min-height:18px; }
  .badge{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; margin-left:6px; }
  .gpt{ background:#f0e6ff; color:#402060; }
  .note{ font-size:12px; color:#777; margin-top:6px; }

  table{ width:100%; border-collapse:collapse; margin:12px 0; font-size:14px; table-layout:auto; }
  th,td{ border:1px solid #e5e5e5; padding:6px 8px; text-align:left; vertical-align:top; }
  th{ background:#fafafa; }
  ol{ margin:10px 0 16px 22px; }

  .legend{ margin-top:6px; font-size:12px; color:#666; text-align:center; }
  .legend code{ background:#f7f7f7; padding:0 4px; border-radius:4px; }

  @media (max-width: 900px){
    .topbar{ grid-template-columns: .9fr 2.8fr .9fr; }
    .topbar img{ max-width: 95px; max-height: calc(var(--headerH) * 0.34); }
  }

  @media print{
    @page { size: A4; margin:12mm; }
    table{ page-break-inside: avoid; width:100%; }
    h1,h2,h3,h4{ page-break-after: avoid; }
  }
</style>
</head>
<body>

<header>
  <div class="topbar">
    <a id="histLink" href="/historial.html" title="Ver historial de sesiones">Historial</a>
    <img src="/left.png" alt="left">
    <div class="video-wrap">
      <div class="video-box">
        <video id="vid" src="https://xsmr71ubix2w6tve.public.blob.vercel-storage.com/OLIVIA%20IN%20CASUAL.mp4" muted playsinline></video>
      </div>
    </div>
    <img src="/right.png" alt="right">
  </div>
</header>

<main>
  <div id="scrollWrap">
    <section id="pane">
      <div class="controls">
        <div class="row">
          <textarea id="q" placeholder="Escribe tu pregunta (o usa el micr√≥fono)‚Ä¶"></textarea>
        </div>
        <div class="row">
          <button id="send" title="Enviar la pregunta y analizar">Enviar</button>
          <button id="mic" class="mic" title="Dictar por voz (es-MX/es-ES)">üé§ Dictar</button>
          <button id="toggleVV" class="toggle" title="Pausar/Reanudar voz y video">‚èØ Voz/Video</button>
          <button id="replay" class="replay" title="Volver a hablar toda la respuesta (texto + tablas + listas)">Reproducir voz</button>
          <button id="clear" title="Limpia texto y tablas y DETIENE voz/video">Limpiar</button>
          <button id="new" class="new" title="Crea una nueva sesi√≥n, borra contexto y DETIENE voz/video">Nueva sesi√≥n</button>
          <select id="exportKind" title="Exporta inmediatamente al formato elegido">
            <option value="">Exportar‚Ä¶</option>
            <option value="pdf">PDF</option>
            <option value="xls">XLS</option>
            <option value="doc">DOC</option>
          </select>
        </div>
        <div class="legend">
          <strong>Ayuda:</strong>
          <code>Enviar</code> analiza; <code>üé§ Dictar</code> voz‚Üítexto;
          <code>‚èØ Voz/Video</code> pausa/contin√∫a locuci√≥n y video;
          <code>Reproducir voz</code> vuelve a leer todo;
          <code>Limpiar</code> borra y detiene voz/video;
          <code>Nueva sesi√≥n</code> reinicia y detiene voz/video; <code>Exportar‚Ä¶</code> descarga.
        </div>
        <div id="status" class="status"></div>
        <div id="note" class="note"></div>
      </div>

      <h2>Respuesta (texto, listas y tablas)</h2>
      <div id="general"></div>
      <div id="lists"></div>
      <div id="tables"></div>
    </section>
  </div>
</main>

<script>
/* ========= Warmup ========= */
window.addEventListener("load", ()=>{
  fetch("/api/answer?flush=1&q=__warmup").catch(()=>{});
});

/* ========= Util: esperar voces del sistema ========= */
function ensureVoicesReady(timeoutMs=2000){
  return new Promise(resolve=>{
    const start=Date.now();
    const tick=()=>{
      const vs=speechSynthesis.getVoices();
      if(vs && vs.length){ resolve(vs); return; }
      if(Date.now()-start>timeoutMs){ resolve(vs||[]); return; }
      setTimeout(tick, 100);
    };
    tick();
  });
}

/* ========= Voz femenina fija ========= */
const FEMALE_PRIORITY=[
  "Microsoft Sabina Online (Natural) - Spanish (Mexico)","Microsoft Dalia Online (Natural) - Spanish (Mexico)",
  "Microsoft Helena Online (Natural) - Spanish (Spain)","Microsoft Camila Online (Natural) - Spanish (Colombia)",
  "Microsoft Lorena Online (Natural) - Spanish (Mexico)","Google espa√±ol de Estados Unidos","Google espa√±ol",
  "Sabina","Dalia","Helena","Camila","Ana","Lucia","Isabel"
];
const VOICE_KEY="voz-femenina-preferida";
function pickFemaleVoice(){
  const all=speechSynthesis.getVoices();
  const saved=localStorage.getItem(VOICE_KEY);
  if(saved){ const v=all.find(x=>x.name===saved); if(v) return v; localStorage.removeItem(VOICE_KEY); }
  for(const n of FEMALE_PRIORITY){ const v=all.find(x=>x.name===n); if(v){ localStorage.setItem(VOICE_KEY,v.name); return v; } }
  const v=all.find(x=>/es/i.test(x.lang)); if(v){ localStorage.setItem(VOICE_KEY,v.name); return v; }
  return null;
}
speechSynthesis.onvoiceschanged=()=>{ pickFemaleVoice(); };

const vid=document.getElementById("vid");
let speaking=false, paused=false;
let lastAnswer=null;

/* ========= Convertir tablas/listas a texto (desde objeto o DOM) ========= */
function tablesObjToText(tables){
  if(!tables?.length) return "";
  let out="";
  tables.forEach(t=>{
    out+=` Tabla: ${(t.title||"Tabla")}. `;
    const cols=t.columns?.length?t.columns:[];
    if(cols.length) out+=` Columnas: ${cols.join(", ")}. `;
    (t.rows||[]).forEach((row,i)=>{
      const arr=Array.isArray(row)?row:[row];
      out+=` Fila ${i+1}: ${arr.join(", ")}.`;
    });
  });
  return out.trim();
}
function listsObjToText(lists){
  if(!lists?.length) return "";
  let out="";
  lists.forEach(L=>{
    if(L.title) out+=` Lista: ${L.title}. `;
    (L.items||[]).forEach((it,i)=> out+=` √çtem ${i+1}: ${it}.`);
  });
  return out.trim();
}
function tablesDOMToText(){
  const tbls=document.querySelectorAll("#tables table");
  let out="";
  tbls.forEach((table,ti)=>{
    const titleEl=table.previousElementSibling;
    const title=titleEl && titleEl.tagName.startsWith("H") ? titleEl.textContent.trim() : `Tabla ${ti+1}`;
    out+=` Tabla: ${title}. `;
    const headers=[...table.querySelectorAll("thead th")].map(th=>th.textContent.trim());
    if(headers.length) out+=` Columnas: ${headers.join(", ")}. `;
    const rows=[...table.querySelectorAll("tbody tr")];
    rows.forEach((tr,i)=>{
      const cells=[...tr.querySelectorAll("td")].map(td=>td.textContent.trim());
      out+=` Fila ${i+1}: ${cells.join(", ")}.`;
    });
  });
  return out.trim();
}
function listsDOMToText(){
  const lists=[...document.querySelectorAll("#lists ol")];
  let out="";
  lists.forEach((ol,li)=>{
    const tEl=ol.previousElementSibling;
    const title=tEl && tEl.tagName.startsWith("H") ? tEl.textContent.trim() : `Lista ${li+1}`;
    out+=` Lista: ${title}. `;
    const items=[...ol.querySelectorAll("li")].map((li,i)=>`√çtem ${i+1}: ${li.textContent.trim()}.`).join(" ");
    out+=items;
  });
  return out.trim();
}

/* ========= Detener TODO (voz + video) ========= */
function stopAllSpeechAndVideo(){
  try{ speechSynthesis.cancel(); }catch{}
  try{ vid.loop=false; vid.pause(); }catch{}
  speaking=false; paused=false;
}

/* ========= Hablar toda la respuesta ========= */
async function speakFull(ans){
  await ensureVoicesReady();
  const v=pickFemaleVoice();

  if(paused && speaking){
    try{ speechSynthesis.resume(); vid.play().catch(()=>{}); }catch{}
    paused=false; return;
  }
  stopAllSpeechAndVideo();

  const general=ans?.general || document.getElementById("general").innerText || "";
  const t1=tablesObjToText(ans?.tables||[]); const l1=listsObjToText(ans?.lists||[]);
  const t2=t1 || tablesDOMToText(); const l2=l1 || listsDOMToText();
  const text=[general, l2, t2].filter(Boolean).join(" ").trim();
  if(!text) return;

  const u=new SpeechSynthesisUtterance(text);
  u.lang=v?.lang||"es-MX"; if(v) u.voice=v;
  u.rate=1; u.pitch=1; u.volume=1;

  u.onstart=()=>{ speaking=true; try{ vid.currentTime=0; vid.loop=true; vid.play().catch(()=>{});}catch{} };
  u.onend=()=>{ speaking=false; paused=false; try{ vid.loop=false; vid.pause(); }catch{} };

  speechSynthesis.speak(u);
}

/* Bot√≥n ‚èØ Voz/Video */
document.getElementById("toggleVV").onclick=()=>{
  if(!speaking){
    if(lastAnswer){ speakFull(lastAnswer); }
    return;
  }
  if(!paused){
    try{ speechSynthesis.pause(); }catch{}
    try{ vid.pause(); }catch{}
    paused=true;
  }else{
    try{ speechSynthesis.resume(); }catch{}
    try{ vid.play().catch(()=>{}); }catch{}
    paused=false;
  }
};

/* Reproducir nuevamente toda la respuesta */
document.getElementById("replay").onclick=()=>{
  if(lastAnswer){ speakFull(lastAnswer); }
};

/* ========= Dictado ========= */
const q=document.getElementById("q");
let rec,recOn=false;
document.getElementById("mic").onclick=()=>{
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){ alert("Reconocimiento de voz no soportado."); return; }
  if(!rec){ rec=new SR(); rec.lang="es-MX"; rec.continuous=false; rec.interimResults=false; }
  if(!recOn){
    rec.start(); recOn=true; mic.classList.add("muted");
    rec.onresult=e=>{ const t=e.results[0][0].transcript||""; q.value=(q.value+" "+t).trim(); recOn=false; mic.classList.remove("muted"); };
    rec.onend=()=>{ recOn=false; mic.classList.remove("muted"); };
  } else { rec.stop(); recOn=false; mic.classList.remove("muted"); }
};

/* ========= Sesi√≥n local ========= */
const $gen=document.getElementById("general");
const $lists=document.getElementById("lists");
const $tables=document.getElementById("tables");
const $status=document.getElementById("status");
const $note=document.getElementById("note");

let sessionId="s-"+Date.now();
let session={ id:sessionId, startedAt:new Date().toISOString(), items:[] };
const storeKey="sesiones-v1";
function loadAllSessions(){ try{ return JSON.parse(localStorage.getItem(storeKey)||"[]"); }catch{ return []; } }
function saveSession(){ const all=loadAllSessions(); const i=all.findIndex(s=>s.id===session.id); if(i>=0) all[i]=session; else all.unshift(session); localStorage.setItem(storeKey, JSON.stringify(all)); }

/* ========= Render ========= */
function renderLists(lists){ $lists.innerHTML=""; if(!lists?.length) return;
  lists.forEach(L=>{ const wrap=document.createElement("div");
    if(L.title){ const h=document.createElement("h3"); h.textContent=L.title; wrap.appendChild(h); }
    const ol=document.createElement("ol");
    (L.items||[]).forEach(it=>{ const li=document.createElement("li"); li.textContent=it; ol.appendChild(li); });
    wrap.appendChild(ol); $lists.appendChild(wrap); });
}
function renderTables(tables){ $tables.innerHTML=""; (tables||[]).forEach(t=>{
  const title=document.createElement("h3"); title.textContent=t.title||"Tabla";
  const table=document.createElement("table"); const thead=document.createElement("thead"); const trh=document.createElement("tr");
  const cols=t.columns?.length?["#",...t.columns]:["#"]; cols.forEach(c=>{ const th=document.createElement("th"); th.textContent=c; trh.appendChild(th); });
  thead.appendChild(trh); const tbody=document.createElement("tbody");
  (t.rows||[]).forEach((r,idx)=>{ const tr=document.createElement("tr"); const tdIdx=document.createElement("td"); tdIdx.textContent=String(idx+1); tr.appendChild(tdIdx);
    (Array.isArray(r)?r:[r]).forEach(v=>{ const td=document.createElement("td"); td.textContent=v; tr.appendChild(td); }); tbody.appendChild(tr); });
  table.appendChild(thead); table.appendChild(tbody); $tables.appendChild(title); $tables.appendChild(table); });
}

/* ========= API ========= */
async function callAnswerAPI(prompt){
  try{
    const res=await fetch("/api/answer",{ method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ question: prompt }) });
    if(!res.ok) throw new Error(`POST /api/answer -> ${res.status}`);
    return await res.json();
  }catch(err){
    const url="/api/answer?q="+encodeURIComponent(prompt);
    const res2=await fetch(url);
    if(!res2.ok) throw new Error(`GET /api/answer -> ${res2.status}`);
    return await res2.json();
  }
}

/* ========= Enviar ========= */
document.getElementById("send").onclick=async()=>{
  const prompt=(q.value||"").replaceAll("*","");
  if(!prompt.trim()){ q.focus(); return; }

  stopAllSpeechAndVideo();

  document.querySelectorAll("button,select,textarea").forEach(el=>{ el.disabled=true; el.style.opacity=0.7; });
  $status.innerHTML=`Procesando‚Ä¶ <span class="badge gpt">v-hotfix-9</span>`;
  $note.textContent=""; $gen.innerHTML="<em>Analizando‚Ä¶</em>"; $lists.innerHTML=""; $tables.innerHTML="";
  const t0=performance.now();

  let r;
  try{ r=await callAnswerAPI(prompt); }
  catch(e){ $gen.textContent="Hubo un problema al analizar: "+(e.message||"desconocido"); $status.textContent=""; console.error("API error:",e);
    document.querySelectorAll("button,select,textarea").forEach(el=>{ el.disabled=false; el.style.opacity=1; }); return; }

  if(!r?.ok){ $gen.textContent="Hubo un problema al analizar: "+(r?.error||"desconocido"); $status.textContent="";
    document.querySelectorAll("button,select,textarea").forEach(el=>{ el.disabled=false; el.style.opacity=1; }); return; }

  const ans=r.answer||{};
  lastAnswer=ans;

  $gen.innerHTML=(ans.general||"").replace(/\n/g,"<br>");
  renderLists(ans.lists||[]);
  renderTables(ans.tables||[]);

  const ms=Math.max(1,Math.round(performance.now()-t0));
  $status.innerHTML=`Listo en ${ms/1000}s <span class="badge gpt">v-hotfix-9</span>`;

  speakFull(ans);

  session.items.push({ at:new Date().toISOString(), q:prompt, a:ans, meta:r.source||{} });
  saveSession();

  document.querySelectorAll("button,select,textarea").forEach(el=>{ el.disabled=false; el.style.opacity=1; });
};

/* ========= Limpiar / nueva sesi√≥n ========= */
document.getElementById("clear").onclick=()=>{
  stopAllSpeechAndVideo();
  $gen.innerHTML=""; $lists.innerHTML=""; $tables.innerHTML="";
  q.value=""; $note.textContent="";
  $status.innerHTML=`Listo <span class="badge gpt">v-hotfix-9</span>`;
};

document.getElementById("new").onclick=()=>{
  stopAllSpeechAndVideo();
  sessionId="s-"+Date.now(); session={id:sessionId, startedAt:new Date().toISOString(), items:[]};
  $gen.innerHTML=""; $lists.innerHTML=""; $tables.innerHTML="";
  q.value=""; $note.textContent="";
  alert("Nueva sesi√≥n creada.");
};

/* ========= Exportaci√≥n directa ========= */
const vidEl=document.getElementById("vid");
function sessionToHTML(sess){
  const headerThumbs=`<div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
    <img src="/left.png" alt="left" style="height:40px"/>
    <video src="${vidEl.currentSrc||vidEl.src}" width="110" muted></video>
    <img src="/right.png" alt="right" style="height:40px"/></div>`;
  let html=`<h1>Sesi√≥n ${sess.id}</h1><p>Iniciada: ${new Date(sess.startedAt).toLocaleString()}</p>${headerThumbs}`;
  for(const it of (sess.items||[]).slice().reverse()){
    html+=`<hr><h2 style="font-weight:normal;">Pregunta</h2><p>${(it.q||"").replace(/\n/g,"<br>")}</p>`;
    const a=it.a||{};
    html+=`<h2 style="font-weight:normal;">Respuesta (texto, listas y tablas)</h2><div>${(a.general||"").replace(/\n/g,"<br>")}</div>`;
    if(a.lists?.length){ html+=`<h3 style="font-weight:normal;">Listas</h3>`; a.lists.forEach(L=>{ html+=`<h4>${L.title||" "}</h4><ol>`+(L.items||[]).map(x=>`<li>${x}</li>`).join("")+`</ol>`; }); }
    if(a.tables?.length){
      html+=`<h3 style="font-weight:normal;">Tablas</h3>`;
      a.tables.forEach(t=>{
        const cols=["#", ...(t.columns||[])];
        html+=`<h4>${t.title||"Tabla"}</h4>
        <table border="1" cellspacing="0" cellpadding="4" style="border-collapse:collapse;width:100%">
          <thead><tr>${cols.map(c=>`<th>${c}</th>`).join("")}</tr></thead>
          <tbody>${(t.rows||[]).map((row,idx)=>{ const arr=Array.isArray(row)?row:[row]; return `<tr><td>${idx+1}</td>${arr.map(v=>`<td>${String(v)}</td>`).join("")}</tr>`; }).join("")}</tbody>
        </table>`;
      });
    }
  }
  return `<!doctype html><html><head><meta charset="utf-8"><title>Exportaci√≥n Sesi√≥n</title>
  <style>@page{size:A4;margin:12mm;} body{font-family:Arial,sans-serif;color:#111;}
  table{width:100%;border-collapse:collapse;margin:10px 0;table-layout:auto;}
  th,td{border:1px solid #ccc;padding:6px 8px;} th{background:#f5f5f5;}
  h1,h2,h3,h4{page-break-after: avoid;} tr{page-break-inside: avoid;}</style></head><body>${html}</body></html>`;
}
function exportNow(kind){
  if(!kind) return;
  const fullHTML=sessionToHTML(session);
  if(kind==="pdf"){ const w=window.open("","_blank"); w.document.write(fullHTML); w.document.close(); w.focus(); w.print(); }
  else if(kind==="doc"){ const blob=new Blob([fullHTML],{type:"application/msword"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=`sesion-${session.id}.doc`; a.click(); }
  else if(kind==="xls"){
    let csv=""; (session.items||[]).forEach(it=>{ const a=it.a||{}; (a.tables||[]).forEach(t=>{ csv+=(t.title||"Tabla")+"\n"; const header=["#", ...(t.columns||[])]; csv+=header.map(h=>`"${String(h).replace(/"/g,'""')}"`).join(",")+"\n"; (t.rows||[]).forEach((row,idx)=>{ const arr=Array.isArray(row)?row:[row]; const line=[String(idx+1), ...arr.map(v=>String(v))]; csv+=line.map(x=>`"${x.replace(/"/g,'""')}"`).join(",")+"\n"; }); csv+="\n"; }); });
    const blob=new Blob([csv],{type:"application/vnd.ms-excel"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=`sesion-${session.id}.xls`; a.click();
  }
  document.getElementById("exportKind").value="";
}
document.getElementById("exportKind").addEventListener("change", (e)=> exportNow(e.target.value));
</script>
</body>
</html>
